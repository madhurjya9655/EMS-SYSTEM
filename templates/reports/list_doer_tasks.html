{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Doer Tasks Report{% endblock %}

{% block content %}
  <div class="page-header">
    <h1 class="page-title">Doer Tasks Report</h1>
  </div>

  <!-- FILTER CARD -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" href="#filterPanel" role="button" aria-expanded="true">
      <span>FILTER</span>
      <i class="fas fa-minus"></i>
    </div>
    <div id="filterPanel" class="collapse show">
      <div class="card-body">
        <form method="get" class="row g-3">
          <div class="col-md-3">
            {{ form.doer.label_tag }}
            {{ form.doer|add_class:"form-select" }}
          </div>
          <div class="col-md-3">
            {{ form.department.label_tag }}
            {{ form.department|add_class:"form-select" }}
          </div>
          <div class="col-md-3">
            {{ form.date_from.label_tag }}
            {{ form.date_from|add_class:"form-control" }}
          </div>
          <div class="col-md-3">
            {{ form.date_to.label_tag }}
            {{ form.date_to|add_class:"form-control" }}
          </div>
          <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary">FILTER</button>
            <a href="{% url 'reports:doer_tasks' %}" class="btn btn-warning">RESET FILTER</a>
            <button type="submit" name="export" value="csv" class="btn btn-success">DOWNLOAD CSV</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- BULK DELETE FORM WRAPS THE TABLE -->
  <form id="bulkForm" method="post" novalidate>
    {% csrf_token %}
    <input type="hidden" name="action" id="bulkAction" value="">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <label class="form-check m-0">
            <input class="form-check-input" type="checkbox" id="selectAll">
            <span class="form-check-label">Select All</span>
          </label>
        </div>
        <div>
          <button type="button" class="btn btn-danger" id="bulkDeleteBtn">
            <i class="fas fa-trash-alt"></i> Bulk Delete
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th style="width:40px;"></th>
              <th>Doer</th>
              <th>Task Name</th>
              <th>Task Type</th>
              <th>Assigned By</th>
              <th>Planned Date</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
            <tr>
              <td>
                <!-- name="sel" so Django sees request.POST.getlist("sel") -->
                <input type="checkbox" class="row-check" name="sel" value="{{ item.id }}">
              </td>
              <td>{{ item.assign_to.get_full_name|default:item.assign_to.username }}</td>
              <td>{{ item.task_name }}</td>
              <td>
                {% if item.mode %}
                  <span class="badge bg-info">Checklist</span>
                {% else %}
                  <span class="badge bg-secondary">One-time</span>
                {% endif %}
              </td>
              <td>{{ item.assign_by.get_full_name|default:item.assign_by.username }}</td>
              <td>{{ item.planned_date|date:"Y-m-d H:i" }}</td>
              <td>
                <span class="badge bg-{% if item.status == 'Pending' %}warning{% elif item.status == 'Completed' %}success{% else %}primary{% endif %}">
                  {{ item.status }}
                </span>
              </td>
              <td class="text-nowrap">
                <button type="button"
                        class="btn btn-sm btn-outline-info"
                        data-bs-toggle="modal"
                        data-bs-target="#doerTaskDetailsModal{{ item.id }}"
                        title="View Details">
                  <i class="fas fa-eye"></i>
                </button>

                <!-- no inline JS; use data-pk and bind in script -->
                <button type="button"
                        class="btn btn-sm btn-outline-danger ms-1 delete-one"
                        data-pk="{{ item.id }}"
                        title="Delete">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center text-muted">No tasks found for these criteria.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </form>

  <!-- Hidden single-delete form -->
  <form id="singleDeleteForm" method="post" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="action" value="delete_one">
    <input type="hidden" name="pk" id="singleDeletePk">
  </form>

  <!-- Details Modals (trimmed) -->
  {% for item in items %}
  <div class="modal fade" id="doerTaskDetailsModal{{ item.id }}" tabindex="-1" aria-labelledby="doerTaskDetailsModalLabel{{ item.id }}" aria-hidden="true">
      <div class="modal-dialog modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="doerTaskDetailsModalLabel{{ item.id }}">
                      <i class="fas fa-user-check"></i> Task Details: {{ item.task_name }}
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <p><strong>Assigned By:</strong> {{ item.assign_by.get_full_name|default:item.assign_by.username }}</p>
                  <p><strong>Assigned To:</strong> {{ item.assign_to.get_full_name|default:item.assign_to.username }}</p>
                  <p><strong>Planned:</strong> {{ item.planned_date|date:"d M, Y H:i" }}</p>
                  {% if item.message %}<p><strong>Message:</strong><br>{{ item.message|linebreaks }}</p>{% endif %}
              </div>
              <div class="modal-footer">
                  {% if item.status == 'Pending' %}
                      <a href="{% url 'tasks:complete_checklist' item.id %}" class="btn btn-success">
                          <i class="fas fa-check"></i> Complete Task
                      </a>
                  {% endif %}
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
  </div>
  {% endfor %}

  <script>
  (function () {
    // Toggle +/- icon on filter card
    var toggles = document.querySelectorAll('[data-bs-toggle="collapse"]');
    for (var i = 0; i < toggles.length; i++) {
      toggles[i].addEventListener('click', function () {
        var icon = this.querySelector('i');
        if (!icon) return;
        if (icon.classList.contains('fa-minus')) {
          icon.classList.remove('fa-minus');
          icon.classList.add('fa-plus');
        } else {
          icon.classList.remove('fa-plus');
          icon.classList.add('fa-minus');
        }
      });
    }

    function getRowChecks() {
      return document.getElementsByClassName('row-check');
    }

    // Select all / unselect all
    var selectAll = document.getElementById('selectAll');
    if (selectAll) {
      selectAll.addEventListener('change', function () {
        var checks = getRowChecks();
        for (var i = 0; i < checks.length; i++) {
          checks[i].checked = selectAll.checked;
        }
      });
    }

    // Bulk delete
    var bulkBtn = document.getElementById('bulkDeleteBtn');
    if (bulkBtn) {
      bulkBtn.addEventListener('click', function () {
        var checks = getRowChecks();
        var any = false;
        for (var i = 0; i < checks.length; i++) {
          if (checks[i].checked) { any = true; break; }
        }
        if (!any) {
          alert('Please select at least one row.');
          return;
        }
        if (confirm('Delete selected tasks? This cannot be undone.')) {
          document.getElementById('bulkAction').value = 'bulk_delete';
          document.getElementById('bulkForm').submit();
        }
      });
    }

    // Single delete via hidden form (no inline JS)
    var delBtns = document.getElementsByClassName('delete-one');
    for (var j = 0; j < delBtns.length; j++) {
      delBtns[j].addEventListener('click', function () {
        var pk = this.getAttribute('data-pk');
        if (!confirm('Delete this task?')) return;
        document.getElementById('singleDeletePk').value = pk;
        document.getElementById('singleDeleteForm').submit();
      });
    }
  })();
  </script>
{% endblock %}
