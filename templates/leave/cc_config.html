{% extends "base.html" %}
{% load static %}

{% block title %}Manage CC Options{% endblock %}

{% block content %}
<div class="container my-4" style="max-width:1000px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Manage CC Options</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'leave:cc_assign' %}">
        <i class="fa fa-user-cog me-1"></i> Assign CC per Employee
      </a>
      <form class="d-flex" method="post" action="{% url 'leave:cc_config_add' %}">
        {% csrf_token %}
        {{ add_form.user }}
        <button class="btn btn-primary ms-2" type="submit">
          <i class="fa fa-plus me-1"></i> Add User
        </button>
      </form>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="card">
    <!-- MAIN SAVE FORM -->
    <form method="post" id="cc-save-form">
      {% csrf_token %}
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="min-width:240px;">User</th>
              <th>Department</th>
              <th>Active</th>
              <th>Sort</th>
              <th class="text-end">Remove</th>
            </tr>
          </thead>
          <tbody>
          {% for r in rows %}
            <tr>
              <td>
                {{ r.user.get_full_name|default:r.user.username }}<br>
                <small class="text-muted">{{ r.user.email }}</small>
              </td>
              <td style="max-width:220px;">
                <input type="text"
                       name="row-{{ r.id }}-department"
                       value="{{ r.department }}"
                       class="form-control form-control-sm">
              </td>
              <td class="text-center">
                <input class="form-check-input"
                       type="checkbox"
                       name="row-{{ r.id }}-is_active"
                       {% if r.is_active %}checked{% endif %}>
              </td>
              <td style="width:110px;">
                <input type="number"
                       name="row-{{ r.id }}-sort_order"
                       value="{{ r.sort_order }}"
                       class="form-control form-control-sm"
                       min="0">
              </td>
              <td class="text-end">
                <!-- remove uses hidden form (no nested forms) -->
                <button type="button"
                        class="btn btn-sm btn-outline-danger"
                        data-remove-url="{% url 'leave:cc_config_remove' r.id %}"
                        onclick="confirmRemove(this)">
                  <i class="fa fa-trash"></i>
                </button>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="5" class="text-muted">No CC options yet.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="p-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="text-muted small">
          <ul class="mb-0">
            <li><b>Active</b> controls who appears as selectable CCs.</li>
            <li>These options feed both the employee multi-CC assignment page and the employee leave form’s “Additional CC” field.</li>
          </ul>
        </div>
        <div>
          <button class="btn btn-success" type="submit">
            <i class="fa fa-save me-1"></i> Save Changes
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- HIDDEN REMOVE FORM (used by the trash buttons above) -->
  <form id="cc-remove-form" method="post" style="display:none;">
    {% csrf_token %}
  </form>
</div>

<script>
function confirmRemove(btn) {
  const url = btn.getAttribute('data-remove-url');
  if (!url) return;
  const who = btn.closest('tr')?.querySelector('td')?.innerText?.split('\n')[0] || 'this user';
  if (confirm('Remove ' + who + ' from CC options?')) {
    const f = document.getElementById('cc-remove-form');
    f.setAttribute('action', url);
    f.submit();
  }
}
</script>
{% endblock %}
