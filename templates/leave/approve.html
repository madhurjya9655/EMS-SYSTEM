{% extends "base.html" %}
{% load static users_permissions %}

{% block title %}Leave Approval{% endblock %}

{% block content %}
<div class="container my-4">

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} py-2">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="card">
    <div class="card-header bg-primary text-white">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
          <h5 class="mb-0">Leave Request â€” <span class="fw-bold">{{ employee_full_name }}</span></h5>
          {% if employee_email %}<small class="opacity-75">{{ employee_email }}</small>{% endif %}
        </div>

        <!-- Admin Edit button (visible only if user has leave_admin_edit) -->
        {% if request.user|has_permission:"leave_admin_edit" %}
          <a class="btn btn-light btn-sm"
             href="{% url 'leave:admin_edit_leave' leave.id %}?next={{ request.get_full_path|urlencode }}">
            <i class="fa-solid fa-pen-to-square me-1"></i> Edit (Admin)
          </a>
        {% endif %}
      </div>
    </div>

    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <p class="mb-1"><strong>Employee:</strong> {{ employee_full_name }}</p>
          {% if employee_designation %}<p class="mb-1"><strong>Designation:</strong> {{ employee_designation }}</p>{% endif %}
          {% if employee_email %}<p class="mb-1"><strong>Email:</strong> {{ employee_email }}</p>{% endif %}
        </div>
        <div class="col-md-6">
          <p class="mb-1">
            <strong>Type:</strong> {{ leave_type_name }}
            {% if is_half_day %}<span class="badge bg-dark ms-1">Half Day</span>{% endif %}
          </p>
          <p class="mb-1"><strong>From (IST):</strong> {{ from_ist|date:"Y-m-d H:i" }}</p>
          <p class="mb-1"><strong>To (IST):</strong> {{ to_ist|date:"Y-m-d H:i" }}</p>
          <p class="mb-1"><strong>Half-day:</strong> {{ is_half_day|yesno:"Yes,No" }}</p>
          <p class="mb-1"><strong>Status:</strong> {{ leave.get_status_display }}</p>
        </div>
      </div>

      {% if reason %}
        <hr>
        <p class="mb-1"><strong>Reason:</strong></p>
        <div class="border rounded p-2 bg-light">{{ reason|linebreaksbr }}</div>
      {% endif %}

      {% if attachment %}
        <p class="mt-2">
          <a class="btn btn-outline-secondary btn-sm" href="{{ attachment.url }}" target="_blank" rel="noopener">View Attachment</a>
        </p>
      {% endif %}

      {% if leave.is_decided %}
        <hr>
        <p class="text-muted mb-0">
          This request is already <strong>{{ leave.get_status_display }}</strong>
          {% if leave.approver %}(by {{ leave.approver.get_full_name|default:leave.approver.username }}){% endif %}.
        </p>

        <!-- Admin can still jump to edit -->
        {% if request.user|has_permission:"leave_admin_edit" %}
          <div class="mt-3">
            <a class="btn btn-outline-primary btn-sm"
               href="{% url 'leave:admin_edit_leave' leave.id %}?next={{ request.get_full_path|urlencode }}">
              <i class="fa-solid fa-pen-to-square me-1"></i> Edit (Admin)
            </a>
          </div>
        {% endif %}

      {% else %}
        <hr>
        <!-- Approve -->
        <form method="post" class="mb-2"
              action="{% url 'leave:manager_decide_approve' leave.id %}{% if next_url %}?next={{ next_url|urlencode }}{% endif %}">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label" for="decision_comment_approve">Decision comment (optional)</label>
            <input id="decision_comment_approve" type="text" name="decision_comment"
                   class="form-control" placeholder="Add a note for the employee">
          </div>
          <button type="submit" class="btn btn-success me-2">Approve</button>
          <button type="button" class="btn btn-outline-danger" onclick="document.getElementById('reject-form').submit();">
            Reject
          </button>

          {% if request.user|has_permission:"leave_admin_edit" %}
            <a class="btn btn-outline-primary ms-2"
               href="{% url 'leave:admin_edit_leave' leave.id %}?next={{ request.get_full_path|urlencode }}">
              <i class="fa-solid fa-pen-to-square me-1"></i> Edit (Admin)
            </a>
          {% endif %}
        </form>

        <!-- Reject -->
        <form id="reject-form" method="post"
              action="{% url 'leave:manager_decide_reject' leave.id %}{% if next_url %}?next={{ next_url|urlencode }}{% endif %}">
          {% csrf_token %}
          <input type="hidden" name="decision_comment" value="">
        </form>
      {% endif %}
    </div>
  </div>

  <div class="mt-3">
    <a href="{{ next_url|default:'/leave/manager/pending/' }}" class="btn btn-link">&larr; Back</a>
  </div>
</div>
{% endblock %}
