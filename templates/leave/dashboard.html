{% extends "base.html" %}
{% load static %}

{% block title %}Leave Dashboard{% endblock %}

{% block head_extra %}
<style>
  .dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    color: white;
    padding: 2rem;
    margin-bottom: 2rem;
  }
  .avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 4px solid rgba(255,255,255,0.3); }
  .avatar-placeholder { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; border: 4px solid rgba(255,255,255,0.3);}
  .stat-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 4px solid; transition: transform .2s ease; }
  .stat-card:hover { transform: translateY(-2px); }
  .stat-card.casual { border-left-color: #3b82f6; } .stat-card.earned { border-left-color: #10b981; } .stat-card.sick { border-left-color: #f59e0b; }
  .status-badge { font-size: .75rem; font-weight: 600; padding: .25rem .75rem; border-radius: 9999px; text-transform: uppercase; letter-spacing: .025em; }
  .status-pending { background:#fef3c7;color:#92400e; } .status-approved { background:#d1fae5;color:#065f46; } .status-rejected { background:#fee2e2;color:#991b1b; }
  .table-modern { background:white; border-radius:12px; overflow:hidden; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); }
  .table-modern thead th { background:#f8fafc; border:none; font-weight:600; font-size:.875rem; color:#374151; text-transform:uppercase; letter-spacing:.025em; padding:1rem; }
  .table-modern tbody td { border-color:#f1f5f9; padding:1rem; vertical-align:middle; }
  .table-modern tbody tr:hover { background:#f8fafc; }
  .btn-action { padding:.375rem .75rem; border-radius:6px; font-size:.875rem; font-weight:500; transition:all .2s ease; }
  .btn-delete { background:#fef2f2; color:#dc2626; border:1px solid #fecaca; }
  .btn-delete:hover { background:#fee2e2; color:#b91c1c; }
  .bulk-actions { background:white; border-radius:12px; padding:1rem; margin-bottom:1rem; box-shadow:0 2px 4px -1px rgba(0,0,0,0.1); display:none; }
  .bulk-actions.show { display:block; }
  .checkbox-custom { width:1.25rem; height:1.25rem; accent-color:#3b82f6; }
  .empty-state { text-align:center; padding:4rem 2rem; color:#6b7280; }
  .empty-state-icon { font-size:3rem; margin-bottom:1rem; opacity:.3; }
  .rule-item { display:flex; align-items:flex-start; gap:.5rem; margin-bottom:.75rem; }
  .rule-icon { color:#3b82f6; margin-top:.125rem; }
  .photo-upload-area { border:2px dashed #d1d5db; border-radius:8px; padding:1rem; text-align:center; background:#f9fafb; }
  .photo-upload-area:hover { border-color:#3b82f6; background:#eff6ff; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
  <div class="d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
      {% if employee_header.photo_url %}
        <img src="{{ employee_header.photo_url }}" alt="Profile Photo" class="avatar">
      {% else %}
        <div class="avatar-placeholder">
          {{ employee_header.name|default:user.username|slice:":1"|upper }}
        </div>
      {% endif %}
      <div>
        <h2 class="mb-1 fw-bold">{{ employee_header.name|default:user.username }}</h2>
        <div class="opacity-75 mb-1">
          {% if employee_header.designation %}{{ employee_header.designation }}{% endif %}
          {% if employee_header.department and employee_header.designation %} • {% endif %}
          {% if employee_header.department %}{{ employee_header.department }}{% endif %}
        </div>
        <div class="opacity-75">
          {{ employee_header.email }} • IST: {{ now_ist|date:"Y-m-d H:i" }}
        </div>
      </div>
    </div>
    <div>
      <a href="{% url 'leave:apply_leave' %}" class="btn btn-light btn-lg fw-semibold">
        <i class="fas fa-plus me-2"></i>Apply Leave
      </a>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="card-title fw-semibold mb-3">
          <i class="fas fa-camera text-primary me-2"></i>Profile Photo
        </h6>
        <form method="post" action="{% url 'leave:upload_photo' %}" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="photo-upload-area mb-3">
            <i class="fas fa-cloud-upload-alt text-muted mb-2" style="font-size: 2rem;"></i>
            <div>
              <input type="file" class="form-control" name="photo" accept="image/*" required>
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-upload me-2"></i>Upload Photo
          </button>
        </form>
        <small class="text-muted mt-2 d-block">Square images work best. JPG/PNG/WebP supported.</small>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="card-title fw-semibold mb-3">
          <i class="fas fa-chart-pie text-success me-2"></i>Leave Balance ({{ now_ist|date:"Y" }})
        </h6>
        {% if balances %}
          <div class="row g-2">
            {% for row in balances %}
              <div class="col-12">
                <div class="stat-card {% if 'Casual' in row.type_name %}casual{% elif 'Earned' in row.type_name %}earned{% else %}sick{% endif %}">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold">{{ row.type_name }}</div>
                      <small class="text-muted">{{ row.used_days|floatformat:"-1" }}/{{ row.default_days }} used</small>
                    </div>
                    <div class="text-end">
                      <div class="h5 mb-0 fw-bold">{{ row.remaining_days|floatformat:"-1" }}</div>
                      <small class="text-muted">days left</small>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted text-center py-3">
            <i class="fas fa-info-circle me-1"></i>No leave types configured
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <h6 class="card-title fw-semibold mb-3">
          <i class="fas fa-list-check text-warning me-2"></i>Leave Rules (IST)
        </h6>
        <div class="rule-item"><i class="fas fa-clock rule-icon"></i><div><strong>09:30 AM cutoff:</strong> Same-day leave must be applied before 09:30 AM</div></div>
        <div class="rule-item"><i class="fas fa-lock rule-icon"></i><div><strong>10:00 AM lock:</strong> No approvals/rejections after 10:00 AM for current day</div></div>
        <div class="rule-item"><i class="fas fa-calendar-check rule-icon"></i><div><strong>Half-day limit:</strong> Maximum 6 hours within same date</div></div>
        <div class="rule-item"><i class="fas fa-tasks rule-icon"></i><div><strong>Task blocking:</strong> Recurring tasks skip approved leave days</div></div>
      </div>
    </div>
  </div>
</div>

<div class="table-modern">
  <div class="card-header bg-white border-0 p-4">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-semibold">
        <i class="fas fa-calendar-alt text-primary me-2"></i>My Leave Applications
      </h5>
      {% if leaves %}
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary btn-sm" id="btnSelectAll">
            <i class="fas fa-check-square me-1"></i>Select All
          </button>
          <button type="button" class="btn btn-outline-danger btn-sm" id="bulkActionBtn" disabled>
            <i class="fas fa-trash me-1"></i>Delete Selected
          </button>
        </div>
      {% endif %}
    </div>
  </div>

  <div id="bulkActions" class="bulk-actions mx-4">
    <div class="d-flex justify-content-between align-items-center">
      <div class="fw-semibold text-primary">
        <i class="fas fa-info-circle me-1"></i>
        <span id="selectedCount">0</span> item(s) selected
      </div>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnClearSelection">Cancel</button>
        <button type="button" class="btn btn-sm btn-danger" id="btnConfirmBulkDelete">
          <i class="fas fa-trash me-1"></i>Delete Selected
        </button>
      </div>
    </div>
  </div>

  {% if leaves %}
    <div class="table-responsive">
      <table class="table table-modern mb-0">
        <thead>
          <tr>
            <th width="40"><input type="checkbox" class="checkbox-custom" id="selectAll"></th>
            <th>#</th>
            <th>Type</th>
            <th>From</th>
            <th>To</th>
            <th>Half-day</th>
            <th>Reason</th>
            <th>Days</th>
            <th>Status</th>
            <th>Approver</th>
            <th>CC</th>
            <th>Applied</th>
            <th width="100">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for lr in leaves %}
            <tr>
              <td><input type="checkbox" class="checkbox-custom leave-checkbox" value="{{ lr.id }}"></td>
              <td class="text-muted fw-medium">#{{ lr.id }}</td>
              <td><span class="badge bg-light text-dark">{{ lr.leave_type.name }}</span></td>
              <td class="text-nowrap">{% if lr.start_at %}{{ lr.start_at|date:"M d, H:i" }}{% else %}—{% endif %}</td>
              <td class="text-nowrap">{% if lr.end_at %}{{ lr.end_at|date:"M d, H:i" }}{% else %}—{% endif %}</td>
              <td class="text-center">
                {% if lr.is_half_day %}
                  <i class="fas fa-check-circle text-success" title="Half-day"></i>
                {% else %}
                  <i class="fas fa-times-circle text-muted" title="Full day"></i>
                {% endif %}
              </td>
              <td>
                {% if lr.reason %}
                  <div class="text-truncate" style="max-width: 200px;" title="{{ lr.reason }}">{{ lr.reason }}</div>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
                {% if lr.attachment %}
                  <div class="mt-1">
                    <a href="{{ lr.attachment.url }}" target="_blank" class="text-decoration-none small">
                      <i class="fas fa-paperclip me-1"></i>Attachment
                    </a>
                  </div>
                {% endif %}
              </td>
              <td class="fw-medium">{{ lr.blocked_days|floatformat:"-1" }}</td>
              <td>
                {% if lr.status == 'PENDING' %}
                  <span class="status-badge status-pending">Pending</span>
                {% elif lr.status == 'APPROVED' %}
                  <span class="status-badge status-approved">Approved</span>
                {% else %}
                  <span class="status-badge status-rejected">Rejected</span>
                {% endif %}
              </td>
              <td>
                {% if lr.approver %}
                  <div class="fw-medium">{{ lr.approver.get_full_name|default:lr.approver.username }}</div>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="text-nowrap">
                {% with ccs=lr.cc_users.all %}
                  {% if ccs %}
                    {% for u in ccs %}
                      <span class="badge rounded-pill text-bg-secondary me-1 mb-1"
                            title="{{ u.email|default_if_none:'' }}">{{ u.get_full_name|default:u.username }}</span>
                    {% endfor %}
                  {% else %}
                    <span class="text-muted small">—</span>
                  {% endif %}
                {% endwith %}
              </td>
              <td class="text-nowrap text-muted">{{ lr.applied_at|date:"M d, H:i" }}</td>
              <td>
                {% if lr.status == 'PENDING' %}
                  <button type="button"
                          class="btn btn-delete btn-sm js-delete-one"
                          data-leave-id="{{ lr.id }}"
                          data-leave-type="{{ lr.leave_type.name|escape }}"
                          data-start-date="{% if lr.start_at %}{{ lr.start_at|date:'M d' }}{% else %}—{% endif %}"
                          title="Delete leave request">
                    <i class="fas fa-trash"></i>
                  </button>
                {% else %}
                  <span class="text-muted small">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="empty-state">
      <div class="empty-state-icon"><i class="fas fa-calendar-plus"></i></div>
      <h5 class="fw-semibold mb-2">No Leave Applications</h5>
      <p class="mb-3">You haven't applied for any leave yet.</p>
      <a href="{% url 'leave:apply_leave' %}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Apply for Leave
      </a>
    </div>
  {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Deletion</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this leave request?</p>
      <div class="bg-light p-3 rounded" id="deleteDetails"></div>
      <div class="text-danger small mt-2"><i class="fas fa-info-circle me-1"></i>This action cannot be undone.</div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <form method="post" style="display:inline;" id="deleteForm">{% csrf_token %}
        <button type="submit" class="btn btn-danger"><i class="fas fa-trash me-1"></i>Delete</button>
      </form>
    </div>
  </div></div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Bulk Deletion</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete <strong id="bulkDeleteCount">0</strong> selected leave request(s)?</p>
      <div class="text-danger small"><i class="fas fa-info-circle me-1"></i>This action cannot be undone. Only pending requests can be deleted.</div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="button" class="btn btn-danger" id="btnExecuteBulkDelete"><i class="fas fa-trash me-1"></i>Delete Selected</button>
    </div>
  </div></div>
</div>

<script>
// --- Selection Management (no inline handlers) ---
function toggleSelectAll() {
  const selectAll = document.getElementById('selectAll');
  document.querySelectorAll('.leave-checkbox').forEach(cb => { cb.checked = selectAll.checked; });
  updateBulkActions();
}

function updateBulkActions() {
  const checked = document.querySelectorAll('.leave-checkbox:checked');
  const bulkActions = document.getElementById('bulkActions');
  const bulkActionBtn = document.getElementById('bulkActionBtn');
  const selectedCount = document.getElementById('selectedCount');
  const all = document.querySelectorAll('.leave-checkbox');
  const selectAll = document.getElementById('selectAll');

  const count = checked.length;
  selectedCount.textContent = count;

  if (count > 0) { bulkActions.classList.add('show'); bulkActionBtn.disabled = false; }
  else { bulkActions.classList.remove('show'); bulkActionBtn.disabled = true; }

  selectAll.checked = count === all.length && all.length > 0;
  selectAll.indeterminate = count > 0 && count < all.length;
}

function clearSelection() {
  document.querySelectorAll('.leave-checkbox').forEach(cb => { cb.checked = false; });
  const selectAll = document.getElementById('selectAll');
  if (selectAll) selectAll.checked = false;
  updateBulkActions();
}

function showBulkActions() {
  const checked = document.querySelectorAll('.leave-checkbox:checked');
  if (checked.length > 0) {
    document.getElementById('bulkDeleteCount').textContent = checked.length;
    const modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
    modal.show();
  }
}

// --- Delete (single) ---
function confirmDelete(leaveId, leaveType, startDate) {
  const wrap = document.getElementById('deleteDetails');
  wrap.innerHTML = '';
  const strong = document.createElement('strong');
  strong.textContent = leaveType;
  wrap.appendChild(strong);
  wrap.appendChild(document.createElement('br'));
  wrap.append('Start Date: ' + startDate);

  const form = document.getElementById('deleteForm');
  form.action = '/leave/delete/' + String(leaveId) + '/';

  const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
  modal.show();
}

// --- Bulk delete ---
function executeBulkDelete() {
  const ids = Array.from(document.querySelectorAll('.leave-checkbox:checked')).map(cb => cb.value);
  if (!ids.length) return;

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{% url "leave:bulk_delete" %}';

  const csrf = document.querySelector('#deleteForm [name=csrfmiddlewaretoken]');
  if (csrf) {
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrf.value;
    form.appendChild(csrfInput);
  }

  ids.forEach(id => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'leave_ids';
    input.value = id;
    form.appendChild(input);
  });

  document.body.appendChild(form);
  form.submit();
}

// --- Init bindings ---
document.addEventListener('DOMContentLoaded', function () {
  const selectAll = document.getElementById('selectAll');
  if (selectAll) selectAll.addEventListener('change', toggleSelectAll);

  document.getElementById('btnSelectAll')?.addEventListener('click', () => {
    const selectAllCb = document.getElementById('selectAll');
    if (selectAllCb) { selectAllCb.checked = true; toggleSelectAll(); }
  });

  document.getElementById('bulkActionBtn')?.addEventListener('click', showBulkActions);
  document.getElementById('btnClearSelection')?.addEventListener('click', clearSelection);
  document.getElementById('btnConfirmBulkDelete')?.addEventListener('click', showBulkActions);
  document.getElementById('btnExecuteBulkDelete')?.addEventListener('click', executeBulkDelete);

  document.querySelectorAll('.leave-checkbox').forEach(cb => cb.addEventListener('change', updateBulkActions));

  // Delegate single delete buttons
  document.body.addEventListener('click', function (e) {
    const btn = e.target.closest('.js-delete-one');
    if (!btn) return;
    const id = btn.dataset.leaveId;
    const type = btn.dataset.leaveType || '';
    const start = btn.dataset.startDate || '';
    confirmDelete(id, type, start);
  });

  updateBulkActions();
});
</script>
{% endblock %}
