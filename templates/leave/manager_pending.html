{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Manager • Pending Leaves</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- If your base template already includes Bootstrap, remove the CDN below -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .muted { color:#6b7280; }
    .nowrap { white-space: nowrap; }
    .comment-input { max-width: 280px; }
    @media (max-width: 992px) { .comment-input { max-width: 100%; } }
    .lock-pill { font-size: 12px; border-radius: 999px; padding: 2px 8px; }
    .text-truncate-280 { max-width: 280px; display: inline-block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* --- NEW: action cell alignment tweaks --- */
    td.actions-cell {
      vertical-align: middle;
    }
    .actions-wrap{
      display:inline-flex;
      align-items:center;
      justify-content:flex-end;
      gap:.5rem;
      flex-wrap:wrap;
    }
    .actions-wrap form{ margin:0; }
    .actions-wrap .btn{ line-height:1.2; }
    @media (max-width: 576px){
      .actions-wrap{ justify-content:flex-start; }
    }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  <!-- Flash messages -->
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} mb-2" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h4 class="mb-1">Pending Leaves</h4>
      <div class="small muted">Review and decide on leave requests assigned to you.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'leave:dashboard' %}">My Dashboard</a>
    </div>
  </div>

  <!-- IST banner / 10:00 AM rule -->
  <div id="ist-banner" class="alert alert-warning py-2 mb-3">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <strong>IST now:</strong> <span id="ist-now">—</span>
        <span class="ms-3">Same-day approvals are <strong>locked after 10:00 AM IST</strong>.</span>
      </div>
      <div id="cutoff-cta" class="small"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      {% if leaves %}
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Employee</th>
                <th>Type</th>
                <th>Start (IST)</th>
                <th>End (IST)</th>
                <th class="text-center">Half-day</th>
                <th>Reason</th>
                <th>Comment</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for lr in leaves %}
                <tr
                  data-row="leave"
                  data-start-iso="{{ lr.start_at|date:'c' }}"
                  data-end-iso="{{ lr.end_at|date:'c' }}"
                >
                  <td class="text-muted">#{{ lr.id }}</td>
                  <td>
                    <div class="fw-semibold">{{ lr.employee.get_full_name|default:lr.employee.username }}</div>
                    <div class="small muted">{{ lr.employee.email }}</div>
                  </td>
                  <td class="nowrap">{{ lr.leave_type.name }}</td>
                  <td class="nowrap">
                    {{ lr.start_at|date:"Y-m-d H:i" }}
                  </td>
                  <td class="nowrap">
                    {{ lr.end_at|date:"Y-m-d H:i" }}
                    <div class="small mt-1 d-none" data-lock-pill>
                      <span class="badge bg-secondary lock-pill">Locked after 10:00</span>
                    </div>
                  </td>
                  <td class="text-center">
                    {% if lr.is_half_day %}
                      <span class="badge bg-info text-dark">Yes</span>
                    {% else %}
                      <span class="text-muted">No</span>
                    {% endif %}
                  </td>
                  <td style="min-width:220px; max-width:360px;">
                    {% if lr.reason %}
                      <span class="text-truncate-280" title="{{ lr.reason }}">{{ lr.reason }}</span>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                    {% if lr.attachment %}
                      <div class="small mt-1">
                        <a href="{{ lr.attachment.url }}" target="_blank" rel="noopener" class="link-secondary">Attachment</a>
                      </div>
                    {% endif %}
                  </td>

                  <!-- Per-row Approve/Reject forms (POST) -->
                  <td style="min-width:220px;">
                    <!-- Duplicate the comment into each form so it submits with the chosen action -->
                    <input form="approve-{{ lr.id }}" class="form-control form-control-sm comment-input mb-1"
                           type="text" name="decision_comment" placeholder="Optional comment">
                    <input form="reject-{{ lr.id }}" class="form-control form-control-sm comment-input"
                           type="text" name="decision_comment" placeholder="Optional comment">
                  </td>

                  <td class="text-end actions-cell">
                    <div class="actions-wrap">
                      <a class="btn btn-outline-primary btn-sm"
                         href="{% url 'leave:approval_page' lr.id %}?next={{ request.get_full_path|urlencode }}">
                        Open
                      </a>

                      <form id="approve-{{ lr.id }}" method="post"
                            action="{% url 'leave:manager_decide_approve' lr.id %}?next={{ request.get_full_path|urlencode }}">
                        {% csrf_token %}
                        <button class="btn btn-success btn-sm" type="submit" title="Approve" data-approve>
                          Approve
                        </button>
                      </form>

                      <form id="reject-{{ lr.id }}" method="post"
                            action="{% url 'leave:manager_decide_reject' lr.id %}?next={{ request.get_full_path|urlencode }}">
                        {% csrf_token %}
                        <button class="btn btn-danger btn-sm" type="submit" title="Reject" data-reject>
                          Reject
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center p-5 text-muted">
          <div class="mb-2">No pending leaves assigned to you.</div>
          <a class="btn btn-outline-primary btn-sm" href="{% url 'leave:dashboard' %}">Go to Dashboard</a>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<script>
/**
 * Client-side assistance (no security guarantee):
 * - Shows IST time and a countdown to 10:00 AM IST.
 * - Disables Approve/Reject for rows that include TODAY (IST) once IST >= 10:00.
 * Server-side validation still hard-enforces this.
 */
(function () {
  const tz = 'Asia/Kolkata';
  const $now = document.getElementById('ist-now');
  const $cta = document.getElementById('cutoff-cta');

  function fmtIST(d) {
    return new Intl.DateTimeFormat('en-GB', {
      timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    }).format(d).replace(',', '');
  }

  function todayIST(d) {
    const parts = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' })
      .formatToParts(d).reduce((a,p)=>{a[p.type]=p.value;return a;}, {});
    return `${parts.year}-${parts.month}-${parts.day}`;
  }

  function at10amIST(d) {
    // IST = UTC+05:30, so 10:00 IST == 04:30 UTC on same calendar date
    const parts = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' })
      .formatToParts(d).reduce((a,p)=>{a[p.type]=p.value;return a;}, {});
    const utc = Date.UTC(parseInt(parts.year), parseInt(parts.month)-1, parseInt(parts.day), 4, 30, 0);
    return new Date(utc);
  }

  function parseISO(s) {
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  }

  function includesTodayIST(startISO, endISO, now) {
    const s = parseISO(startISO);
    const e = parseISO(endISO);
    if (!s || !e) return false;
    const sDay = todayIST(s);
    const eDay = todayIST(e);
    const tDay = todayIST(now);
    return (sDay <= tDay && tDay <= eDay);
  }

  function updateClockAndLocks() {
    const now = new Date();
    $now.textContent = fmtIST(now);

    const cutoff = at10amIST(now);
    const lockedNow = now.getTime() >= cutoff.getTime();

    if (!lockedNow) {
      const ms = cutoff.getTime() - now.getTime();
      const mm = Math.floor(ms / 60000);
      const ss = Math.floor((ms % 60000) / 1000);
      $cta.textContent = `Same-day actions lock in ${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
      $cta.className = 'text-muted';
    } else {
      $cta.textContent = 'Same-day actions are locked for today.';
      $cta.className = 'text-danger fw-semibold';
    }

    document.querySelectorAll('tr[data-row="leave"]').forEach(tr => {
      const sISO = tr.getAttribute('data-start-iso');
      const eISO = tr.getAttribute('data-end-iso');
      const isToday = includesTodayIST(sISO, eISO, now);

      const $approve = tr.querySelector('button[data-approve]');
      const $reject  = tr.querySelector('button[data-reject]');
      const $pill    = tr.querySelector('[data-lock-pill]');

      const locked = lockedNow && isToday;

      if ($approve) { $approve.disabled = locked; }
      if ($reject)  { $reject.disabled  = locked;  }
      if ($pill)    { $pill.classList.toggle('d-none', !locked); }

      if (locked) {
        if ($approve) $approve.title = 'Locked after 10:00 AM IST for same-day leaves';
        if ($reject)  $reject.title  = 'Locked after 10:00 AM IST for same-day leaves';
      } else {
        if ($approve) $approve.removeAttribute('title');
        if ($reject)  $reject.removeAttribute('title');
      }
    });
  }

  updateClockAndLocks();
  setInterval(updateClockAndLocks, 1000);
})();
</script>
</body>
</html>
