{% load static user_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <title>{% block title %}BOS EMS{% endblock %}</title>

  <!-- Favicons -->
  <link rel="shortcut icon" href="{% static 'favicon.ico' %}">
  <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'icons/favicon-32.png' %}">
  <link rel="icon" type="image/png" sizes="16x16" href="{% static 'icons/favicon-16.png' %}">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Vendor CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
        crossorigin="anonymous">

  <!-- App CSS -->
  <link href="{% static 'css/custom.css' %}" rel="stylesheet">

  {% block head_extra %}{% endblock %}

  <style>
    :root{
      --primary:#4f46e5; --primary-light:#6366f1; --primary-dark:#3730a3;
      --sidebar-width:280px; --header-height:70px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f8fafc}

    /* Header */
    .header{
      position:fixed;inset:0 0 auto 0;height:var(--header-height);
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%);
      z-index:1000;box-shadow:0 4px 20px rgba(79,70,229,.15);
      display:flex;align-items:center;padding:0 2rem;justify-content:space-between
    }
    .logo{display:flex;align-items:center;gap:12px;color:#fff}
    .logo-icon{
      width:40px;height:40px;background:rgba(255,255,255,.2);border-radius:10px;
      display:flex;align-items:center;justify-content:center;font-weight:700;backdrop-filter:blur(10px)
    }
    .logo-icon img{max-width:32px;max-height:32px;border-radius:7px}
    .logo-text{font-size:1.25rem;font-weight:600}
    .header-actions{display:flex;align-items:center;gap:1.5rem}

    .branch-select{
      background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;
      padding:.6rem 1.2rem;border-radius:8px;font-size:.9rem;backdrop-filter:blur(10px);min-width:160px
    }
    .branch-select option{background:var(--primary);color:#fff}

    .user-menu{display:flex;align-items:center;gap:.8rem;color:#fff;font-size:.9rem}
    .user-avatar{width:36px;height:36px;background:rgba(255,255,255,.2);border-radius:50%;
      display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px)}

    .logout-btn{
      background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.3);color:#fff;
      padding:.6rem 1.2rem;border-radius:8px;font-size:.85rem;backdrop-filter:blur(10px);transition:.2s
    }
    .logout-btn:hover{background:rgba(255,255,255,.2);transform:translateY(-1px)}

    .mobile-toggle{display:none;background:none;border:none;color:#fff;font-size:1.3rem;cursor:pointer}

    /* Sidebar */
    .sidebar{
      position:fixed;top:var(--header-height);left:0;width:var(--sidebar-width);
      height:calc(100vh - var(--header-height));background:#fff;
      box-shadow:4px 0 20px rgba(0,0,0,.08);overflow-y:auto;transition:transform .3s ease;z-index:900
    }
    .sidebar.collapsed{transform:translateX(-100%)}

    .nav-section{padding:1.5rem 0;border-bottom:1px solid #f1f5f9}
    .nav-item{
      display:block;padding:.8rem 1.5rem;color:#64748b;text-decoration:none;font-size:.9rem;
      font-weight:500;transition:color .2s ease, background .2s ease, transform .15s ease;
      width:100%;text-align:left;border:none;background:none;position:relative
    }
    .nav-item:hover{background:#f8fafc;color:var(--primary);transform:translateX(4px)}
    .nav-item.active,.nav-item[aria-current="page"]{
      background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);
      color:var(--primary);border-right:3px solid var(--primary)
    }
    .nav-item i{width:20px;margin-right:.8rem;font-size:1rem}
    .nav-item .chevron{float:right;font-size:.75rem;transition:transform .2s}

    .submenu{background:#f8fafc;border-left:2px solid #e2e8f0;margin-left:1rem;display:none}
    .submenu .nav-item{padding:.6rem 2.5rem;font-size:.85rem;color:#64748b}

    /* Main area */
    .main-content{margin-left:var(--sidebar-width);margin-top:var(--header-height);padding:2rem;min-height:calc(100vh - var(--header-height));transition:margin-left .3s ease}
    .main-content.expanded{margin-left:0}

    .page-header{background:#fff;padding:2rem;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.08);margin-bottom:2rem;border:1px solid #f1f5f9}
    .page-title{font-size:1.8rem;font-weight:700;color:#1e293b;margin-bottom:.5rem}

    /* Footer */
    footer{background:#fff;border-top:1px solid #f1f5f9;text-align:center;padding:1.5rem;color:#64748b;font-size:.9rem;margin-top:2rem}

    /* Overlay */
    .sidebar-overlay{display:none;position:fixed;top:var(--header-height);left:0;width:100vw;height:100vh;background:rgba(0,0,0,.12);z-index:899}
    .sidebar.show ~ .sidebar-overlay,.sidebar-overlay.show{display:block}

    /* Skip link */
    .skip-link{position:absolute;left:-9999px;top:-9999px}
    .skip-link:focus{left:1rem;top:1rem;background:#111827;color:#fff;padding:.5rem .75rem;border-radius:.5rem;z-index:1100}

    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto !important}
      .nav-item:hover{transform:none}
    }
    @media (max-width:768px){
      .mobile-toggle{display:block}
      .branch-select,.user-menu span:first-child{display:none}
      .sidebar{transform:translateX(-100%)}
      .sidebar.show{transform:translateX(0)}
      .main-content{margin-left:0;padding:1rem}
      .page-header{padding:1.5rem}
    }
  </style>
</head>
<body>
  <a href="#mainContent" class="skip-link">Skip to content</a>

  {% url 'dashboard:home' as dashboard_home_url %}
  {% if user.is_authenticated %}
    <div class="header" role="banner">
      <div class="logo">
        <button class="mobile-toggle" type="button" aria-label="Toggle sidebar" data-sidebar-toggle>
          <i class="fas fa-bars" aria-hidden="true"></i>
        </button>
        <div class="logo-icon">
          <img src="{% static 'images/bos logo.png' %}" alt="BOS EMS logo" loading="lazy" decoding="async">
        </div>
        <span class="logo-text">BOS EMS</span>
      </div>

      <div class="header-actions">
        <label class="visually-hidden" for="branchSelect">Branch</label>
        <!-- Disabled since it's decorative for now; remove "disabled" when wired -->
        <select class="branch-select" id="branchSelect" aria-label="Select branch" disabled>
          <option>All Branches</option>
          <option>Branch 1</option>
          <option>Branch 2</option>
        </select>

        <div class="user-menu" role="group" aria-label="User menu">
          <span>{{ user.get_full_name|default:user.username }}</span>
          <div class="user-avatar" aria-hidden="true"><i class="fas fa-user"></i></div>
        </div>

        <form method="post" action="{% url 'logout' %}" style="margin:0;" aria-label="Logout">
          {% csrf_token %}
          <button class="logout-btn" type="submit" aria-label="Logout from BOS EMS">
            <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Logout
          </button>
        </form>
      </div>
    </div>

    <nav class="sidebar" id="sidebar" role="navigation" aria-label="Primary">
      <div class="nav-section">
        <a href="{% url 'dashboard:home' %}"
           class="nav-item {% if request.resolver_match.app_name == 'dashboard' and request.resolver_match.url_name == 'home' %}active{% endif %}"
           {% if request.resolver_match.app_name == 'dashboard' and request.resolver_match.url_name == 'home' %}aria-current="page"{% endif %}>
          <i class="fas fa-tachometer-alt" aria-hidden="true"></i> Dashboard
        </a>

        {% if user|has_permission:"list_users" or user|has_group:"HR" or user.is_superuser %}
        <a href="{% url 'recruitment:employee_list' %}"
           class="nav-item {% if request.resolver_match.app_name == 'recruitment' and request.resolver_match.url_name == 'employee_list' %}active{% endif %}"
           {% if request.resolver_match.app_name == 'recruitment' and request.resolver_match.url_name == 'employee_list' %}aria-current="page"{% endif %}>
          <i class="fas fa-users" aria-hidden="true"></i> Employees
        </a>
        {% endif %}

        {# --- Leave Register --- #}
        {% if user|has_any_permission:"leave_list,leave_apply,leave_pending_manager" or user|has_group:"Manager" or user|has_group:"HR" or user.is_superuser %}
        <button type="button" class="nav-item" aria-expanded="false" aria-controls="leaveSubmenu" data-submenu-toggle>
          <i class="fas fa-calendar-day" aria-hidden="true"></i> Leave Register <i class="fas fa-chevron-down chevron" aria-hidden="true"></i>
        </button>
        <div class="submenu" id="leaveSubmenu" role="group" aria-label="Leave Register">
          {% if user|has_any_permission:"leave_list,leave_apply" %}
          <a href="{% url 'leave:dashboard' %}"
             class="nav-item {% if request.resolver_match.app_name == 'leave' and request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'leave' and request.resolver_match.url_name == 'dashboard' %}aria-current="page"{% endif %}>
            <i class="fas fa-gauge" aria-hidden="true"></i> My Leave Dashboard
          </a>
          <a href="{% url 'leave:apply_leave' %}"
             class="nav-item {% if request.resolver_match.app_name == 'leave' and request.resolver_match.url_name == 'apply_leave' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'leave' and request.resolver_match.url_name == 'apply_leave' %}aria-current="page"{% endif %}>
            <i class="fas fa-plus-circle" aria-hidden="true"></i> Apply Leave
          </a>
          {% endif %}
          {% if user|has_permission:"leave_pending_manager" or user.is_superuser %}
          <a href="{% url 'leave:manager_pending' %}"
             class="nav-item {% if request.resolver_match.app_name == 'leave' and request.resolver_match.url_name == 'manager_pending' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'leave' and request.resolver_match.url_name == 'manager_pending' %}aria-current="page"{% endif %}>
            <i class="fas fa-check-circle" aria-hidden="true"></i> Manager Approvals
          </a>
          {% endif %}
        </div>
        {% endif %}

        {% if user|has_any_permission:"add_checklist,list_checklist" %}
        <button type="button" class="nav-item" aria-expanded="false" aria-controls="checklistSubmenu" data-submenu-toggle>
          <i class="fas fa-clipboard-list" aria-hidden="true"></i> Checklist <i class="fas fa-chevron-down chevron" aria-hidden="true"></i>
        </button>
        <div class="submenu" id="checklistSubmenu" role="group" aria-label="Checklist">
          {% if user|has_permission:"add_checklist" %}
          <a href="{% url 'tasks:add_checklist' %}" class="nav-item {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'add_checklist' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'add_checklist' %}aria-current="page"{% endif %}>
            <i class="fas fa-clipboard-plus" aria-hidden="true"></i> Add Checklist
          </a>
          {% endif %}
          {% if user|has_permission:"list_checklist" %}
          <a href="{% url 'tasks:list_checklist' %}" class="nav-item {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'list_checklist' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'list_checklist' %}aria-current="page"{% endif %}>
            <i class="fas fa-clipboard-list" aria-hidden="true"></i> List Checklist
          </a>
          {% endif %}
        </div>
        {% endif %}

        {% if user|has_permission:"mt_bulk_upload" %}
        <a href="{% url 'tasks:bulk_upload' %}" class="nav-item {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'bulk_upload' %}active{% endif %}"
           {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'bulk_upload' %}aria-current="page"{% endif %}>
          <i class="fas fa-upload" aria-hidden="true"></i> Bulk Upload
        </a>
        {% endif %}

        {% if user|has_any_permission:"add_delegation,list_delegation" %}
        <button type="button" class="nav-item" aria-expanded="false" aria-controls="delegationSubmenu" data-submenu-toggle>
          <i class="fas fa-users-cog" aria-hidden="true"></i> Delegation <i class="fas fa-chevron-down chevron" aria-hidden="true"></i>
        </button>
        <div class="submenu" id="delegationSubmenu" role="group" aria-label="Delegation">
          {% if user|has_permission:"add_delegation" %}
          <a href="{% url 'tasks:add_delegation' %}" class="nav-item {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'add_delegation' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'add_delegation' %}aria-current="page"{% endif %}>
            <i class="fas fa-user-plus" aria-hidden="true"></i> Add Delegation
          </a>
          {% endif %}
          {% if user|has_permission:"list_delegation" %}
          <a href="{% url 'tasks:list_delegation' %}" class="nav-item {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'list_delegation' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'list_delegation' %}aria-current="page"{% endif %}>
            <i class="fas fa-user-clock" aria-hidden="true"></i> List Delegation
          </a>
          {% endif %}
        </div>
        {% endif %}

        {% if user|has_any_permission:"add_ticket,list_all_tickets,assigned_to_me,assigned_by_me" %}
        <button type="button" class="nav-item" aria-expanded="false" aria-controls="ticketsSubmenu" data-submenu-toggle>
          <i class="fas fa-ticket-alt" aria-hidden="true"></i> Tickets <i class="fas fa-chevron-down chevron" aria-hidden="true"></i>
        </button>
        <div class="submenu" id="ticketsSubmenu" role="group" aria-label="Tickets">
          {% if user|has_permission:"add_ticket" %}
          <a href="{% url 'tasks:add_help_ticket' %}" class="nav-item {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'add_help_ticket' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'add_help_ticket' %}aria-current="page"{% endif %}>
            <i class="fas fa-plus-circle" aria-hidden="true"></i> Add Ticket
          </a>
          {% endif %}
          {% if user|has_permission:"list_all_tickets" %}
          <a href="{% url 'tasks:list_help_ticket' %}" class="nav-item {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'list_help_ticket' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'list_help_ticket' %}aria-current="page"{% endif %}>
            <i class="fas fa-list" aria-hidden="true"></i> List All Tickets
          </a>
          {% endif %}
          {% if user|has_permission:"assigned_to_me" %}
          <a href="{% url 'tasks:assigned_to_me' %}" class="nav-item {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'assigned_to_me' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'assigned_to_me' %}aria-current="page"{% endif %}>
            <i class="fas fa-user-clock" aria-hidden="true"></i> Assigned to Me
          </a>
          {% endif %}
          {% if user|has_permission:"assigned_by_me" %}
          <a href="{% url 'tasks:assigned_by_me' %}" class="nav-item {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'assigned_by_me' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'tasks' and request.resolver_match.url_name == 'assigned_by_me' %}aria-current="page"{% endif %}>
            <i class="fas fa-user-plus" aria-hidden="true"></i> Assigned by Me
          </a>
          {% endif %}
        </div>
        {% endif %}

        {% if user|has_any_permission:"petty_cash_list,petty_cash_apply" or user|has_group:"Manager" or user|has_group:"Finance" %}
        <button type="button" class="nav-item" aria-expanded="false" aria-controls="pettyCashSubmenu" data-submenu-toggle>
          <i class="fas fa-wallet" aria-hidden="true"></i> Petty Cash <i class="fas fa-chevron-down chevron" aria-hidden="true"></i>
        </button>
        <div class="submenu" id="pettyCashSubmenu" role="group" aria-label="Petty Cash">
          {% if user|has_permission:"petty_cash_list" %}
          <a href="{% url 'petty_cash:list_requests' %}" class="nav-item {% if request.resolver_match.app_name == 'petty_cash' and request.resolver_match.url_name == 'list_requests' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'petty_cash' and request.resolver_match.url_name == 'list_requests' %}aria-current="page"{% endif %}>
            <i class="fas fa-file-invoice-dollar" aria-hidden="true"></i> My Requests
          </a>
          {% endif %}
          {% if user|has_permission:"petty_cash_apply" or user|has_group:"EA" %}
          <a href="{% url 'petty_cash:apply_request' %}" class="nav-item {% if request.resolver_match.app_name == 'petty_cash' and request.resolver_match.url_name == 'apply_request' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'petty_cash' and request.resolver_match.url_name == 'apply_request' %}aria-current="page"{% endif %}>
            <i class="fas fa-plus-circle" aria-hidden="true"></i> New Request
          </a>
          {% endif %}
          {% if user|has_group:"Manager" %}
          <a href="{% url 'petty_cash:manager_requests' %}" class="nav-item {% if request.resolver_match.app_name == 'petty_cash' and request.resolver_match.url_name == 'manager_requests' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'petty_cash' and request.resolver_match.url_name == 'manager_requests' %}aria-current="page"{% endif %}>
            <i class="fas fa-check" aria-hidden="true"></i> Manager Approvals
          </a>
          {% endif %}
          {% if user|has_group:"Finance" %}
          <a href="{% url 'petty_cash:finance_requests' %}" class="nav-item {% if request.resolver_match.app_name == 'petty_cash' and request.resolver_match.url_name == 'finance_requests' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'petty_cash' and request.resolver_match.url_name == 'finance_requests' %}aria-current="page"{% endif %}>
            <i class="fas fa-coins" aria-hidden="true"></i> Finance Approvals
          </a>
          {% endif %}
        </div>
        {% endif %}

        {% if user|has_any_permission:"reimbursement_list,reimbursement_apply" or user|has_group:"Manager" or user|has_group:"Finance" %}
        <button type="button" class="nav-item" aria-expanded="false" aria-controls="reimbursementSubmenu" data-submenu-toggle>
          <i class="fas fa-receipt" aria-hidden="true"></i> Reimbursement <i class="fas fa-chevron-down chevron" aria-hidden="true"></i>
        </button>
        <div class="submenu" id="reimbursementSubmenu" role="group" aria-label="Reimbursement">
          {% if user|has_any_permission:"reimbursement_list,reimbursement_apply" %}
          <a href="{% url 'reimbursement:my_reimbursements' %}" class="nav-item {% if request.resolver_match.app_name == 'reimbursement' and request.resolver_match.url_name == 'my_reimbursements' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'reimbursement' and request.resolver_match.url_name == 'my_reimbursements' %}aria-current="page"{% endif %}>
            <i class="fas fa-file-medical" aria-hidden="true"></i> My Requests
          </a>
          {% endif %}
          {% if user|has_group:"Manager" %}
          <a href="{% url 'reimbursement:manager_pending' %}" class="nav-item {% if request.resolver_match.app_name == 'reimbursement' and request.resolver_match.url_name == 'manager_pending' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'reimbursement' and request.resolver_match.url_name == 'manager_pending' %}aria-current="page"{% endif %}>
            <i class="fas fa-check-square" aria-hidden="true"></i> Manager Approvals
          </a>
          {% endif %}
          {% if user|has_group:"Finance" %}
          <a href="{% url 'reimbursement:finance_pending' %}" class="nav-item {% if request.resolver_match.app_name == 'reimbursement' and request.resolver_match.url_name == 'finance_pending' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'reimbursement' and request.resolver_match.url_name == 'finance_pending' %}aria-current="page"{% endif %}>
            <i class="fas fa-wallet" aria-hidden="true"></i> Finance Approvals
          </a>
          {% endif %}
        </div>
        {% endif %}

        {% if user|has_any_permission:"doer_tasks,weekly_mis_score,performance_score" %}
        <button type="button" class="nav-item" aria-expanded="false" aria-controls="reportsSubmenu" data-submenu-toggle>
          <i class="fas fa-chart-pie" aria-hidden="true"></i> Reports <i class="fas fa-chevron-down chevron" aria-hidden="true"></i>
        </button>
        <div class="submenu" id="reportsSubmenu" role="group" aria-label="Reports">
          {% if user|has_permission:"doer_tasks" %}
          <a href="{% url 'reports:doer_tasks' %}" class="nav-item {% if request.resolver_match.app_name == 'reports' and request.resolver_match.url_name == 'doer_tasks' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'reports' and request.resolver_match.url_name == 'doer_tasks' %}aria-current="page"{% endif %}>
            <i class="fas fa-tasks-alt" aria-hidden="true"></i> Doer Tasks
          </a>
          {% endif %}
          {% if user|has_permission:"weekly_mis_score" %}
          <a href="{% url 'reports:weekly_mis_score' %}" class="nav-item {% if request.resolver_match.app_name == 'reports' and request.resolver_match.url_name == 'weekly_mis_score' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'reports' and request.resolver_match.url_name == 'weekly_mis_score' %}aria-current="page"{% endif %}>
            <i class="fas fa-calendar-week" aria-hidden="true"></i> Weekly MIS Score
          </a>
          {% endif %}
          {% if user|has_permission:"performance_score" %}
          <a href="{% url 'reports:performance_score' %}" class="nav-item {% if request.resolver_match.app_name == 'reports' and request.resolver_match.url_name == 'performance_score' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'reports' and request.resolver_match.url_name == 'performance_score' %}aria-current="page"{% endif %}>
            <i class="fas fa-percent" aria-hidden="true"></i> Performance Score
          </a>
          {% endif %}
        </div>
        {% endif %}

        {% if user|has_any_permission:"list_users,add_user" or user.is_superuser %}
        <button type="button" class="nav-item" aria-expanded="false" aria-controls="usersSubmenu" data-submenu-toggle>
          <i class="fas fa-user-friends" aria-hidden="true"></i> Users <i class="fas fa-chevron-down chevron" aria-hidden="true"></i>
        </button>
        <div class="submenu" id="usersSubmenu" role="group" aria-label="Users">
          {% if user|has_permission:"list_users" or user.is_superuser %}
          <a href="{% url 'users:list_users' %}" class="nav-item {% if request.resolver_match.app_name == 'users' and request.resolver_match.url_name == 'list_users' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'users' and request.resolver_match.url_name == 'list_users' %}aria-current="page"{% endif %}>
            <i class="fas fa-list" aria-hidden="true"></i> List Users
          </a>
          {% endif %}
          {% if user|has_permission:"add_user" or user.is_superuser %}
          <a href="{% url 'users:add_user' %}" class="nav-item {% if request.resolver_match.app_name == 'users' and request.resolver_match.url_name == 'add_user' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'users' and request.resolver_match.url_name == 'add_user' %}aria-current="page"{% endif %}>
            <i class="fas fa-user-plus" aria-hidden="true"></i> Add User
          </a>
          {% endif %}
        </div>
        {% endif %}

        {% if user|has_any_permission:"authorized_numbers,system_settings" or user.is_superuser %}
        <button type="button" class="nav-item" aria-expanded="false" aria-controls="settingsSubmenu" data-submenu-toggle>
          <i class="fas fa-cog" aria-hidden="true"></i> Settings <i class="fas fa-chevron-down chevron" aria-hidden="true"></i>
        </button>
        <div class="submenu" id="settingsSubmenu" role="group" aria-label="Settings">
          {% if user|has_permission:"authorized_numbers" %}
          <a href="{% url 'settings:authorized_list' %}" class="nav-item {% if request.resolver_match.app_name == 'settings' and request.resolver_match.url_name == 'authorized_list' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'settings' and request.resolver_match.url_name == 'authorized_list' %}aria-current="page"{% endif %}>
            <i class="fas fa-phone" aria-hidden="true"></i> Authorized Numbers
          </a>
          {% endif %}
          <a href="{% url 'settings:holiday_list' %}" class="nav-item {% if request.resolver_match.app_name == 'settings' and request.resolver_match.url_name == 'holiday_list' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'settings' and request.resolver_match.url_name == 'holiday_list' %}aria-current="page"{% endif %}>
            <i class="fas fa-calendar-day" aria-hidden="true"></i> Holiday List
          </a>
          {% if user|has_permission:"system_settings" %}
          <a href="{% url 'settings:system_settings' %}" class="nav-item {% if request.resolver_match.app_name == 'settings' and request.resolver_match.url_name == 'system_settings' %}active{% endif %}"
             {% if request.resolver_match.app_name == 'settings' and request.resolver_match.url_name == 'system_settings' %}aria-current="page"{% endif %}>
            <i class="fas fa-sliders-h" aria-hidden="true"></i> System Settings
          </a>
          {% endif %}
        </div>
        {% endif %}

        {% if user.is_superuser %}
        <a href="{% url 'users:debug_permissions' %}" class="nav-item {% if request.resolver_match.app_name == 'users' and request.resolver_match.url_name == 'debug_permissions' %}active{% endif %}"
           {% if request.resolver_match.app_name == 'users' and request.resolver_match.url_name == 'debug_permissions' %}aria-current="page"{% endif %}>
          <i class="fas fa-bug" aria-hidden="true"></i> Debug Permissions
        </a>
        {% endif %}
      </div>
    </nav>
    <div class="sidebar-overlay" data-sidebar-overlay aria-hidden="true"></div>
  {% endif %}

  <main class="{% if user.is_authenticated %}main-content{% else %}container mt-5{% endif %}" id="mainContent" role="main">
    {% if messages %}
      <div class="container mb-3" aria-live="polite" aria-atomic="true">
        {% for message in messages %}
          <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} shadow-sm" role="alert">
            {{ message|safe }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
    {% block content %}{% endblock %}
  </main>

  {% if user.is_authenticated %}
    <footer role="contentinfo">
      <small>© {% now "Y" %} Developed by Madhurjya Bora</small>
    </footer>
  {% endif %}

  <!-- Vendor JS -->
  <script defer
          src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
          crossorigin="anonymous"></script>

  <script>
    // --- CSRF helpers ---
    function getCookie(name){
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? decodeURIComponent(m.pop()) : null;
    }
    const CSRF_COOKIE = 'csrftoken';

    document.addEventListener('DOMContentLoaded', () => {
      // Ensure CSRF in any POST form
      document.querySelectorAll('form[method="post"]').forEach(form => {
        const hasToken = form.querySelector('input[name="csrfmiddlewaretoken"]');
        if (!hasToken) {
          const token = getCookie(CSRF_COOKIE);
          if (token) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'csrfmiddlewaretoken';
            input.value = token;
            form.prepend(input);
          }
        }
      });
    });

    (function patchFetch(){
      const _fetch = window.fetch;
      window.fetch = function(input, init){
        try{
          const url = (typeof input === 'string') ? input : input.url;
          const sameOrigin = !/^https?:\/\//i.test(url) || url.startsWith(window.location.origin);
          const method = (init && (init.method || (init.headers && init.headers['X-HTTP-Method-Override']))) || 'GET';
          const safe = /^(GET|HEAD|OPTIONS|TRACE)$/i.test(method);
          if (sameOrigin && !safe){
            init = init || {};
            init.headers = new Headers(init.headers || {});
            if (!init.headers.has('X-CSRFToken')) {
              const token = getCookie(CSRF_COOKIE);
              if (token) init.headers.set('X-CSRFToken', token);
            }
          }
        }catch(_e){}
        return _fetch(input, init);
      };
    })();

    (function patchXHR(){
      const origOpen = XMLHttpRequest.prototype.open;
      const origSend = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.open = function(method, url){
        this._isSameOrigin = !/^https?:\/\//i.test(url) || url.startsWith(window.location.origin);
        this._method = method || 'GET';
        return origOpen.apply(this, arguments);
      };
      XMLHttpRequest.prototype.send = function(body){
        try{
          const safe = /^(GET|HEAD|OPTIONS|TRACE)$/i.test(this._method || 'GET');
          if (this._isSameOrigin && !safe) {
            const token = getCookie(CSRF_COOKIE);
            if (token) this.setRequestHeader('X-CSRFToken', token);
          }
        }catch(_e){}
        return origSend.apply(this, arguments);
      };
    })();

    // --- Sidebar & submenu ---
    function toggleSidebar(){
      const sidebar=document.getElementById('sidebar'),
            overlay=document.querySelector('[data-sidebar-overlay]'),
            main=document.getElementById('mainContent');
      if(!sidebar || !main) return;
      if(window.innerWidth<=768){
        sidebar.classList.toggle('show');
        if(overlay) overlay.classList.toggle('show');
      }else{
        sidebar.classList.toggle('collapsed');
        if (sidebar.classList.contains('collapsed')) {
          main.classList.add('expanded');
        } else {
          main.classList.remove('expanded');
        }
      }
    }

    function toggleSubmenu(btn){
      const id = btn.getAttribute('aria-controls');
      const submenu = id && document.getElementById(id);
      const chev = btn.querySelector('.chevron');
      if(!submenu) return;
      const isOpen = submenu.style.display === 'block';
      submenu.style.display = isOpen ? 'none' : 'block';
      if(chev) chev.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
      btn.setAttribute('aria-expanded', String(!isOpen));
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Toggle handlers
      document.querySelectorAll('[data-sidebar-toggle]').forEach(el=>{
        el.addEventListener('click', toggleSidebar);
      });
      document.querySelectorAll('[data-sidebar-overlay]').forEach(el=>{
        el.addEventListener('click', toggleSidebar);
      });
      document.querySelectorAll('[data-submenu-toggle]').forEach(btn=>{
        btn.addEventListener('click', () => toggleSubmenu(btn));
      });

      // Responsive state corrections
      window.addEventListener('resize',()=>{
        const sidebar=document.getElementById('sidebar'),
              overlay=document.querySelector('[data-sidebar-overlay]'),
              main=document.getElementById('mainContent');
        if(!sidebar || !main) return;
        if(window.innerWidth>768){
          sidebar.classList.remove('show');
          if(overlay) overlay.classList.remove('show');
          if (sidebar.classList.contains('collapsed')) {
            main.classList.add('expanded');
          } else {
            main.classList.remove('expanded');
          }
        }else{
          sidebar.classList.remove('collapsed');
          main.classList.remove('expanded');
        }
      });

      // Auto-open the correct submenu (based on the server-rendered active link)
      (function(){
        const active = document.querySelector('.nav-item.active');
        if (!active) return;
        const submenu = active.closest('.submenu');
        if (submenu) {
          submenu.style.display='block';
          const parentBtn=submenu.previousElementSibling;
          if(parentBtn){
            const chev=parentBtn.querySelector('.chevron');
            if(chev) chev.style.transform='rotate(180deg)';
            parentBtn.setAttribute('aria-expanded','true');
          }
        }
      })();

      // Persist sidebar collapsed state on desktop
      try{
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('mainContent');
        const KEY='ems:sidebar-collapsed';
        if (window.innerWidth>768 && localStorage.getItem(KEY)==='1') {
          sidebar?.classList.add('collapsed');
          main?.classList.add('expanded');
        }
        document.querySelectorAll('[data-sidebar-toggle]').forEach(el=>{
          el.addEventListener('click', ()=>{
            if (window.innerWidth>768) {
              // store the state AFTER toggle
              setTimeout(()=>{
                const nowCollapsed = sidebar?.classList.contains('collapsed');
                localStorage.setItem(KEY, nowCollapsed ? '1' : '0');
              }, 0);
            }
          });
        });
      }catch(_) {}
    });
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
