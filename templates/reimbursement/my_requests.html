{# templates/reimbursement/my_requests.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}My Requests{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>My Requests</h2>
  <div class="d-flex gap-2">
    <a href="{% url 'reimbursement:expense_inbox' %}" class="btn btn-outline-secondary btn-sm">
      Upload Expenses
    </a>
    <a href="{% url 'reimbursement:create_request' %}" class="btn btn-primary btn-sm">
      New Request
    </a>
  </div>
</div>

{# Filter bar ----------------------------------------------------------- #}
<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-sm-4 col-md-3">
        <label class="form-label small mb-1">Status</label>
        {{ filter_form.status }}
      </div>
      <div class="col-sm-4 col-md-3">
        <label class="form-label small mb-1">From date</label>
        {{ filter_form.from_date }}
      </div>
      <div class="col-sm-4 col-md-3">
        <label class="form-label small mb-1">To date</label>
        {{ filter_form.to_date }}
      </div>
      <div class="col-12 col-md-3 text-md-end mt-2 mt-md-0">
        <button type="submit" class="btn btn-primary btn-sm me-2">
          Apply Filter
        </button>
        {% if has_active_filter %}
          <a href="?clear=1" class="btn btn-outline-secondary btn-sm">
            Clear Filter
          </a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>My Requests</span>
    <div class="d-flex align-items-center gap-3">
      {% if has_active_filter %}
        <span class="badge bg-info-subtle text-info-emphasis border d-none d-md-inline-block">
          Filter active
        </span>
      {% endif %}
      <span class="text-muted small">Latest first</span>
      <button type="button"
              class="btn btn-outline-danger btn-sm"
              id="bulkDeleteBtn"
              disabled>
        Delete Selected
      </button>
    </div>
  </div>

  <form id="bulkDeleteForm"
        method="post"
        action="{% url 'reimbursement:bulk_delete' %}">
    {% csrf_token %}
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:4%;">
              <input type="checkbox"
                     id="selectAll"
                     class="form-check-input"
                     aria-label="Select all requests">
            </th>
            <th style="width:6%;">ID</th>
            <th style="width:18%;">Submitted On</th>
            <th style="width:18%;">Status</th>
            <th style="width:14%;">Manager</th>
            <th style="width:14%;">Management</th>
            <th style="width:10%;">Total Amount</th>
            <th style="width:8%;">Paid On</th>
            <th style="width:18%;" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if requests %}
            {% for req in requests %}
            <tr>
              <td>
                <input type="checkbox"
                       class="form-check-input request-checkbox"
                       name="request_ids"
                       value="{{ req.id }}"
                       aria-label="Select reimbursement #{{ req.id }}">
              </td>
              <td>#{{ req.id }}</td>
              <td>
                {% if req.submitted_at %}
                  {{ req.submitted_at|date:"Y-m-d H:i" }}
                {% else %}
                  {{ req.created_at|date:"Y-m-d H:i" }}
                {% endif %}
              </td>
              <td>
                <span class="badge bg-light text-dark border">
                  {{ req.get_status_display }}
                </span>
              </td>
              <td>
                {% if req.manager %}
                  {{ req.manager.get_full_name|default:req.manager.username }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if req.management %}
                  {{ req.management.get_full_name|default:req.management.username }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>₹{{ req.total_amount|floatformat:2 }}</td>
              <td>
                {% if req.paid_at %}
                  {{ req.paid_at|date:"Y-m-d" }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-end">
                <div class="btn-group btn-group-sm" role="group">
                  <a href="{% url 'reimbursement:reimbursement_detail' req.id %}"
                     class="btn btn-outline-primary">
                    View
                  </a>

                  {# Employee cannot edit: no Edit button here #}
                  <form method="post"
                        action="{% url 'reimbursement:request_delete' req.id %}"
                        class="d-inline mb-0">
                    {% csrf_token %}
                    <button type="submit"
                            class="btn btn-outline-danger"
                            onclick="return confirm('Are you sure you want to delete this reimbursement request?');">
                      Delete
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">
                You haven’t submitted any reimbursement requests yet.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </form>
</div>

{# Confirmation modal for bulk delete #}
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkDeleteModalLabel">Confirm Bulk Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete all selected reimbursement requests?
        Paid requests will not be deleted.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger btn-sm" id="confirmBulkDeleteBtn">
          Delete Selected
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.request-checkbox');
    const bulkBtn = document.getElementById('bulkDeleteBtn');
    const confirmBtn = document.getElementById('confirmBulkDeleteBtn');
    const form = document.getElementById('bulkDeleteForm');

    function updateBulkButtonState() {
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
      bulkBtn.disabled = !anyChecked;
    }

    if (selectAll) {
      selectAll.addEventListener('change', function () {
        const checked = this.checked;
        checkboxes.forEach(cb => { cb.checked = checked; });
        updateBulkButtonState();
      });
    }

    checkboxes.forEach(cb => {
      cb.addEventListener('change', function () {
        if (!this.checked && selectAll.checked) {
          selectAll.checked = false;
        }
        updateBulkButtonState();
      });
    });

    if (bulkBtn) {
      bulkBtn.addEventListener('click', function () {
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        if (!anyChecked) {
          return;
        }
        const modalEl = document.getElementById('bulkDeleteModal');
        if (!modalEl || typeof bootstrap === 'undefined') {
          if (confirm('Delete selected reimbursement requests?')) {
            form.submit();
          }
          return;
        }
        const m = new bootstrap.Modal(modalEl);
        m.show();
      });
    }

    if (confirmBtn) {
      confirmBtn.addEventListener('click', function () {
        if (form) {
          form.submit();
        }
      });
    }

    updateBulkButtonState();
  });
</script>
{% endblock %}
