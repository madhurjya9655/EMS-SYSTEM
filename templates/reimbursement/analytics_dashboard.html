{% extends "base.html" %}
{% load static %}

{% block title %}Reimbursement Analytics · BOS Lakshya{% endblock %}

{% block head_extra %}
<style>
  /* ---------- Layout ---------- */
  .analytics-wrap{display:grid;grid-template-columns:1fr 3fr;gap:1rem}
  @media (max-width: 1400px){ .analytics-wrap{grid-template-columns:1fr 2.25fr} }
  @media (max-width: 1200px){ .analytics-wrap{grid-template-columns:1fr 2fr} }
  @media (max-width: 992px){ .analytics-wrap{grid-template-columns:1fr} }

  /* ---------- KPI Grid ---------- */
  .kpi-grid{
    display:grid;
    grid-template-columns:repeat(6,1fr);
    gap:.75rem
  }
  @media (max-width:1200px){ .kpi-grid{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:576px){ .kpi-grid{grid-template-columns:repeat(2,1fr)} }

  .kpi-tile{
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:.9rem;
    display:flex;
    flex-direction:column;
    min-height:84px;
  }
  .kpi-label{font-size:.78rem;color:var(--muted);line-height:1.2}
  .kpi-value{
    font-weight:700;
    font-size:1.1rem;
    margin-top:.25rem;
    min-height:1.25em;
    display:flex;
    align-items:center
  }

  /* ---------- Pills / Helpers ---------- */
  .pill{
    display:inline-block;
    padding:.25rem .6rem;
    border-radius:999px;
    border:1px solid var(--border);
    font-size:.8rem;
    background:var(--surface)
  }

  /* ---------- Filters ---------- */
  .filters{min-width:0}
  .filters .form-label{font-size:.85rem;color:var(--muted)}
  .filters .form-control,.filters .form-select{height:40px; min-width:0}
  .filters .form-select[multiple]{height:auto;min-height:172px;padding:.4rem .6rem}
  .filters .btn{height:40px}
  .help{font-size:.8rem;color:var(--muted)}

  /* ---------- Skeleton ---------- */
  .skeleton{position:relative;color:transparent !important}
  .skeleton::after{
    content:"";position:absolute;inset:0;
    background:linear-gradient(90deg, rgba(148,163,184,.15) 25%, rgba(148,163,184,.25) 37%, rgba(148,163,184,.15) 63%);
    background-size:400% 100%;animation:shimmer 1.2s ease-in-out infinite;border-radius:6px;
  }
  @keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}

  /* ---------- Tables ---------- */
  .table thead th{white-space:nowrap}
  .table td,.table th{vertical-align:middle}
</style>
{% endblock %}

{% block content %}

<div class="page-header">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div>
      <h1 class="page-title mb-0">Reimbursement Analytics</h1>
      <small class="text-muted">Approved / Paid datasets • IST</small>
    </div>
    <div class="text-muted small">
      <span class="pill">Read-only</span>
      <span class="pill">Bill-wise truth</span>
    </div>
  </div>
</div>

<div class="analytics-wrap">
  <!-- Filters (Issue 11: preset/granularity/date/category removed) -->
  <div class="card filters">
    <div class="card-body">
      <form id="filtersForm">
        <div class="mb-3">
          <label class="form-label" for="status">Status</label>
          <select id="status" class="form-select">
            <option value="approved_and_paid">Approved + Paid (default)</option>
            <option value="approved_only">Approved only</option>
            <option value="paid_only">Paid only</option>
          </select>
        </div>

        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <label class="form-label mb-0" for="employees">Employees</label>
            <button type="button" id="empClear" class="btn btn-outline-secondary btn-sm">Clear</button>
          </div>
          <!-- Populated from EmployeeOptionsAPI (Issue 10) -->
          <select id="employees" class="form-select" multiple size="8" aria-describedby="empHelp"></select>
          <div id="empHelp" class="help">Hold Ctrl/Cmd to select multiple</div>
        </div>

        <div class="mb-3">
          <label class="form-label" for="line_ids">Bill Line IDs (CSV)</label>
          <input type="text" id="line_ids" class="form-control" placeholder="Optional: e.g. 101,102,205">
          <div class="help">When provided, analytics recompute strictly over these bills (Issue 14).</div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="submit" class="btn btn-primary flex-grow-1">Apply</button>
          <button type="button" id="clearBtn" class="btn btn-outline-secondary">Reset</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main -->
  <div>
    <!-- KPIs (only what backend exposes + simple derived) -->
    <div class="kpi-grid mb-3" aria-live="polite" aria-busy="true">
      <div class="kpi-tile">
        <div class="kpi-label">Total Spend</div>
        <div class="kpi-value skeleton" id="kpiTotal">—</div>
      </div>
      <div class="kpi-tile">
        <div class="kpi-label">Highest Bill</div>
        <div class="kpi-value skeleton" id="kpiHiBill">—</div>
      </div>
      <div class="kpi-tile">
        <div class="kpi-label">Lowest Bill</div>
        <div class="kpi-value skeleton" id="kpiLoBill">—</div>
      </div>
      <div class="kpi-tile">
        <div class="kpi-label">Highest Spender</div>
        <div class="kpi-value skeleton" id="kpiTop">—</div>
      </div>
      <div class="kpi-tile">
        <div class="kpi-label">Lowest Spender</div>
        <div class="kpi-value skeleton" id="kpiBottom">—</div>
      </div>
      <div class="kpi-tile">
        <div class="kpi-label">Employees Included</div>
        <div class="kpi-value skeleton" id="kpiEmpCount">—</div>
      </div>
    </div>

    <!-- Employee Table -->
    <div class="card">
      <div class="card-header"><strong>Employee Spend Analysis</strong></div>
      <div class="card-body">
        <div id="top5Pills" class="d-flex flex-wrap gap-2 mb-2"></div>
        <div class="table-responsive" style="max-height:420px">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>Employee</th>
                <th>Total Amount</th>
                <th># Requests</th>
                <th>Top Category</th>
              </tr>
            </thead>
            <tbody id="empBody">
              <tr>
                <td colspan="4" class="text-muted">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /wrap -->

{% endblock %}

{% block extra_js %}
<script>
  const fmtMoney = v => '₹' + (Number(v||0)).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  const qs = (id) => document.getElementById(id);

  // URL params
  function readParams() {
    const p = new URLSearchParams(location.search);
    return {
      status: p.get('status') || 'approved_and_paid',
      employees: p.get('employees') || '',          // CSV of IDs
      line_ids: p.get('line_ids') || ''             // CSV of ReimbursementLine PKs
    };
  }
  function writeParams(params) {
    const p = new URLSearchParams();
    Object.entries(params).forEach(([k,v]) => { if (v) p.set(k, v); });
    const url = location.pathname + (p.toString() ? '?' + p.toString() : '');
    history.replaceState(null, '', url);
  }

  // Form <> params
  function setFormFromParams(params) {
    qs('status').value = params.status;
    qs('line_ids').value = params.line_ids;
    // employees (multi) will be selected after options load
  }
  function getFormParams() {
    const empIds = [...qs('employees').selectedOptions].map(o => o.value).join(',');
    return {
      status: qs('status').value,
      employees: empIds,
      line_ids: (qs('line_ids').value || '').replace(/\s+/g,'')
    };
  }

  // Fetch helper
  async function fetchJSON(url, params) {
    const p = new URLSearchParams(params || {});
    const res = await fetch(url + (p.toString() ? '?' + p.toString() : ''), { credentials: 'same-origin' });
    if (!res.ok) throw new Error('Request failed: ' + res.status);
    return await res.json();
  }

  // Skeleton toggling
  function clearSkeleton(...ids){
    ids.forEach(id => {
      const el = qs(id);
      if (!el) return;
      el.classList.remove('skeleton');
      el.setAttribute('aria-busy', 'false');
    });
    const kpiWrap = document.querySelector('.kpi-grid');
    if (kpiWrap) kpiWrap.setAttribute('aria-busy', 'false');
  }

  // Load employee options for multiselect (Issue 10)
  async function loadEmployeeOptions(preselectCsv){
    const opts = await fetchJSON("{% url 'reimbursement:analytics_api_employee_options' %}");
    const sel = qs('employees');
    sel.innerHTML = (opts || []).map(o => `<option value="${o.id}">${o.name}</option>`).join('');
    if (preselectCsv){
      const set = new Set(preselectCsv.split(',').filter(Boolean));
      [...sel.options].forEach(o => o.selected = set.has(String(o.value)));
    }
  }

  async function loadAll() {
    const p = readParams();
    setFormFromParams(p);
    await loadEmployeeOptions(p.employees);

    const common = {
      status: p.status,
      employees: p.employees,
      line_ids: p.line_ids
    };

    // Summary KPIs (Issue 13)
    const k = await fetchJSON("{% url 'reimbursement:analytics_api_summary' %}", common);
    qs('kpiTotal').textContent  = fmtMoney(k.total_spend || 0);
    qs('kpiHiBill').textContent = fmtMoney(k.highest_spend_bill || 0);
    qs('kpiLoBill').textContent = fmtMoney(k.lowest_spend_bill || 0);
    qs('kpiTop').textContent    = k.highest_spender ? `${k.highest_spender.employee_name} — ${fmtMoney(k.highest_spender.total)}` : '—';
    qs('kpiBottom').textContent = k.lowest_spender ? `${k.lowest_spender.employee_name} — ${fmtMoney(k.lowest_spender.total)}` : '—';
    const empCount = (k.employee_wise_spend || []).length;
    qs('kpiEmpCount').textContent = String(empCount);
    clearSkeleton('kpiTotal','kpiHiBill','kpiLoBill','kpiTop','kpiBottom','kpiEmpCount');

    // Employee table (Issue 14: recomputed by server using same filters)
    const emp = await fetchJSON("{% url 'reimbursement:analytics_api_employees' %}", common);

    // Top 5 pills from rows
    const rows = emp.rows || [];
    const top5 = rows.slice(0,5);
    const pills = top5.map(r => `<span class="pill">${r.employee_name}: ${fmtMoney(r.total)}</span>`).join('');
    qs('top5Pills').innerHTML = pills || '<span class="text-muted">No data</span>';

    qs('empBody').innerHTML = rows.map(r => `
      <tr>
        <td>${r.employee_name}</td>
        <td>${fmtMoney(r.total)}</td>
        <td>${r.request_count}</td>
        <td>${r.top_category || '-'}</td>
      </tr>
    `).join('') || `<tr><td colspan="4" class="text-muted">No data</td></tr>`;
  }

  // Form interactions
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('filtersForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const params = { ...readParams(), ...getFormParams() };
      writeParams(params);
      loadAll().catch(err => {
        console.error(err);
        alert('Failed to load analytics.');
      });
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      const cleared = { status:'approved_and_paid' };
      writeParams(cleared);
      location.reload();
    });

    document.getElementById('empClear').addEventListener('click', () => {
      [...qs('employees').options].forEach(o => o.selected = false);
    });

    // Boot
    const current = readParams();
    if (!current.status) current.status = 'approved_and_paid';
    writeParams(current);
    loadAll().catch(err => {
      console.error(err);
      alert('Failed to load analytics.');
    });
  });
</script>
{% endblock %}
