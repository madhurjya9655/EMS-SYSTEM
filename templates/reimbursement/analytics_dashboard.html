{% extends "base.html" %}
{% load static %}

{% block title %}Reimbursement Analytics · BOS Lakshya{% endblock %}

{% block head_extra %}
<style>
  /* ---------- Layout ---------- */
  .analytics-wrap{display:grid;grid-template-columns:1fr 3fr;gap:1rem}
  @media (max-width: 1400px){ .analytics-wrap{grid-template-columns:1fr 2.25fr} }
  @media (max-width: 1200px){ .analytics-wrap{grid-template-columns:1fr 2fr} }
  @media (max-width: 992px){ .analytics-wrap{grid-template-columns:1fr} }

  /* ---------- KPI Grid ---------- */
  .kpi-grid{
    display:grid;
    grid-template-columns:repeat(6,1fr);
    gap:.75rem
  }
  @media (max-width:1200px){ .kpi-grid{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:576px){ .kpi-grid{grid-template-columns:repeat(2,1fr)} }

  .kpi-tile{
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:.9rem;
    display:flex;
    flex-direction:column;
    min-height:84px;
  }
  .kpi-label{font-size:.78rem;color:var(--muted);line-height:1.2}
  .kpi-value{
    font-weight:700;
    font-size:1.1rem;
    margin-top:.25rem;
    min-height:1.25em;
    display:flex;
    align-items:center
  }

  /* ---------- Pills / Helpers ---------- */
  .pill{
    display:inline-block;
    padding:.25rem .6rem;
    border-radius:999px;
    border:1px solid var(--border);
    font-size:.8rem;
    background:var(--surface)
  }

  /* ---------- Filters ---------- */
  .filters{min-width:0}
  .filters .form-label{font-size:.85rem;color:var(--muted)}
  .filters .form-control,.filters .form-select{height:40px; min-width:0}
  .filters .btn{height:40px}
  .help{font-size:.8rem;color:var(--muted)}

  /* ---------- Skeleton ---------- */
  .skeleton{position:relative;color:transparent !important}
  .skeleton::after{
    content:"";position:absolute;inset:0;
    background:linear-gradient(90deg, rgba(148,163,184,.15) 25%, rgba(148,163,184,.25) 37%, rgba(148,163,184,.15) 63%);
    background-size:400% 100%;animation:shimmer 1.2s ease-in-out infinite;border-radius:6px;
  }
  @keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}

  /* ---------- Tables ---------- */
  .table thead th{white-space:nowrap}
  .table td,.table th{vertical-align:middle}

  /* ---------- Chart (no external lib) ---------- */
  .chart-card .legend .pill{white-space:nowrap}
  .chart-bars{max-height:420px;overflow:auto}
  .chart-row{display:grid;grid-template-columns:180px 1fr;gap:.75rem;align-items:center;margin-bottom:.6rem}
  .chart-name{font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chart-bar{
    position:relative;height:28px;border:1px solid var(--border);border-radius:6px;background:#f8fafc;
  }
  .chart-fill{
    position:absolute;left:0;top:0;bottom:0;border-radius:6px;
    background:rgba(13,110,253,.35); /* bootstrap primary-ish with transparency */
  }
  .chart-val{
    position:absolute;right:8px;top:50%;transform:translateY(-50%);
    font-size:.85rem;font-weight:600;color:#0b1324
  }
  .chart-empty{color:#6b7280;padding:.5rem 0}
</style>
{% endblock %}

{% block content %}

<div class="page-header">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div>
      <h1 class="page-title mb-0">Reimbursement Analytics</h1>
      <small class="text-muted">Approved / Paid datasets • IST</small>
    </div>
    <div class="text-muted small">
      <span class="pill">Read-only</span>
      <span class="pill">Bill-wise truth</span>
    </div>
  </div>
</div>

<div class="analytics-wrap">
  <!-- Filters (Issue 15: time/category/high-risk filters are NOT shown; UI-only removal) -->
  <div class="card filters">
    <div class="card-body">
      <form id="filtersForm">
        <div class="mb-3">
          <label class="form-label" for="status">Status</label>
          <select id="status" class="form-select">
            <option value="approved_and_paid">Approved + Paid (default)</option>
            <option value="approved_only">Approved only</option>
            <option value="paid_only">Paid only</option>
          </select>
        </div>

        <!-- CHANGED: Employees now a normal dropdown (single select) -->
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <label class="form-label mb-0" for="employees">Employee</label>
            <button type="button" id="empClear" class="btn btn-outline-secondary btn-sm">Clear</button>
          </div>
          <!-- Populated from EmployeeOptionsAPI; includes "All employees" option -->
          <select id="employees" class="form-select" aria-describedby="empHelp"></select>
          <div id="empHelp" class="help">Leave blank for all employees.</div>
        </div>

        <div class="mb-3">
          <label class="form-label" for="line_ids">Bill Line IDs (CSV)</label>
          <input type="text" id="line_ids" class="form-control" placeholder="Optional: e.g. 101,102,205">
          <div class="help">When provided, analytics (incl. chart) recompute strictly over these bills.</div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="submit" class="btn btn-primary flex-grow-1">Apply</button>
          <button type="button" id="clearBtn" class="btn btn-outline-secondary">Reset</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main -->
  <div>
    <!-- KPIs -->
    <div class="kpi-grid mb-3" aria-live="polite" aria-busy="true">
      <div class="kpi-tile">
        <div class="kpi-label">Total Spend</div>
        <div class="kpi-value skeleton" id="kpiTotal">—</div>
      </div>
      <div class="kpi-tile">
        <div class="kpi-label">Highest Bill</div>
        <div class="kpi-value skeleton" id="kpiHiBill">—</div>
      </div>
      <div class="kpi-tile">
        <div class="kpi-label">Lowest Bill</div>
        <div class="kpi-value skeleton" id="kpiLoBill">—</div>
      </div>
      <div class="kpi-tile">
        <div class="kpi-label">Highest Spender</div>
        <div class="kpi-value skeleton" id="kpiTop">—</div>
      </div>
      <div class="kpi-tile">
        <div class="kpi-label">Lowest Spender</div>
        <div class="kpi-value skeleton" id="kpiBottom">—</div>
      </div>
      <div class="kpi-tile">
        <div class="kpi-label">Employees Included</div>
        <div class="kpi-value skeleton" id="kpiEmpCount">—</div>
      </div>
    </div>

    <!-- Spend Chart (Employee-wise) -->
    <div class="card chart-card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Spend Chart (Employee-wise)</strong>
        <small class="text-muted">Updates with filters &amp; Bill Line IDs</small>
      </div>
      <div class="card-body">
        <div class="legend d-flex flex-wrap gap-2 mb-3">
          <span class="pill" id="chartTotal">Total: —</span>
          <span class="pill" id="chartHigh">Highest Spender: —</span>
          <span class="pill" id="chartLow">Lowest Spender: —</span>
        </div>
        <div id="empChart" class="chart-bars" role="list" aria-label="Spend per employee">
          <div class="chart-empty">Loading chart…</div>
        </div>
      </div>
    </div>

    <!-- Employee Table -->
    <div class="card">
      <div class="card-header"><strong>Employee Spend Analysis</strong></div>
      <div class="card-body">
        <div id="top5Pills" class="d-flex flex-wrap gap-2 mb-2"></div>
        <div class="table-responsive" style="max-height:420px">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>Employee</th>
                <th>Total Amount</th>
                <th># Requests</th>
                <th>Top Category</th>
              </tr>
            </thead>
            <tbody id="empBody">
              <tr>
                <td colspan="4" class="text-muted">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /wrap -->

{% endblock %}

{% block extra_js %}
<script>
  const fmtMoney = v => '₹' + (Number(v||0)).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  const qs = (id) => document.getElementById(id);

  // URL params
  function readParams() {
    const p = new URLSearchParams(location.search);
    return {
      status: p.get('status') || 'approved_and_paid',
      // Backward compatible: could be CSV; if so we keep as-is for API, but UI will preselect the first one.
      employees: p.get('employees') || '',
      line_ids: p.get('line_ids') || ''
    };
  }
  function writeParams(params) {
    const p = new URLSearchParams();
    Object.entries(params).forEach(([k,v]) => { if (v) p.set(k, v); });
    const url = location.pathname + (p.toString() ? '?' + p.toString() : '');
    history.replaceState(null, '', url);
  }

  // Form <> params
  function setFormFromParams(params) {
    qs('status').value = params.status;
    qs('line_ids').value = params.line_ids;
    // employee dropdown selection is applied inside loadEmployeeOptions()
  }
  function getFormParams() {
    // Single-select dropdown now
    const empId = (qs('employees').value || '').trim();
    return {
      status: qs('status').value,
      employees: empId,                                // still passes CSV-friendly single id (backend unchanged)
      line_ids: (qs('line_ids').value || '').replace(/\s+/g,'')
    };
  }

  // Fetch helper
  async function fetchJSON(url, params) {
    const p = new URLSearchParams(params || {});
    const res = await fetch(url + (p.toString() ? '?' + p.toString() : ''), { credentials: 'same-origin' });
    if (!res.ok) throw new Error('Request failed: ' + res.status);
    return await res.json();
  }

  // Skeleton toggling
  function clearSkeleton(...ids){
    ids.forEach(id => {
      const el = qs(id);
      if (!el) return;
      el.classList.remove('skeleton');
      el.setAttribute('aria-busy', 'false');
    });
    const kpiWrap = document.querySelector('.kpi-grid');
    if (kpiWrap) kpiWrap.setAttribute('aria-busy', 'false');
  }

  // Load employee options for dropdown
  async function loadEmployeeOptions(preselectCsv){
    const opts = await fetchJSON("{% url 'reimbursement:analytics_api_employee_options' %}");
    const sel = qs('employees');

    // Build options: first is "All employees"
    let html = `<option value="">All employees</option>`;
    html += (opts || []).map(o => `<option value="${o.id}">${o.name}</option>`).join('');
    sel.innerHTML = html;

    if (preselectCsv){
      // If CSV passed, pick first ID to preselect for the single dropdown (backward compatible)
      const firstId = preselectCsv.split(',').map(s => s.trim()).filter(Boolean)[0] || '';
      sel.value = firstId;
    }
  }

  // SIMPLE BAR CHART (no external library)
  function renderChart(employeeTotals, summary){
    const wrap = qs('empChart');
    wrap.innerHTML = '';

    const list = employeeTotals || [];
    const maxVal = list.reduce((m, r) => Math.max(m, Number(r.total||0)), 0);

    // Pills
    qs('chartTotal').textContent = 'Total: ' + fmtMoney(summary.total_spend || 0);
    if (summary.highest_spender){
      qs('chartHigh').textContent = `Highest Spender: ${summary.highest_spender.employee_name} — ${fmtMoney(summary.highest_spender.total)}`;
    } else {
      qs('chartHigh').textContent = 'Highest Spender: —';
    }
    if (summary.lowest_spender){
      qs('chartLow').textContent = `Lowest Spender: ${summary.lowest_spender.employee_name} — ${fmtMoney(summary.lowest_spender.total)}`;
    } else {
      qs('chartLow').textContent = 'Lowest Spender: —';
    }

    if (!list.length || maxVal <= 0){
      wrap.innerHTML = '<div class="chart-empty">No data to show.</div>';
      return;
    }

    // Show up to 20 rows; still scrollable if more
    list.slice(0, 20).forEach(r => {
      const row = document.createElement('div');
      row.className = 'chart-row';
      row.setAttribute('role','listitem');

      // Name
      const name = document.createElement('div');
      name.className = 'chart-name';
      name.textContent = r.employee_name || ('User #' + (r.employee_id||''));
      row.appendChild(name);

      // Bar
      const bar = document.createElement('div');
      bar.className = 'chart-bar';
      const fill = document.createElement('div');
      fill.className = 'chart-fill';
      const val = Number(r.total||0);
      const pct = Math.max(3, Math.min(100, (val / maxVal) * 100)); // min 3% visible
      fill.style.width = pct.toFixed(2) + '%';

      const label = document.createElement('div');
      label.className = 'chart-val';
      label.textContent = fmtMoney(val);

      bar.appendChild(fill);
      bar.appendChild(label);
      row.appendChild(bar);

      wrap.appendChild(row);
    });
  }

  async function loadAll() {
    const p = readParams();
    setFormFromParams(p);
    await loadEmployeeOptions(p.employees);

    const common = {
      status: p.status,
      employees: p.employees, // passes the (possibly blank) single id; backend accepts CSV-style too
      line_ids: p.line_ids
    };

    // Summary KPIs
    const k = await fetchJSON("{% url 'reimbursement:analytics_api_summary' %}", common);
    qs('kpiTotal').textContent  = fmtMoney(k.total_spend || 0);
    qs('kpiHiBill').textContent = fmtMoney(k.highest_spend_bill || 0);
    qs('kpiLoBill').textContent = fmtMoney(k.lowest_spend_bill || 0);
    qs('kpiTop').textContent    = k.highest_spender ? `${k.highest_spender.employee_name} — ${fmtMoney(k.highest_spender.total)}` : '—';
    qs('kpiBottom').textContent = k.lowest_spender ? `${k.lowest_spender.employee_name} — ${fmtMoney(k.lowest_spender.total)}` : '—';
    const empCount = (k.employee_wise_spend || []).length;
    qs('kpiEmpCount').textContent = String(empCount);
    clearSkeleton('kpiTotal','kpiHiBill','kpiLoBill','kpiTop','kpiBottom','kpiEmpCount');

    // Render Chart
    renderChart(k.employee_wise_spend || [], k);

    // Employee table
    const emp = await fetchJSON("{% url 'reimbursement:analytics_api_employees' %}", common);

    // Top 5 pills from rows
    const rows = emp.rows || [];
    const top5 = rows.slice(0,5);
    const pills = top5.map(r => `<span class="pill">${r.employee_name}: ${fmtMoney(r.total)}</span>`).join('');
    qs('top5Pills').innerHTML = pills || '<span class="text-muted">No data</span>';

    qs('empBody').innerHTML = rows.map(r => `
      <tr>
        <td>${r.employee_name}</td>
        <td>${fmtMoney(r.total)}</td>
        <td>${r.request_count}</td>
        <td>${r.top_category || '-'}</td>
      </tr>
    `).join('') || `<tr><td colspan="4" class="text-muted">No data</td></tr>`;
  }

  // Form interactions
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('filtersForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const params = { ...readParams(), ...getFormParams() };
      writeParams(params);
      loadAll().catch(err => {
        console.error(err);
        alert('Failed to load analytics.');
      });
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      const cleared = { status:'approved_and_paid' };
      writeParams(cleared);
      location.reload();
    });

    document.getElementById('empClear').addEventListener('click', () => {
      qs('employees').value = ''; // clear selection to "All employees"
    });

    // Boot
    const current = readParams();
    if (!current.status) current.status = 'approved_and_paid';
    writeParams(current);
    loadAll().catch(err => {
      console.error(err);
      alert('Failed to load analytics.');
    });
  });
</script>
{% endblock %}
