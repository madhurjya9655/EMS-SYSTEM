<div class="card mb-3">
  <div class="card-header">Request Summary</div>
  <div class="card-body">
    <table class="table table-sm mb-0">
      <tr>
        <th style="width:40%;">Employee</th>
        <td>
          {{ request_obj.created_by.get_full_name|default:request_obj.created_by.username }}
          <div class="small text-muted">{{ request_obj.created_by.email }}</div>
        </td>
      </tr>
      <tr>
        <th>Submitted</th>
        <td>{{ request_obj.submitted_at|default:request_obj.created_at|date:"Y-m-d H:i" }}</td>
      </tr>
      <tr>
        <th>Status</th>
        <td><span class="badge bg-light text-dark">{{ request_obj.get_status_display }}</span></td>
      </tr>
      <tr>
        <th>Total Amount</th>
        <td>₹{{ request_obj.total_amount|floatformat:2 }}</td>
      </tr>
      {% if request_obj.verified_at %}
      <tr>
        <th>Verified by Finance</th>
        <td>
          {{ request_obj.verified_at|date:"Y-m-d H:i" }}
          {% if request_obj.verified_by %}
            <div class="small text-muted">By: {{ request_obj.verified_by.get_full_name|default:request_obj.verified_by.username }}</div>
          {% endif %}
        </td>
      </tr>
      {% endif %}
      {% if request_obj.paid_at %}
      <tr>
        <th>Paid On</th>
        <td>
          {{ request_obj.paid_at|date:"Y-m-d H:i" }}
          {% if request_obj.finance_payment_reference %}
            <div class="small text-muted">Ref: {{ request_obj.finance_payment_reference }}</div>
          {% endif %}
        </td>
      </tr>
      {% endif %}
    </table>
  </div>
</div>

<div class="card">
  <div class="card-header">Expense Lines</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:50px;">#</th>
            <th style="width:110px;">Date</th>
            <th style="width:160px;">Category</th>
            <th>Description</th>
            <th class="text-end" style="width:120px;">Amount</th>
            <th style="width:90px;">Receipt</th>
            <th style="width:200px;">Bill Status</th>
          </tr>
        </thead>
        <tbody>
          {% for line in request_obj.lines.all %}
          {% if line.status == "included" %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ line.expense_item.date|date:"Y-m-d" }}</td>
            <td>{{ line.expense_item.get_category_display|default:line.expense_item.category }}</td>
            <td class="small">{{ line.description|default:line.expense_item.description|default:"-" }}</td>
            <td class="text-end">₹{{ line.amount|floatformat:2 }}</td>
            <td>
              {% if line.receipt_file or line.expense_item.receipt_file %}
                <a href="{% url 'reimbursement:receipt_line' line.id %}" target="_blank" class="btn btn-sm btn-outline-secondary">View</a>
              {% else %}
                <span class="text-muted small">No file</span>
              {% endif %}
            </td>
            <td>
              {# Manager/management-friendly status mapping #}
              {% if line.bill_status == 'finance_approved' %}
                <span class="badge bg-success">Finance Approved</span>
              {% elif line.bill_status == 'manager_pending' %}
                <span class="badge bg-primary">Pending Manager Approval</span>
              {% elif line.bill_status == 'manager_approved' %}
                <span class="badge bg-primary-subtle text-dark">Manager Approved</span>
              {% elif line.bill_status == 'employee_resubmitted' %}
                <span class="badge bg-warning text-dark">Employee Resubmitted</span>
              {% elif line.bill_status == 'paid' %}
                <span class="badge bg-success">Paid</span>
              {% elif line.bill_status == 'submitted' %}
                <span class="badge bg-secondary">Submitted</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ line.get_bill_status_display }}</span>
              {% endif %}
            </td>
          </tr>
          {% endif %}
          {% empty %}
          <tr><td colspan="7" class="text-center text-muted py-3">No expense lines.</td></tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4" class="text-end"><strong>Total</strong></td>
            <td class="text-end"><strong>₹{{ request_obj.total_amount|floatformat:2 }}</strong></td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>
