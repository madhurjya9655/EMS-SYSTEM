{% extends "base.html" %}
{% load i18n %}

{% block title %}Finance — Verification Queue{% endblock %}

{% block content %}
<div class="container" style="max-width:1100px;margin:20px auto;">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h3 mb-1">Finance — Verification Queue</h1>
      <div class="text-muted">Only requests currently awaiting Finance bill verification.</div>
    </div>

    <div class="d-flex gap-2">
      {# Prominent entry point to Rejected Bills Queue #}
      {% if FINANCE_REJECTED_RESUB_COUNT|default:0|add:0 > 0 %}
        <a class="btn btn-danger"
           href="{% url 'reimbursement:finance_rejected_bills_queue' %}">
          <i class="fa-solid fa-triangle-exclamation me-1"></i>
          Rejected Bills (Resubmitted)
          <span class="badge bg-light text-danger ms-2">{{ FINANCE_REJECTED_RESUB_COUNT }}</span>
        </a>
      {% else %}
        <a class="btn btn-outline-secondary"
           href="{% url 'reimbursement:finance_rejected_bills_queue' %}">
          Rejected Bills (Resubmitted)
        </a>
      {% endif %}
    </div>
  </div>

  {# Subtle info banner when there are resubmissions #}
  {% if FINANCE_REJECTED_RESUB_COUNT|default:0|add:0 > 0 %}
  <div class="alert alert-warning d-flex align-items-center" role="alert">
    <i class="fa-solid fa-circle-info me-2"></i>
    <div class="flex-grow-1">
      There are <strong>{{ FINANCE_REJECTED_RESUB_COUNT }}</strong> resubmitted, previously rejected bill(s) waiting in
      <a href="{% url 'reimbursement:finance_rejected_bills_queue' %}" class="alert-link">Rejected Bills Queue</a>.
      Review them to unblock manager routing.
    </div>
  </div>
  {% endif %}

  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Employee</th>
              <th>Submitted</th>
              <th>Verification</th>
              <th class="text-end">Total Amount</th>
              <th>Manager</th>
              <th style="width:220px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for req in requests %}
            <tr>
              <td>
                <a href="{% url 'reimbursement:request_detail' req.id %}">#{{ req.id }}</a>
              </td>
              <td>{{ req.created_by.get_full_name|default:req.created_by.username }}</td>
              <td>
                {% if req.submitted_at %}{{ req.submitted_at|date:"Y-m-d H:i" }}{% else %}-{% endif %}
              </td>
              <td>
                {% if req.finance_verified_all %}
                  <span class="badge bg-success">All Bills Approved</span>
                {% else %}
                  <span class="badge bg-danger">Verification pending</span>
                {% endif %}
              </td>
              <td class="text-end">₹{{ req.total_amount|floatformat:2 }}</td>
              <td>{{ req.manager.get_full_name|default:req.manager.username|default:"—" }}</td>
              <td>
                <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
                  <a class="btn btn-outline-primary"
                     href="{% url 'reimbursement:finance_verify' req.id %}">
                    View Bills
                  </a>
                  <a class="btn btn-outline-secondary"
                     href="{% url 'reimbursement:finance_review' req.id %}">
                    Review
                  </a>
                  <a class="btn btn-outline-danger"
                     href="{% url 'reimbursement:finance_delete' req.id %}">
                    Delete Request
                  </a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-3">
                No requests pending Finance verification.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
