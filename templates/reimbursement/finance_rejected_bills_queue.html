{% extends "base.html" %}
{% load i18n %}

{% block title %}Finance — Rejected Bills (Resubmitted){% endblock %}

{% block content %}
<div class="container" style="max-width:1100px;margin:20px auto;">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h3 mb-1">Finance — Rejected Bills (Resubmitted)</h1>
      <div class="text-muted">Only bills that were rejected earlier and have been corrected &amp; resubmitted by the employee.</div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'reimbursement:finance_pending' %}">
        Back to Finance Verification Queue
      </a>
    </div>
  </div>

  {% if lines %}
    <div class="alert alert-info d-flex align-items-center" role="alert">
      <i class="fa-solid fa-circle-info me-2"></i>
      <div>
        Approve the corrected bills to move them forward. Rejections will return to the employee again with your remarks.
      </div>
    </div>
  {% else %}
    <div class="alert alert-success" role="alert">
      Nothing to review here. No resubmitted rejected bills are pending.
    </div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}
    <input type="hidden" name="action" id="bulk-action" value="">
    <div class="card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:34px;"><input type="checkbox" id="chk_all"></th>
                <th>#</th>
                <th>Req&nbsp;ID</th>
                <th>Employee</th>
                <th>Type</th>
                <th>Date</th>
                <th>Description</th>
                <th class="text-end">Amount</th>
                <th>Bill</th>
                <th>Status</th>
                <th style="width:260px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for line in lines %}
              <tr>
                <td><input type="checkbox" class="line-check" name="line_ids" value="{{ line.id }}"></td>
                <td>{{ forloop.counter }}</td>
                <td>
                  <a href="{% url 'reimbursement:finance_verify' line.request_id %}"
                     title="Open request #{{ line.request_id }}">#{{ line.request_id }}</a>
                </td>
                <td>{{ line.request.created_by.get_full_name|default:line.request.created_by.username }}</td>
                <td>{{ line.expense_item.get_category_display|default:line.expense_item.category }}</td>
                <td>{{ line.expense_item.date|date:"d M Y" }}</td>
                <td style="white-space:pre-line;max-width:360px;">{{ line.description|default:line.expense_item.description|default:"-" }}</td>
                <td class="text-end">₹{{ line.amount|floatformat:2 }}</td>
                <td>
                  <a href="#" class="btn btn-link p-0 js-preview"
                     data-preview-url="{% url 'reimbursement:receipt_line' line.id %}">
                    View
                  </a>
                </td>
                <td>
                  {% if line.bill_status == line.BillStatus.EMPLOYEE_RESUBMITTED %}
                    <span class="badge bg-warning text-dark">Resubmitted</span>
                  {% elif line.bill_status == line.BillStatus.FINANCE_REJECTED %}
                    <span class="badge bg-danger">Finance Rejected</span>
                  {% elif line.bill_status == line.BillStatus.FINANCE_APPROVED %}
                    <span class="badge bg-success">Finance Approved</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ line.get_bill_status_display }}</span>
                  {% endif %}
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <button type="submit" class="btn btn-outline-success btn-sm js-one"
                            name="action" value="approve" data-line-id="{{ line.id }}">
                      Approve
                    </button>
                    <button type="submit" class="btn btn-outline-danger btn-sm js-one"
                            name="action" value="reject" data-line-id="{{ line.id }}">
                      Reject
                    </button>
                    <button type="submit" class="btn btn-outline-secondary btn-sm js-one"
                            name="action" value="delete" data-line-id="{{ line.id }}"
                            onclick="return confirm('Permanently delete this bill line? This cannot be undone.');">
                      Delete
                    </button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="11" class="text-center text-muted py-3">
                  No resubmitted rejected bills pending review.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {% if lines %}
    <div class="mt-3 d-flex flex-column gap-3">
      <div class="d-flex flex-wrap gap-2">
        <button type="submit" class="btn btn-success"
                onclick="document.getElementById('bulk-action').value='approve'">
          Approve Selected
        </button>

        <button type="submit" class="btn btn-danger"
                onclick="document.getElementById('bulk-action').value='reject'">
          Reject Selected
        </button>

        <button type="submit" class="btn btn-outline-secondary"
                onclick="document.getElementById('bulk-action').value='delete'; return confirm('Delete selected bill lines? This cannot be undone.');">
          Delete Selected
        </button>
      </div>

      <div>
        <label for="reason" class="form-label fw-semibold">Rejection remarks (used only when rejecting)</label>
        <textarea id="reason" name="reason" rows="3" class="form-control"
                  placeholder="Add a clear reason employees can act on..."></textarea>
      </div>
    </div>
    {% endif %}
  </form>
</div>

{% include "reimbursement/_bill_preview_modal.html" %}
{% endblock %}

{% block extra_js %}
<script>
  // Select all
  document.getElementById('chk_all')?.addEventListener('change', function (e) {
    document.querySelectorAll('.line-check').forEach(cb => cb.checked = e.target.checked);
  });

  // One-click per-line actions select only that line
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.js-one');
    if (!btn) return;
    const id = btn.getAttribute('data-line-id');
    if (!id) return;
    document.querySelectorAll('.line-check').forEach(cb => cb.checked = (cb.value === String(id)));
  });

  // Preview modal
  const modalEl = document.getElementById('billPreviewModal');
  const iframe  = document.getElementById('billPreviewFrame');
  document.querySelectorAll('.js-preview').forEach(a => {
    a.addEventListener('click', (ev) => {
      ev.preventDefault();
      iframe.src = a.dataset.previewUrl;
      new bootstrap.Modal(modalEl).show();
    });
  });
</script>
{% endblock %}
