{% extends "base.html" %}
{% load humanize %}

{% block title %}Finance — Settlement Queue{% endblock %}

{% block content %}
<div class="page-header mb-3">
  <h2 class="page-title">Finance — Settlement Queue</h2>
  <p class="text-muted mb-0">
    Items appear here <em>after manager/management approval</em>. Use
    <strong>Review / Settle</strong> to enter UTR / payment reference and mark Paid.
  </p>
</div>

<div class="card">
  <div class="card-body table-responsive">
    {% if requests and requests|length %}
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th scope="col">Request #</th>
            <th scope="col">Employee</th>
            <th scope="col">Status</th>
            <th scope="col" class="text-end">Total</th>
            <th scope="col">Submitted</th>
            <th scope="col">Ready to Settle</th>
            <th scope="col" class="text-end">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for r in requests %}
            <tr>
              <td><span class="text-muted">#</span>{{ r.id }}</td>
              <td>
                {% if r.created_by %}
                  <div class="fw-semibold">{{ r.created_by.get_full_name|default:r.created_by.username }}</div>
                  <div class="small text-muted">{{ r.created_by.email }}</div>
                {% else %}—{% endif %}
              </td>
              <td>
                {% if r.get_status_display %}{{ r.get_status_display }}
                {% else %}{{ r.status|title }}{% endif %}
              </td>
              <td class="text-end">
                {% if r.total_amount is not None %}₹{{ r.total_amount|floatformat:2|intcomma }}{% else %}—{% endif %}
              </td>
              <td class="text-nowrap">
                {% if r.submitted_at %}{{ r.submitted_at|date:"Y-m-d H:i" }}
                {% elif r.created_at %}{{ r.created_at|date:"Y-m-d H:i" }}
                {% else %}—{% endif %}
              </td>
              <td>
                {% if r.can_mark_paid %}
                  <span class="badge rounded-pill text-bg-success">All bills verified</span>
                {% else %}
                  <span class="badge rounded-pill text-bg-warning">Needs check</span>
                {% endif %}
              </td>
              <td class="text-end">
                <a href="{% url 'reimbursement:finance_review' r.id %}" class="btn btn-primary">
                  Review / Settle
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="text-center text-muted py-5">No requests awaiting settlement.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
