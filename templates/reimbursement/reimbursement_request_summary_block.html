{# Reusable summary block used by manager/management/finance review pages #}
<div class="card mb-3">
  <div class="card-header">
    Request Summary — #{{ request_obj.id }}
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <table class="table table-sm mb-0">
          <tr>
            <th style="width:40%;">Employee</th>
            <td>
              {{ request_obj.created_by.get_full_name|default:request_obj.created_by.username }}
              <div class="small text-muted">{{ request_obj.created_by.email }}</div>
            </td>
          </tr>
          <tr>
            <th>Submitted</th>
            <td>{{ request_obj.submitted_at|default:request_obj.created_at|date:"Y-m-d H:i" }}</td>
          </tr>
          <tr>
            <th>Status</th>
            <td>
              <span class="badge bg-light text-dark">{{ request_obj.get_status_display }}</span>
            </td>
          </tr>
          <tr>
            <th>Total Amount</th>
            <td>₹{{ request_obj.total_amount|floatformat:2 }}</td>
          </tr>
        </table>
      </div>
      <div class="col-md-6">
        <table class="table table-sm mb-0">
          <tr>
            <th style="width:40%;">Manager</th>
            <td>
              {% if request_obj.manager %}
                {{ request_obj.manager.get_full_name|default:request_obj.manager.username }}
              {% else %}<span class="text-muted">-</span>{% endif %}
            </td>
          </tr>
          <tr>
            <th>Management</th>
            <td>
              {% if request_obj.management %}
                {{ request_obj.management.get_full_name|default:request_obj.management.username }}
              {% else %}<span class="text-muted">-</span>{% endif %}
            </td>
          </tr>
          {% if request_obj.paid_at %}
          <tr>
            <th>Paid On</th>
            <td>
              {{ request_obj.paid_at|date:"Y-m-d H:i" }}
              {% if request_obj.finance_payment_reference %}
                <div class="small text-muted">Ref: {{ request_obj.finance_payment_reference }}</div>
              {% endif %}
            </td>
          </tr>
          {% endif %}
          {% if request_obj.verified_at %}
          <tr>
            <th>Verified</th>
            <td>
              {{ request_obj.verified_at|date:"Y-m-d H:i" }}
              {% if request_obj.verified_by %}
                <div class="small text-muted">By: {{ request_obj.verified_by.get_full_name|default:request_obj.verified_by.username }}</div>
              {% endif %}
            </td>
          </tr>
          {% endif %}
        </table>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header">Expense Lines</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Category</th>
            <th>Bill Type</th>
            <th>Vendor</th>
            <th>Description</th>
            <th class="text-end">Amount</th>
            <th>Receipt</th>
          </tr>
        </thead>
        <tbody>
          {% for line in request_obj.lines.all %}
          {% if line.status == "included" %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ line.expense_item.date|date:"Y-m-d" }}</td>
            <td>{{ line.expense_item.get_category_display }}</td>
            <td>
              {% if line.expense_item.gst_type %}{{ line.expense_item.get_gst_type_display }}{% else %}-{% endif %}
            </td>
            <td>{{ line.expense_item.vendor|default:"-" }}</td>
            <td class="small">{{ line.description|default:"-" }}</td>
            <td class="text-end">₹{{ line.amount|floatformat:2 }}</td>
            <td>
              {% if line.receipt_file or line.expense_item.receipt_file %}
                <a href="{% url 'reimbursement:receipt_line' line.id %}" target="_blank" class="btn btn-sm btn-outline-secondary">View</a>
              {% else %}
                <span class="text-muted small">No file</span>
              {% endif %}
            </td>
          </tr>
          {% endif %}
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted py-3">No expense lines.</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="6" class="text-end"><strong>Total</strong></td>
            <td class="text-end"><strong>₹{{ request_obj.total_amount|floatformat:2 }}</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>
