{% extends "base.html" %}
{% load humanize %}

{% block title %}Reimbursement #{{ request_obj.id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Reimbursement – Request #{{ request_obj.id }}</h2>
  <div class="d-flex gap-2">
    <a href="{% url 'reimbursement:my_reimbursements' %}" class="btn btn-outline-secondary btn-sm">Back to My Requests</a>
    {% if can_resubmit %}
      <a href="{% url 'reimbursement:request_resubmit' request_obj.id %}" class="btn btn-warning btn-sm">Resubmit Whole Request</a>
    {% endif %}
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header">Request Summary</div>
      <div class="card-body">
        <table class="table table-sm mb-0">
          <tr>
            <th style="width:40%;">Employee</th>
            <td>
              {{ request_obj.created_by.get_full_name|default:request_obj.created_by.username }}
              <div class="small text-muted">{{ request_obj.created_by.email }}</div>
            </td>
          </tr>
          <tr>
            <th>Submitted</th>
            <td>{{ request_obj.submitted_at|default:request_obj.created_at|date:"Y-m-d H:i" }}</td>
          </tr>
          <tr>
            <th>Status</th>
            <td><span class="badge bg-light text-dark">{{ request_obj.get_status_display }}</span></td>
          </tr>
          <tr>
            <th>Total Amount</th>
            <td>₹{{ request_obj.total_amount|floatformat:2 }}</td>
          </tr>
          {% if request_obj.paid_at %}
          <tr>
            <th>Paid On</th>
            <td>
              {{ request_obj.paid_at|date:"Y-m-d H:i" }}
              {% if request_obj.finance_payment_reference %}
                <div class="small text-muted">Ref: {{ request_obj.finance_payment_reference }}</div>
              {% endif %}
            </td>
          </tr>
          {% endif %}
        </table>
      </div>
    </div>

    {% if request_obj.finance_note %}
    <div class="alert alert-info">
      <strong>Finance note:</strong>
      <div class="small mb-0" style="white-space:pre-line;">{{ request_obj.finance_note }}</div>
    </div>
    {% endif %}
  </div>

  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-header">Approvers</div>
      <div class="card-body">
        <table class="table table-sm mb-0">
          <tr>
            <th style="width:40%;">Manager</th>
            <td>
              {% if request_obj.manager %}
                {{ request_obj.manager.get_full_name|default:request_obj.manager.username }}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <th>Management</th>
            <td>
              {% if request_obj.management %}
                {{ request_obj.management.get_full_name|default:request_obj.management.username }}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
          </tr>
          {% if request_obj.verified_at %}
          <tr>
            <th>Verified by Finance</th>
            <td>
              {{ request_obj.verified_at|date:"Y-m-d H:i" }}
              {% if request_obj.verified_by %}
                <div class="small text-muted">By: {{ request_obj.verified_by.get_full_name|default:request_obj.verified_by.username }}</div>
              {% endif %}
            </td>
          </tr>
          {% endif %}
        </table>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Expense Lines</span>
    <div>
      <a href="{% url 'reimbursement:expense_inbox' %}" class="btn btn-sm btn-outline-primary">Add a New Bill</a>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:50px;">#</th>
            <th style="width:110px;">Date</th>
            <th style="width:140px;">Category</th>
            <th style="width:130px;">Bill Type</th>
            <th>Description</th>
            <th class="text-end" style="width:120px;">Amount</th>
            <th style="width:90px;">Receipt</th>
            <th style="width:210px;">Bill Status</th>
            <th style="width:220px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for line in request_obj.lines.all %}
          {% if line.status == "included" %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ line.expense_item.date|date:"Y-m-d" }}</td>
            <td>{{ line.expense_item.get_category_display|default:line.expense_item.category }}</td>
            <td>
              {% if line.expense_item.gst_type %}{{ line.expense_item.get_gst_type_display }}{% else %}<span class="text-muted">-</span>{% endif %}
            </td>
            <td class="small">{{ line.description|default:line.expense_item.description|default:"-" }}</td>
            <td class="text-end">₹{{ line.amount|floatformat:2 }}</td>
            <td>
              {% if line.receipt_file or line.expense_item.receipt_file %}
                <a href="{% url 'reimbursement:receipt_line' line.id %}" target="_blank" class="btn btn-sm btn-outline-secondary">View</a>
              {% else %}
                <span class="text-muted small">No file</span>
              {% endif %}
            </td>
            <td>
              {% if line.bill_status == 'finance_rejected' %}
                <span class="badge bg-danger">Rejected by Finance</span>
                {% if line.finance_rejection_reason %}
                <div class="small text-muted mt-1" style="white-space:pre-line;">Reason: {{ line.finance_rejection_reason }}</div>
                {% endif %}
              {% elif line.bill_status == 'finance_approved' %}
                <span class="badge bg-success">Finance Approved</span>
              {% elif line.bill_status == 'pending_finance' %}
                <span class="badge bg-warning text-dark">Pending Finance</span>
              {% elif line.bill_status == 'employee_resubmitted' %}
                <span class="badge bg-warning text-dark">Employee Resubmitted</span>
              {% else %}
                <span class="badge bg-secondary">{{ line.bill_status|default:"-"|title }}</span>
              {% endif %}
            </td>
            <td>
              {% if line.bill_status == 'finance_rejected' %}
                <div class="d-flex flex-column gap-1">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'reimbursement:expense_edit' line.expense_item.id %}">Edit this Bill</a>
                  <a class="btn btn-sm btn-outline-dark" href="{% url 'reimbursement:expense_inbox' %}">Add New Bill (Replacement)</a>
                  <div class="small text-muted">After updating or adding a replacement, resubmit the request.</div>
                </div>
              {% else %}
                <span class="text-muted small">—</span>
              {% endif %}
            </td>
          </tr>
          {% endif %}
          {% empty %}
          <tr>
            <td colspan="9" class="text-center text-muted py-3">No expense lines.</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="text-end"><strong>Total</strong></td>
            <td class="text-end"><strong>₹{{ request_obj.total_amount|floatformat:2 }}</strong></td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

{% if show_partial_hold_hint %}
  <div class="alert alert-warning mt-3">
    One or more bills were rejected by Finance. Please edit the rejected bill(s) above
    or add a new replacement bill. Then resubmit the request.
  </div>
{% endif %}
{% endblock %}
