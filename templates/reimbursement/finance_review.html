{% extends "base.html" %}
{% load humanize %}

{% block title %}Finance — Review & Settle #{{ object.id }}{% endblock %}

{% block content %}
<div class="page-header mb-3 d-flex align-items-center justify-content-between">
  <h2 class="page-title">Finance — Review &amp; Settle <span class="text-muted">#{{ object.id }}</span></h2>
  <div>
    {% if back_url %}
      <a href="{{ back_url }}" class="btn btn-outline-secondary btn-sm">Back to Finance Queue</a>
    {% else %}
      {# fall back to verification queue which is known to exist #}
      <a href="{% url 'reimbursement:finance_pending' %}" class="btn btn-outline-secondary btn-sm">Back to Finance Queue</a>
    {% endif %}
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">Request Summary</div>
      <div class="card-body">
        <div class="row mb-2">
          <div class="col-sm-4 text-muted">Employee</div>
          <div class="col-sm-8">
            {% if object.created_by %}
              <div class="fw-semibold">{{ object.created_by.get_full_name|default:object.created_by.username }}</div>
              <div class="small text-muted">{{ object.created_by.email }}</div>
            {% else %}—{% endif %}
          </div>
        </div>
        <div class="row mb-2">
          <div class="col-sm-4 text-muted">Status</div>
          <div class="col-sm-8">
            {% if object.get_status_display %}{{ object.get_status_display }}{% else %}{{ object.status|title }}{% endif %}
          </div>
        </div>
        <div class="row mb-2">
          <div class="col-sm-4 text-muted">Total</div>
          <div class="col-sm-8">
            {% if object.total_amount is not None %}₹{{ object.total_amount|floatformat:2|intcomma }}{% else %}—{% endif %}
          </div>
        </div>
        <div class="row">
          <div class="col-sm-4 text-muted">Submitted</div>
          <div class="col-sm-8">
            {% if object.submitted_at %}
              {{ object.submitted_at|date:"Y-m-d H:i" }}
            {% elif object.created_at %}
              {{ object.created_at|date:"Y-m-d H:i" }}
            {% else %}
              —
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">Settlement</div>
      <div class="card-body">
        {% if can_mark_paid %}
          <div class="alert alert-success py-2 mb-3">
            All included bills are Finance-approved. You may mark as <strong>Claim Settled</strong>.
          </div>
        {% else %}
          <div class="alert alert-warning py-2 mb-3">
            Some bills still need verification. You can save notes/reference now; settlement will be blocked server-side until ready.
          </div>
        {% endif %}

        <form method="post" novalidate class="vstack gap-3">
          {% csrf_token %}
          {{ form.non_field_errors }}
          {% if back_url %}<input type="hidden" name="return" value="{{ back_url }}">{% endif %}

          <div>
            {{ form.finance_note.label_tag }}
            {{ form.finance_note }}
            {% if form.finance_note.errors %}
              <div class="text-danger small">{{ form.finance_note.errors }}</div>
            {% endif %}
          </div>

          <div>
            {{ form.finance_payment_reference.label_tag }}
            {{ form.finance_payment_reference }}
            {% if form.finance_payment_reference.errors %}
              <div class="text-danger small">{{ form.finance_payment_reference.errors }}</div>
            {% endif %}
            <div class="form-text">Bank UTR / transaction reference used for settlement.</div>
          </div>

          <div class="form-check">
            {# IMPORTANT: do not disable this checkbox; server validation decides #}
            {{ form.mark_paid }}
            <label class="form-check-label" for="{{ form.mark_paid.id_for_label }}">
              Mark as <strong>Claim Settled</strong>
            </label>
            {% if form.mark_paid.errors %}
              <div class="text-danger small">{{ form.mark_paid.errors }}</div>
            {% endif %}
            <div class="form-text">
              Tick this and provide a payment reference/UTR to mark as Settled.
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100">Save Finance Details</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
