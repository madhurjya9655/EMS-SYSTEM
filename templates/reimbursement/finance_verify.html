{% extends "base.html" %}
{% load i18n %}

{% block title %}Finance Verification – Reimbursement #{{ request_obj.id }}{% endblock %}

{% block content %}
<div class="container" style="max-width:1000px;margin:20px auto;">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 style="margin:0 0 8px 0;">Finance Verification</h1>
      <p class="text-muted" style="margin:0;">Reimbursement #{{ request_obj.id }}</p>
    </div>
    <div>
      {% if back_url %}
        <a href="{{ back_url }}" class="btn btn-outline-secondary btn-sm">Back to Finance Queue</a>
      {% else %}
        <a href="{% url 'reimbursement:finance_pending' %}" class="btn btn-outline-secondary btn-sm">Back to Finance Queue</a>
      {% endif %}
    </div>
  </div>

  <div class="card mt-3 mb-3">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div><strong>Employee:</strong> {{ request_obj.created_by.get_full_name|default:request_obj.created_by.username }}</div>
          <div><strong>Submitted:</strong> {{ request_obj.submitted_at|default:request_obj.created_at|date:"Y-m-d H:i" }}</div>
        </div>
        <div class="col-md-6">
          <div><strong>Status:</strong> {{ request_obj.get_status_display }}</div>
          <div><strong>Total:</strong> ₹{{ request_obj.total_amount|floatformat:2 }}</div>
        </div>
      </div>
      {% if request_obj.finance_note %}
      <div class="mt-2">
        <strong>Finance Note:</strong>
        <div style="white-space:pre-line">{{ request_obj.finance_note }}</div>
      </div>
      {% endif %}
    </div>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}
    {% if back_url %}<input type="hidden" name="return" value="{{ back_url }}">{% endif %}

    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:34px;"><input type="checkbox" id="chk_all"></th>
            <th>#</th>
            <th>Type</th>
            <th>Date</th>
            <th>Description</th>
            <th class="text-end">Amount</th>
            <th>Bill</th>
            <th>Bill Status</th>
            <th style="width:260px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for line in lines %}
          <tr>
            <td><input type="checkbox" name="line_ids" value="{{ line.id }}" class="line-check"></td>
            <td>{{ forloop.counter }}</td>
            <td>{{ line.expense_item.get_category_display|default:line.expense_item.category }}</td>
            <td>{{ line.expense_item.date|date:"d M Y" }}</td>
            <td style="white-space:pre-line;">{{ line.description|default:line.expense_item.description|default:"-" }}</td>
            <td class="text-end">₹{{ line.amount|floatformat:2 }}</td>
            <td>
              {% url "reimbursement:receipt_line" line.id as receipt_url %}
              {% if receipt_url %}<a href="{{ receipt_url }}" target="_blank" rel="noopener">View</a>{% else %}-{% endif %}
            </td>
            <td>
              {% if line.bill_status == "finance_approved" %}
                <span class="badge bg-success">Finance Approved</span>
              {% elif line.bill_status == "finance_rejected" %}
                <span class="badge bg-danger">Finance Rejected</span>
              {% elif line.bill_status == "employee_resubmitted" %}
                <span class="badge bg-warning text-dark">Employee Resubmitted</span>
              {% else %}
                <span class="badge bg-secondary">Pending</span>
              {% endif %}
            </td>
            <td>
              <div class="d-flex flex-wrap gap-1">
                <button type="submit" class="btn btn-outline-success btn-sm js-one" name="action" value="approve" data-line-id="{{ line.id }}">Approve</button>
                <button type="submit" class="btn btn-outline-danger btn-sm js-one" name="action" value="reject" data-line-id="{{ line.id }}">Reject</button>
                <button type="submit" class="btn btn-outline-secondary btn-sm js-one" name="action" value="delete" data-line-id="{{ line.id }}"
                  onclick="return confirm('Permanently delete this bill line? This cannot be undone.');">Delete</button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center text-muted py-3">No expense lines.</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td></td>
            <td colspan="4" class="text-end"><strong>Total</strong></td>
            <td class="text-end"><strong>₹{{ request_obj.total_amount|floatformat:2 }}</strong></td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="mt-3 d-flex flex-column gap-3">
      <div class="d-flex flex-wrap gap-2">
        <button name="action" value="approve" class="btn btn-success">Approve Selected</button>
        <button name="action" value="reject" class="btn btn-danger">Reject Selected</button>
        <button name="action" value="delete" class="btn btn-outline-secondary" onclick="return confirm('Delete selected bill lines? This cannot be undone.');">Delete Selected</button>
        <button name="action" value="finalize" class="btn btn-primary">Finalize &amp; Send to Manager (approved bills proceed)</button>
      </div>
      <div>
        <label for="reason" class="form-label fw-semibold">Rejection reason (used only when rejecting)</label>
        <textarea id="reason" name="reason" rows="3" class="form-control" placeholder="Add a clear reason employees can act on..."></textarea>
      </div>
    </div>
  </form>
</div>

<script>
  document.getElementById('chk_all')?.addEventListener('change', function (e) {
    document.querySelectorAll('.line-check').forEach(function (b) { b.checked = e.target.checked; });
  });
  function selectOnlyById(id) {
    document.querySelectorAll('.line-check').forEach(function (b) { b.checked = (b.value === String(id)); });
  }
  document.addEventListener('click', function (e) {
    var btn = e.target.closest('.js-one');
    if (!btn) return;
    var id = btn.getAttribute('data-line-id');
    if (id) selectOnlyById(id);
  });
</script>
{% endblock %}
