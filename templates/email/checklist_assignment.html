{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{ subject_prefix|default:"New Checklist Assigned" }}</title>
    <style>
      body { font-family: Arial, Helvetica, sans-serif; color:#111; line-height:1.5; }
      .btn { display:inline-block; margin-top:14px; padding:10px 14px; border:1px solid #2563eb; border-radius:6px; text-decoration:none; }
      table { border-collapse:collapse; max-width:640px; }
      td { padding:6px; vertical-align:top; }
    </style>
  </head>
  <body>
    <h2 style="margin:0 0 12px 0;">{{ subject_prefix|default:"New Checklist Assigned" }}</h2>
    <p style="margin:0 0 16px 0;">You have a new checklist task.</p>

    <table cellpadding="0" cellspacing="0" border="0">
      <tr>
        <td style="font-weight:bold; white-space:nowrap;">Task</td>
        <td>{{ task.task_name|default:"Task" }}</td>
      </tr>
      <tr>
        <td style="font-weight:bold; white-space:nowrap;">Assigned By</td>
        <td>{{ task.assign_by.get_full_name|default:task.assign_by.username|default:"System" }}</td>
      </tr>
      <tr>
        <td style="font-weight:bold; white-space:nowrap;">Assigned To</td>
        <td>{{ task.assign_to.get_full_name|default:task.assign_to.username|default:"—" }}</td>
      </tr>
      <tr>
        <td style="font-weight:bold; white-space:nowrap;">Planned Date</td>
        <td>{% if task.planned_date %}{{ task.planned_date|date:"d M, Y H:i" }}{% else %}—{% endif %}</td>
      </tr>
      <tr>
        <td style="font-weight:bold; white-space:nowrap;">Priority</td>
        <td>{{ task.get_priority_display|default:task.priority|default:"Low" }}</td>
      </tr>
      {% if task.time_per_task_minutes %}
      <tr>
        <td style="font-weight:bold; white-space:nowrap;">Estimated Time</td>
        <td>{{ task.time_per_task_minutes }} min</td>
      </tr>
      {% endif %}
      {% if task.group_name %}
      <tr>
        <td style="font-weight:bold; white-space:nowrap;">Group</td>
        <td>{{ task.group_name }}</td>
      </tr>
      {% endif %}
    </table>

    {# Defensive: only use extra_instructions if provided in context; otherwise fallback to task.message #}
    {% with ei=extra_instructions|default_if_none:"" %}
      {% if ei or task.message %}
        <div style="margin-top:16px;">
          <div style="font-weight:bold; margin-bottom:6px;">Extra Instructions</div>
          <div style="border:1px solid #e2e6ea; border-radius:6px; padding:12px 14px; background:#fff; white-space:pre-wrap;">
            {{ ei|default:task.message|linebreaksbr }}
          </div>
        </div>
      {% endif %}
    {% endwith %}

    {% if task.is_recurring %}
      <p style="margin-top:16px; color:#0a58ca;">
        <strong>Recurring:</strong> {{ task.mode }}{% if task.frequency %} (Every {{ task.frequency }} {{ task.mode|lower }}{{ task.frequency|pluralize }}){% endif %}
      </p>
    {% endif %}

    {% if complete_url %}
      <p><a class="btn" href="{{ complete_url }}">Mark as Completed</a></p>
    {% endif %}
    <p style="font-size:12px; color:#6b7280; margin-top:12px;">This is an automated reminder.</p>
  </body>
</html>
