{% extends "tasks/tasks_base.html" %}
{% load static %}
{% block title %}Checklist Tasks{% endblock %}
{% block tab_content %}

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center border-0">
    <h5 class="mb-0">Checklist Tasks</h5>
    <div>
      <a href="{% url 'tasks:add_checklist' %}" class="btn btn-sm btn-primary">Add Checklist</a>
      <a href="{% url 'tasks:bulk_upload' %}" class="btn btn-sm btn-secondary">Bulk Upload</a>
    </div>
  </div>

  <div
    class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
    data-bs-toggle="collapse"
    href="#filterPanel"
    role="button"
    aria-expanded="true"
    style="cursor:pointer;"
    data-filter-toggle
  >
    <span>FILTER</span>
    <i class="fas fa-minus" data-filter-toggle-icon></i>
  </div>

  <div id="filterPanel" class="collapse show">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-2">
          <label class="form-label">Keyword</label>
          <input type="text" name="keyword" class="form-control" value="{{ request.GET.keyword }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Assign To</label>
          <select name="assign_to" class="form-select">
            <option value="">All</option>
            {% for user in users %}
              <option value="{{ user.id }}"{% if request.GET.assign_to == user.id|stringformat:"s" %} selected{% endif %}>
                {{ user.get_full_name|default:user.username }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Priority</label>
          <select name="priority" class="form-select">
            <option value="">All</option>
            {% for code,label in priority_choices %}
              <option value="{{ code }}"{% if request.GET.priority == code %} selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Group Name</label>
          <select name="group_name" class="form-select">
            <option value="">All</option>
            {% for g in group_names %}
              <option value="{{ g }}"{% if request.GET.group_name == g %} selected{% endif %}>{{ g }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Start Date</label>
          <input type="date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">End Date</label>
          <input type="date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
        </div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-primary">FILTER</button>
          <a href="{% url 'tasks:list_checklist' %}" class="btn btn-warning">RESET FILTER</a>
          <button type="submit" name="download" value="1" class="btn btn-success">DOWNLOAD CSV</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="table-responsive">
  <!-- Single BULK form for the page -->
  <form method="post" action="{% url 'tasks:list_checklist' %}" data-bulk>
    {% csrf_token %}
    <input type="hidden" name="action" value="bulk_delete">

    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:32px;">
            <input type="checkbox" aria-label="Select all" data-select-all>
          </th>
          <th>Task Name</th>
          <th>Message</th>
          <th>Assign To</th>
          <th>Frequency</th>
          <th>Planned Date</th>
          <th>Remind Before Days</th>
          <th>Reminder</th>
          <th style="width:210px;">Action</th>
        </tr>
      </thead>
      <tbody>
        {% if items %}
          {% for obj in items %}
            <tr>
              <td>
                <input type="checkbox" name="sel" value="{{ obj.id }}" class="form-check-input" data-row-check aria-label="Select row">
              </td>
              <td>{{ obj.task_name }}</td>
              <td style="max-width:280px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                  title="{{ obj.message|default:'-' }}">
                {{ obj.message|default:"—"|truncatechars:80 }}
              </td>
              <td>{{ obj.assign_to.get_full_name|default:obj.assign_to.username }}</td>
              <td>
                {% if obj.mode and obj.frequency %}
                  Every {{ obj.frequency }} {{ obj.mode }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td title="{{ obj.planned_date|date:'Y-m-d H:i' }}">{{ obj.planned_date|date:"d M, Y h:i A" }}</td>
              <td>{{ obj.remind_before_days|default:"0" }}</td>
              <td>
                {% if obj.set_reminder %}
                  {{ obj.reminder_mode|default:"" }}{% if obj.reminder_frequency %} ({{ obj.reminder_frequency }}){% endif %}
                  {% if obj.reminder_starting_time %}@ {{ obj.reminder_starting_time|time:"h:i A" }}{% endif %}
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="text-nowrap">
                <a href="{% url 'tasks:edit_checklist' obj.id %}" class="btn btn-sm btn-outline-secondary" title="Edit">
                  <i class="fas fa-edit"></i>
                </a>

                <a href="{% url 'tasks:delete_checklist' obj.id %}" class="btn btn-sm btn-outline-danger" title="Delete">
                  <i class="fas fa-trash-alt"></i>
                </a>

                <!-- Delete ENTIRE SERIES for this row -->
                <button type="submit"
                        class="btn btn-sm btn-danger"
                        form="series-form-{{ obj.id }}"
                        title="Delete series"
                        data-confirm="Delete ALL pending occurrences in this series?">
                  <i class="fas fa-trash"></i> Series
                </button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="9" class="text-center py-3 text-muted">No Checklist tasks found.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>

    <!-- Bulk footer -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mt-2 gap-2">
      <div class="d-flex align-items-center gap-3">
        <div class="form-check m-0">
          <input class="form-check-input" type="checkbox" value="1" id="withSeries" name="with_series">
          <label class="form-check-label" for="withSeries">Delete whole series for selected rows</label>
        </div>
        <small class="text-muted"><span data-selected-count>0</span> selected</small>
      </div>
      <button type="submit"
              class="btn btn-danger"
              data-bulk-submit
              data-confirm="Are you sure you want to delete the selected item(s)?"
              disabled>
        Delete
      </button>
    </div>
  </form>

  <!-- Hidden forms for per-row "Delete series" -->
  {% if items %}
    {% for obj in items %}
      <form id="series-form-{{ obj.id }}" method="post" action="{% url 'tasks:list_checklist' %}" class="d-none">
        {% csrf_token %}
        <input type="hidden" name="action" value="delete_series">
        <input type="hidden" name="pk" value="{{ obj.id }}">
      </form>
    {% endfor %}
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/tasks-bulk.js' %}" defer></script>
{% endblock %}
