{% extends "base.html" %}
{% load static %}
{% block title %}Delegations{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <h2>Delegations</h2>
</div>

<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Keyword</label>
        <input type="text" class="form-control" name="keyword" value="{{ request.GET.keyword }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Today Only</label>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="today_only" value="1" id="todayOnly" {% if request.GET.today_only %}checked{% endif %}>
          <label class="form-check-label" for="todayOnly">
            Show tasks planned for today
          </label>
        </div>
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary">Apply</button>
        <a class="btn btn-outline-secondary ms-2" href="{% url 'tasks:list_delegation' %}">Reset</a>
      </div>
    </form>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <div class="text-muted small">Assigned Time (mins)</div>
            <div class="fs-4 fw-semibold">{{ assign_time|default:0 }}</div>
          </div>
          <div class="text-end">
            <div class="text-muted small">Actual Time (mins)</div>
            <div class="fs-4 fw-semibold">{{ actual_time|default:0 }}</div>
          </div>
        </div>
        <div class="text-muted small mt-2">Up to today</div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <!-- Single BULK form -->
    <form method="post" action="{% url 'tasks:list_delegation' %}" data-bulk>
      {% csrf_token %}
      <input type="hidden" name="action" value="bulk_delete">

      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:32px;"><input type="checkbox" aria-label="Select all" data-select-all></th>
            <th>Task Name</th>
            <th>Assign By</th>
            <th>Assign To</th>
            <th>Planned Date &amp; Time</th>
            <th>Priority</th>
            <th style="width:140px;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for d in items %}
          <tr>
            <td><input type="checkbox" name="sel" value="{{ d.id }}" class="form-check-input" data-row-check aria-label="Select row"></td>
            <td>{{ d.task_name }}</td>
            <td>
              {% if d.assign_by %}
                {{ d.assign_by.get_full_name|default:d.assign_by.username }}
              {% else %}
                &mdash;
              {% endif %}
            </td>
            <td>
              {% if d.assign_to %}
                {{ d.assign_to.get_full_name|default:d.assign_to.username }}
              {% else %}
                &mdash;
              {% endif %}
            </td>
            <td>
              {% if d.planned_date %}
                {{ d.planned_date|date:"d M, Y H:i" }}
              {% else %}
                &mdash;
              {% endif %}
            </td>
            <td>{{ d.priority }}</td>
            <td class="text-nowrap">
              <a href="#" title="View"><i class="fas fa-eye"></i></a>
              <a href="{% url 'tasks:edit_delegation' d.pk %}" title="Edit" class="ms-2"><i class="fas fa-edit"></i></a>
              <a href="{% url 'tasks:reassign_delegation' d.pk %}" title="Reassign" class="ms-2"><i class="fas fa-user-edit"></i></a>
              <a href="{% url 'tasks:delete_delegation' d.pk %}" title="Delete" class="ms-2 text-danger"><i class="fas fa-trash"></i></a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="text-center text-muted">No record found.</td></tr>
          {% endfor %}
        </tbody>
      </table>

      {% if items %}
      <div class="d-flex justify-content-between align-items-center p-2">
        <small class="text-muted"><span data-selected-count>0</span> selected</small>
        <button type="submit"
                class="btn btn-danger btn-sm"
                data-bulk-submit
                data-confirm="Delete selected delegations?"
                disabled>
          Delete Selected
        </button>
      </div>
      {% endif %}
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/tasks-bulk.js' %}" defer></script>
{% endblock %}
