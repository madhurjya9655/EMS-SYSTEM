{% extends "base.html" %}
{% load static %}
{% block title %}Edit Delegation{% endblock %}

{% block content %}
  <!-- Flatpickr CSS/JS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <div class="page-header mb-4">
    <h2>Edit Delegation</h2>
  </div>

  <form method="post" enctype="multipart/form-data" class="container-fluid">
    {% csrf_token %}
    <div class="row g-4">
      <!-- LEFT COLUMN -->
      <div class="col-md-6">
        <div class="mb-3">
          {{ form.planned_date.label_tag }}{{ form.planned_date }}
          <div class="form-text">
            Delegations appear once their planned time arrives.
            (Sundays are disabled here in the picker.)
          </div>
        </div>

        <div class="mb-3">
          {{ form.time_per_task_minutes.label_tag }}{{ form.time_per_task_minutes }}
          <div class="form-text">
            Estimated minutes for this delegation (for planning/scorecards).
          </div>
        </div>

        <div class="mb-3">
          {{ form.audio_recording.label_tag }}{{ form.audio_recording }}
          <div class="form-text">
            Optional audio recording with instructions for the assignee.
          </div>
        </div>

        <div class="mb-3">
          {{ form.message.label_tag }}{{ form.message }}
          <div class="form-text">
            Delegation description or instructions for the assignee.
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="col-md-6">
        <div class="mb-3">
          {{ form.assign_to.label_tag }}{{ form.assign_to }}
        </div>

        <div class="mb-3">
          {{ form.priority.label_tag }}{{ form.priority }}
        </div>

        <div class="form-check mb-3">
          {{ form.attachment_mandatory }}{{ form.attachment_mandatory.label_tag }}
        </div>

        <!-- Set Reminder toggle -->
        <div class="form-check mb-3">
          {{ form.set_reminder }}{{ form.set_reminder.label_tag }}
        </div>

        <!-- Reminder block -->
        <div id="delegation_reminder_fields" class="border p-3 mb-3" style="display:none;">
          <div class="row g-3">
            <div class="col-md-6">
              {{ form.reminder_mode.label_tag }}{{ form.reminder_mode }}
            </div>
            <div class="col-md-6">
              {{ form.reminder_frequency.label_tag }}{{ form.reminder_frequency }}
            </div>
            <div class="col-md-6">
              {{ form.reminder_starting_time.label_tag }}{{ form.reminder_starting_time }}
            </div>
          </div>
          <div class="form-text mt-2">
            Configure reminder mode, how often to remind, and at what time to start
            sending reminders for this delegation.
          </div>
        </div>
      </div>
    </div>

    <div class="text-end mt-4">
      <button type="submit" class="btn btn-primary">Update</button>
    </div>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Flatpickr for planned_date (disable Sundays)
      var el = document.getElementById('id_planned_date');
      if (el) {
        flatpickr(el, {
          enableTime: true,
          time_24hr: true,
          minuteIncrement: 5,
          dateFormat: "Y-m-d H:i",
          altInput: true,
          altFormat: "Y-m-d H:i",
          disable: [
            function (date) {
              return date.getDay() === 0; // Sunday
            }
          ]
        });
      }

      // Show/hide reminder block
      const rem = document.getElementById('id_set_reminder');
      const box = document.getElementById('delegation_reminder_fields');
      if (rem && box) {
        const sync = () => {
          box.style.display = rem.checked ? 'block' : 'none';
        };
        rem.addEventListener('change', sync);
        sync(); // initial state
      }
    });
  </script>
{% endblock %}
