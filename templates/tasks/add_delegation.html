{% extends "base.html" %}
{% load static %}

{% block title %}Delegation Task{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">
    {% if form.instance.pk %}
      Edit Delegation Task
    {% else %}
      Add Delegation Task
    {% endif %}
  </h2>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div class="row">
      <div class="col-md-8">

        <div class="mb-3">
          {{ form.task_name.label_tag }} *
          {{ form.task_name }}
          {% if form.task_name.errors %}
            <div class="text-danger small">{{ form.task_name.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          {{ form.assign_to.label_tag }} *
          {{ form.assign_to }}
          {% if form.assign_to.errors %}
            <div class="text-danger small">{{ form.assign_to.errors }}</div>
          {% endif %}
        </div>

        <!-- Planned Date + Time with blue-themed calendar icon -->
        <div class="mb-3">
          {{ form.planned_date.label_tag }} *

          <!-- Keep Djangoâ€™s real field (used for POST); hide it and mirror from the visible field -->
          <div id="planned-date-wrapper">
            {{ form.planned_date }}
          </div>

          <!-- Visible input with custom blue icon -->
          <div class="input-group mt-2" id="planned-date-input-group" style="display:none;">
            <input type="text" class="form-control" id="planned_date_display" placeholder="Select date & time" autocomplete="off">
            <button class="input-group-text calendar-blue-btn" id="planned_date_btn" type="button" aria-label="Open calendar">
              <!-- Inline SVG icon with blue theme -->
              <svg class="calendar-blue-icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <rect x="3" y="3" width="18" height="5" rx="2" ry="2" fill="#2f6fed"/>
                <rect x="3" y="6.5" width="18" height="14.5" rx="3" ry="3" fill="#eef0ff" stroke="#cfd3ff"/>
                <g fill="#8583ff">
                  <rect x="6" y="10" width="3" height="2" rx="0.5"/>
                  <rect x="10.5" y="10" width="3" height="2" rx="0.5"/>
                  <rect x="15" y="10" width="3" height="2" rx="0.5"/>
                  <rect x="6" y="13.5" width="3" height="2" rx="0.5"/>
                  <rect x="10.5" y="13.5" width="3" height="2" rx="0.5"/>
                  <rect x="15" y="13.5" width="3" height="2" rx="0.5"/>
                </g>
                <rect x="7" y="2" width="2" height="4" rx="1" fill="#eaf1ff"/>
                <rect x="15" y="2" width="2" height="4" rx="1" fill="#eaf1ff"/>
              </svg>
            </button>
          </div>

          <small class="form-text text-muted">
            Visible on the dashboard at/after <strong>10:00 IST</strong> on the due day.
            Delay is calculated from the actual planned time. (Sundays are disabled here.)
          </small>

          {% if form.planned_date.errors %}
            <div class="text-danger small">{{ form.planned_date.errors }}</div>
          {% endif %}
        </div>

        {% if form.priority %}
        <div class="mb-3">
          {{ form.priority.label_tag }}
          {{ form.priority }}
          {% if form.priority.errors %}
            <div class="text-danger small">{{ form.priority.errors }}</div>
          {% endif %}
        </div>
        {% endif %}

        {% if form.message %}
        <div class="mb-3">
          {{ form.message.label_tag }}
          {{ form.message }}
          {% if form.message.errors %}
            <div class="text-danger small">{{ form.message.errors }}</div>
          {% endif %}
        </div>
        {% endif %}

        {% if form.audio_recording %}
        <div class="mb-3">
          {{ form.audio_recording.label_tag }}
          {{ form.audio_recording }}
          {% if form.audio_recording.errors %}
            <div class="text-danger small">{{ form.audio_recording.errors }}</div>
          {% endif %}
        </div>
        {% endif %}

        {% if form.time_per_task_minutes %}
        <div class="mb-3">
          {{ form.time_per_task_minutes.label_tag }}
          {{ form.time_per_task_minutes }}
          {% if form.time_per_task_minutes.errors %}
            <div class="text-danger small">{{ form.time_per_task_minutes.errors }}</div>
          {% endif %}
        </div>
        {% endif %}

        {% if form.attachment_mandatory %}
        <div class="form-check mb-3">
          {{ form.attachment_mandatory }}
          {{ form.attachment_mandatory.label_tag }}
          {% if form.attachment_mandatory.errors %}
            <div class="text-danger small">{{ form.attachment_mandatory.errors }}</div>
          {% endif %}
        </div>
        {% endif %}

      </div>

      <div class="col-md-4">

        <div class="card mb-3">
          <div class="card-header">
            CC (Keep Others Informed)
          </div>
          <div class="card-body">
            <small class="text-muted d-block mb-2">
              Use this to CC Amreen, reporting officer, or colleagues who should be informed.
            </small>

            {% if form.cc_users %}
              <div class="mb-3">
                {{ form.cc_users.label_tag }}
                {{ form.cc_users }}
                {% if form.cc_users.help_text %}
                  <small class="form-text text-muted">{{ form.cc_users.help_text }}</small>
                {% endif %}
                {% if form.cc_users.errors %}
                  <div class="text-danger small">{{ form.cc_users.errors }}</div>
                {% endif %}
              </div>
            {% endif %}

            {% if form.cc_emails %}
              <div class="mb-3">
                {{ form.cc_emails.label_tag }}
                {{ form.cc_emails }}
                {% if form.cc_emails.errors %}
                  <div class="text-danger small">{{ form.cc_emails.errors }}</div>
                {% endif %}
                {% if form.cc_emails.help_text %}
                  <small class="form-text text-muted">{{ form.cc_emails.help_text }}</small>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

        {% with 'task_name assign_to planned_date priority message audio_recording time_per_task_minutes attachment_mandatory cc_users cc_emails mode frequency set_reminder' as excluded %}
          {% for field in form %}
            {% if field.name not in excluded %}
              <div class="mb-3">
                {{ field.label_tag }}
                {{ field }}
                {% if field.help_text %}
                  <small class="form-text text-muted">{{ field.help_text }}</small>
                {% endif %}
                {% if field.errors %}
                  <div class="text-danger small">{{ field.errors }}</div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        {% endwith %}

      </div>
    </div>

    <div class="mt-3">
      <button type="submit" class="btn btn-primary">
        {% if form.instance.pk %}Update Delegation{% else %}Create Delegation{% endif %}
      </button>
      <a href="{% url 'tasks:list_delegation' %}" class="btn btn-secondary ms-2">Cancel</a>
    </div>

  </form>
</div>

<!-- Flatpickr assets -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
  .calendar-blue-btn{
    border-left: 0;
    background: #f4f7ff;
    cursor: pointer;
  }
  .calendar-blue-btn:hover{ background: #e9f0ff; }
  #planned-date-input-group .form-control{ border-right: 0; }
  #planned-date-input-group .input-group-text{
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
  }
</style>

<script>
  (function () {
    var realInput = document.getElementById('id_planned_date') ||
                    document.querySelector('input[name="planned_date"]');
    if (!realInput) return;

    var inputGroup = document.getElementById('planned-date-input-group');
    inputGroup.style.display = 'flex';
    realInput.classList.add('d-none');

    var displayInput = document.getElementById('planned_date_display');
    var btn = document.getElementById('planned_date_btn');

    var existing = (realInput.value || '').trim();
    if (existing) { displayInput.value = existing; }

    function disableSundays(date){ return date.getDay() === 0; }

    var fp = flatpickr(displayInput, {
      enableTime: true,
      time_24hr: true,
      dateFormat: "Y-m-d H:i",
      defaultHour: 19,
      defaultMinute: 0,
      disable: [disableSundays],
      allowInput: true,
      clickOpens: true,
      onChange: function(_, dateStr){ realInput.value = dateStr || ""; },
      onClose: function(_, dateStr){ realInput.value = dateStr || ""; },
      onReady: function(){
        if (existing){ fp.setDate(existing, false, "Y-m-d H:i"); }
        if (!realInput.value && displayInput.value){
          realInput.value = displayInput.value;
        }
      }
    });

    btn.addEventListener('click', function(){ fp.open(); });
    displayInput.addEventListener('blur', function(){
      realInput.value = displayInput.value.trim();
    });
  })();
</script>
{% endblock %}
