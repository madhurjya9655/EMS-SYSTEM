{% extends "base.html" %}
{% load static %}

{% block title %}Delegation Task{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">
    {% if form.instance.pk %}
      Edit Delegation Task
    {% else %}
      Add Delegation Task
    {% endif %}
  </h2>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div class="row">
      <div class="col-md-8">

        <div class="mb-3">
          {{ form.task_name.label_tag }} *
          {{ form.task_name }}
          {% if form.task_name.errors %}
            <div class="text-danger small">{{ form.task_name.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          {{ form.assign_to.label_tag }} *
          {{ form.assign_to }}
          {% if form.assign_to.errors %}
            <div class="text-danger small">{{ form.assign_to.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          {{ form.planned_date.label_tag }} *
          {{ form.planned_date }}
          <small class="form-text text-muted">
            This will be treated as the due date at <strong>7:00 PM IST</strong> on the selected day.
            (The time part is ignored; system always stores it as 7 PM IST.)
          </small>
          {% if form.planned_date.errors %}
            <div class="text-danger small">{{ form.planned_date.errors }}</div>
          {% endif %}
        </div>

        {% if form.priority %}
        <div class="mb-3">
          {{ form.priority.label_tag }}
          {{ form.priority }}
          {% if form.priority.errors %}
            <div class="text-danger small">{{ form.priority.errors }}</div>
          {% endif %}
        </div>
        {% endif %}

        {% if form.message %}
        <div class="mb-3">
          {{ form.message.label_tag }}
          {{ form.message }}
          {% if form.message.errors %}
            <div class="text-danger small">{{ form.message.errors }}</div>
          {% endif %}
        </div>
        {% endif %}

        {% if form.attachment %}
        <div class="mb-3">
          {{ form.attachment.label_tag }}
          {{ form.attachment }}
          {% if form.attachment.errors %}
            <div class="text-danger small">{{ form.attachment.errors }}</div>
          {% endif %}
        </div>
        {% endif %}

        {% if form.doer_file %}
        <div class="mb-3">
          {{ form.doer_file.label_tag }}
          {{ form.doer_file }}
          {% if form.doer_file.errors %}
            <div class="text-danger small">{{ form.doer_file.errors }}</div>
          {% endif %}
        </div>
        {% endif %}

        {% if form.time_per_task_minutes %}
        <div class="mb-3">
          {{ form.time_per_task_minutes.label_tag }}
          {{ form.time_per_task_minutes }}
          {% if form.time_per_task_minutes.errors %}
            <div class="text-danger small">{{ form.time_per_task_minutes.errors }}</div>
          {% endif %}
        </div>
        {% endif %}

        {% if form.attachment_mandatory %}
        <div class="form-check mb-3">
          {{ form.attachment_mandatory }}
          {{ form.attachment_mandatory.label_tag }}
          {% if form.attachment_mandatory.errors %}
            <div class="text-danger small">{{ form.attachment_mandatory.errors }}</div>
          {% endif %}
        </div>
        {% endif %}

      </div>

      <div class="col-md-4">

        <div class="card mb-3">
          <div class="card-header">
            CC (Keep Others Informed)
          </div>
          <div class="card-body">
            <small class="text-muted d-block mb-2">
              Use this to CC Amreen, reporting officer, or colleagues who should be informed.
            </small>

            {% if form.cc_users %}
              <div class="mb-3">
                {{ form.cc_users.label_tag }}
                {{ form.cc_users }}
                {% if form.cc_users.help_text %}
                  <small class="form-text text-muted">{{ form.cc_users.help_text }}</small>
                {% endif %}
                {% if form.cc_users.errors %}
                  <div class="text-danger small">{{ form.cc_users.errors }}</div>
                {% endif %}
              </div>
            {% endif %}

            {% if form.notify_to %}
              <div class="mb-3">
                {{ form.notify_to.label_tag }}
                {{ form.notify_to }}
                <small class="form-text text-muted">
                  Select reporting officer / colleague to keep in CC.
                </small>
                {% if form.notify_to.errors %}
                  <div class="text-danger small">{{ form.notify_to.errors }}</div>
                {% endif %}
              </div>
            {% endif %}

            {% if form.cc or form.cc_emails or form.cc_list %}
              <div class="mb-3">
                {% if form.cc %}
                  {{ form.cc.label_tag }}
                  {{ form.cc }}
                  {% if form.cc.errors %}
                    <div class="text-danger small">{{ form.cc.errors }}</div>
                  {% endif %}
                {% endif %}
                {% if form.cc_emails %}
                  {{ form.cc_emails.label_tag }}
                  {{ form.cc_emails }}
                  {% if form.cc_emails.errors %}
                    <div class="text-danger small">{{ form.cc_emails.errors }}</div>
                  {% endif %}
                {% endif %}
                {% if form.cc_list %}
                  {{ form.cc_list.label_tag }}
                  {{ form.cc_list }}
                  {% if form.cc_list.errors %}
                    <div class="text-danger small">{{ form.cc_list.errors }}</div>
                  {% endif %}
                {% endif %}
                <small class="form-text text-muted">
                  You can enter multiple emails separated by commas.
                </small>
              </div>
            {% endif %}
          </div>
        </div>

        {# Any other extra fields still on the form #}
        {% with 'task_name assign_to planned_date priority message attachment doer_file time_per_task_minutes attachment_mandatory cc_users notify_to cc cc_emails cc_list' as excluded %}
          {% for field in form %}
            {% if field.name not in excluded %}
              <div class="mb-3">
                {{ field.label_tag }}
                {{ field }}
                {% if field.help_text %}
                  <small class="form-text text-muted">{{ field.help_text }}</small>
                {% endif %}
                {% if field.errors %}
                  <div class="text-danger small">{{ field.errors }}</div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        {% endwith %}

      </div>
    </div>

    <div class="mt-3">
      <button type="submit" class="btn btn-primary">
        {% if form.instance.pk %}Update Delegation{% else %}Create Delegation{% endif %}
      </button>
      <a href="{% url 'tasks:list_delegation' %}" class="btn btn-secondary ms-2">Cancel</a>
    </div>

  </form>
</div>
{% endblock %}
