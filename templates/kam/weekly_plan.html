{# FILE: templates/kam/weekly_plan.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Plan Visit{% endblock %}

{% block content %}
<div class="page-header d-flex align-items-center justify-content-between flex-wrap gap-2">
  <div>
    <h1 class="page-title mb-1">Plan Visit</h1>
    <div class="text-muted small">Single Draft + Batch Submission</div>
  </div>
  <div class="d-flex gap-2">
    <a href="{% url 'kam:visit_batches' %}" class="btn btn-outline-secondary">View Batches</a>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">

    <ul class="nav nav-tabs" id="planTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batchPane" type="button" role="tab">
          Batch (Primary)
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="single-tab" data-bs-toggle="tab" data-bs-target="#singlePane" type="button" role="tab">
          Single (Draft only)
        </button>
      </li>
    </ul>

    <div class="tab-content pt-3">

      <!-- ===================== BATCH PANE ===================== -->
      <div class="tab-pane fade show active" id="batchPane" role="tabpanel" aria-labelledby="batch-tab">
        <form method="post" novalidate>
          {% csrf_token %}

          {% if batch_form.non_field_errors %}
            <div class="alert alert-danger">{{ batch_form.non_field_errors }}</div>
          {% endif %}

          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Visit Category</label>
              {{ batch_form.visit_category }}
              {% for e in batch_form.visit_category.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="col-md-3">
              <label class="form-label">From Date</label>
              {{ batch_form.from_date }}
              {% for e in batch_form.from_date.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="col-md-3">
              <label class="form-label">To Date</label>
              {{ batch_form.to_date }}
              {% for e in batch_form.to_date.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="col-md-3">
              <label class="form-label">Remarks (required for Proceed)</label>
              {{ batch_form.purpose }}
              {% for e in batch_form.purpose.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
          </div>

          <div class="mt-3" id="batchCustomerBlock" style="display:none;">
            <label class="form-label">Customers</label>
            {{ batch_form.customers }}
            <div class="form-text">Select customers for Customer Visit batch.</div>
            {% for e in batch_form.customers.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>

          <hr class="my-3">

          <div id="nonCustomerLinesBlock" style="display:none;">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="text-muted small">
                Add one or more lines (supplier/warehouse/vendor). These will be saved as a DRAFT batch.
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addLineBtn">+ Add line</button>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th style="min-width:220px;">Name</th>
                    <th style="min-width:220px;">Location</th>
                    <th>Purpose</th>
                    <th style="width:110px;"></th>
                  </tr>
                </thead>
                <tbody id="linesTbody">
                  <tr class="line-row">
                    <td><input class="form-control form-control-sm" name="counterparty_name[]" placeholder="Name" required></td>
                    <td><input class="form-control form-control-sm" name="counterparty_location[]" placeholder="Location"></td>
                    <td><input class="form-control form-control-sm" name="counterparty_purpose[]" placeholder="Purpose"></td>
                    <td class="text-end">
                      <button type="button" class="btn btn-sm btn-outline-danger removeLineBtn">Remove</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-outline-secondary" type="submit" name="action" value="save_draft_batch">
              Save Draft Batch
            </button>
            <button class="btn btn-primary" type="submit" name="action" value="proceed_batch">
              Proceed to Manager
            </button>
          </div>
        </form>
      </div>

      <!-- ===================== SINGLE PANE ===================== -->
      <div class="tab-pane fade" id="singlePane" role="tabpanel" aria-labelledby="single-tab">
        <form method="post" novalidate>
          {% csrf_token %}

          {% if single_form.non_field_errors %}
            <div class="alert alert-danger">{{ single_form.non_field_errors }}</div>
          {% endif %}

          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Visit Category</label>
              {{ single_form.visit_category }}
              {% for e in single_form.visit_category.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="col-md-5">
              <label class="form-label">Customer</label>
              {{ single_form.customer }}
              {% for e in single_form.customer.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="col-md-4">
              <label class="form-label">Counterparty Name (non-customer)</label>
              {{ single_form.counterparty_name }}
              {% for e in single_form.counterparty_name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="col-md-3">
              <label class="form-label">Visit Date</label>
              {{ single_form.visit_date }}
              {% for e in single_form.visit_date.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="col-md-3">
              <label class="form-label">To Date</label>
              {{ single_form.visit_date_to }}
              {% for e in single_form.visit_date_to.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="col-md-6">
              <label class="form-label">Purpose</label>
              {{ single_form.purpose }}
              {% for e in single_form.purpose.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="col-md-6">
              <label class="form-label">Location</label>
              {{ single_form.location }}
              {% for e in single_form.location.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="col-md-3">
              <label class="form-label">Expected Sales (MT)</label>
              {{ single_form.expected_sales_mt }}
              {% for e in single_form.expected_sales_mt.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="col-md-3">
              <label class="form-label">Expected Collection</label>
              {{ single_form.expected_collection }}
              {% for e in single_form.expected_collection.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
          </div>

          <div class="mt-3">
            <button class="btn btn-outline-secondary" type="submit" name="action" value="save_single_draft">
              Save Single Draft
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <h5 class="mb-3">This Week Plans</h5>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Date</th>
            <th>Customer / Counterparty</th>
            <th>Category</th>
            <th>Location</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for p in plans %}
            <tr>
              <td>
                {{ p.visit_date }}{% if p.visit_date_to %} â†’ {{ p.visit_date_to }}{% endif %}
              </td>
              <td>
                {% if p.customer %}{{ p.customer.name }}{% else %}{{ p.counterparty_name }}{% endif %}
              </td>
              <td>{{ p.get_visit_category_display }}</td>
              <td>{{ p.location|default:"-" }}</td>
              <td>{{ p.approval_status }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="5" class="text-muted">No plans for this period.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<script>
(function(){
  const catSelect = document.querySelector('#batchPane select[name="visit_category"]');
  const customerBlock = document.getElementById('batchCustomerBlock');
  const nonCustomerBlock = document.getElementById('nonCustomerLinesBlock');
  const addBtn = document.getElementById('addLineBtn');
  const tbody = document.getElementById('linesTbody');

  function isCustomerCategory(val){
    return (val || '').toUpperCase() === 'CUSTOMER';
  }

  function refreshBlocks(){
    const val = catSelect ? catSelect.value : '';
    if (isCustomerCategory(val)){
      if (customerBlock) customerBlock.style.display = '';
      if (nonCustomerBlock) nonCustomerBlock.style.display = 'none';
    } else {
      if (customerBlock) customerBlock.style.display = 'none';
      if (nonCustomerBlock) nonCustomerBlock.style.display = '';
    }
  }

  function wireRemoveButtons(){
    document.querySelectorAll('.removeLineBtn').forEach(btn=>{
      btn.onclick = function(){
        const row = btn.closest('tr');
        if (!row) return;
        const rows = tbody.querySelectorAll('tr');
        if (rows.length <= 1){
          row.querySelectorAll('input').forEach(i => i.value = '');
          return;
        }
        row.remove();
      };
    });
  }

  if (catSelect){
    catSelect.addEventListener('change', refreshBlocks);
    refreshBlocks();
  }

  if (addBtn && tbody){
    addBtn.addEventListener('click', function(){
      const tr = document.createElement('tr');
      tr.className = 'line-row';
      tr.innerHTML = `
        <td><input class="form-control form-control-sm" name="counterparty_name[]" placeholder="Name" required></td>
        <td><input class="form-control form-control-sm" name="counterparty_location[]" placeholder="Location"></td>
        <td><input class="form-control form-control-sm" name="counterparty_purpose[]" placeholder="Purpose"></td>
        <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger removeLineBtn">Remove</button></td>
      `;
      tbody.appendChild(tr);
      wireRemoveButtons();
    });
  }

  wireRemoveButtons();
})();
</script>
{% endblock %}
