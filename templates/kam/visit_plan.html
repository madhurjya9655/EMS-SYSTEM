<!--
FILE: E:\CLIENT PROJECT\employee management system bos\employee_management_system\templates\kam\visit_plan.html
-->
{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Plan Visit</h3>
  </div>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} mb-2">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row g-3">
    <!-- =========================
         LEFT: SINGLE VISIT (legacy)
         ========================= -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header">
          <strong>Single Visit</strong>
        </div>
        <div class="card-body">
          <form method="post" action="" id="singleVisitForm">
            {% csrf_token %}
            <input type="hidden" name="mode" value="single" />

            <!-- B2: visit_category first (form already ordered) -->
            <div class="mb-3">
              <label class="form-label">Visit Category</label>
              {{ form.visit_category }}
            </div>

            <div id="singleCustomerBlock" class="mb-3">
              <label class="form-label">Customer</label>
              {{ form.customer }}
              <div class="form-text">Only customers in your scope are shown.</div>
            </div>

            <div id="singleCounterpartyBlock" class="mb-3" style="display:none;">
              <label class="form-label">Vendor / Supplier / Warehouse Name</label>
              {{ form.counterparty_name }}
            </div>

            <div class="row g-2">
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">Visit Date</label>
                {{ form.visit_date }}
              </div>
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">To Date (optional)</label>
                {{ form.visit_date_to }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Visit Type</label>
              {{ form.visit_type }}
            </div>

            <div class="mb-3">
              <label class="form-label">Purpose</label>
              {{ form.purpose }}
            </div>

            <div class="row g-2">
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">Expected Sales (MT)</label>
                {{ form.expected_sales_mt }}
              </div>
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">Expected Collection (₹)</label>
                {{ form.expected_collection }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Location (required)</label>
              {{ form.location }}
            </div>

            <button type="submit" class="btn btn-primary w-100">Save Single Visit</button>
          </form>
        </div>
      </div>
    </div>

    <!-- =========================
         RIGHT: BATCH WORKFLOWS
         ========================= -->
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header">
          <strong>Batch Submission</strong>
          <div class="small text-muted mt-1">
            Use this for multiple customers / vendors / warehouses. Manager email is consolidated for “Proceed to Manager”.
          </div>
        </div>

        <div class="card-body">
          <form method="post" action="" id="batchForm">
            {% csrf_token %}
            <input type="hidden" name="mode" value="batch" />

            <div class="mb-3">
              <label class="form-label">Visit Category</label>
              {{ batch_form.visit_category }}
            </div>

            <div class="row g-2">
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">From Date</label>
                {{ batch_form.from_date }}
              </div>
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">To Date</label>
                {{ batch_form.to_date }}
              </div>
            </div>

            <!-- B4: remarks mandatory for Proceed-to-Manager (backend uses batch_form.purpose as remarks) -->
            <div class="mb-3">
              <label class="form-label">Purpose / Remarks</label>
              {{ batch_form.purpose }}
              <div class="form-text">
                <span class="fw-semibold">Mandatory</span> when you click “Proceed to Manager”.
              </div>
            </div>

            <!-- =========================
                 CUSTOMER BATCH (multi-select)
                 ========================= -->
            <div id="customerBatchBlock" class="border rounded p-3 mb-3" style="display:none;">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <strong>Customer Visit Batch</strong>
                <span class="badge bg-secondary">B4</span>
              </div>

              <div class="mb-3">
                <label class="form-label">Select Customers</label>
                {{ batch_form.customers }}
                <div class="form-text">Only customers in your scope are shown.</div>
              </div>

              <div class="alert alert-light border mb-3">
                <div class="fw-semibold mb-1">Per-customer details</div>
                <div class="small text-muted">
                  After selecting customers, click “Generate Rows” to enter details per customer.
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="btnGenerateCustomerRows">
                  Generate Rows
                </button>
              </div>

              <div class="table-responsive">
                <table class="table table-sm align-middle" id="customerRowsTable" style="display:none;">
                  <thead>
                    <tr>
                      <th style="min-width:220px;">Customer</th>
                      <th style="min-width:160px;">From</th>
                      <th style="min-width:160px;">To</th>
                      <th style="min-width:220px;">Purpose</th>
                      <th style="min-width:220px;">Location</th>
                      <th style="min-width:160px;">Expected Sales (MT)</th>
                      <th style="min-width:180px;">Expected Collection (₹)</th>
                    </tr>
                  </thead>
                  <tbody id="customerRowsBody">
                    <!-- JS will inject rows -->
                  </tbody>
                </table>
              </div>

              <!-- B4: Proceed-to-Manager -->
              <div class="d-flex gap-2 mt-3">
                <button type="submit" name="action" value="proceed_to_manager" class="btn btn-success flex-grow-1">
                  Proceed to Manager (Consolidated Email)
                </button>
                <button type="submit" name="action" value="save_batch" class="btn btn-outline-secondary">
                  Save Batch Only
                </button>
              </div>
            </div>

            <!-- =========================
                 NON-CUSTOMER BATCH (Vendor/Supplier/Warehouse)
                 ========================= -->
            <div id="nonCustomerBatchBlock" class="border rounded p-3 mb-3" style="display:none;">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <strong>Vendor / Supplier / Warehouse Batch</strong>
                <span class="badge bg-secondary">B2</span>
              </div>

              <div class="alert alert-light border mb-3">
                <div class="small text-muted">
                  Add one or more counterparties. Each line becomes a visit plan.
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="btnAddCounterpartyRow">
                  + Add Line
                </button>
              </div>

              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th style="min-width:240px;">Name</th>
                      <th style="min-width:220px;">Location</th>
                      <th style="min-width:260px;">Purpose (optional)</th>
                      <th style="width:80px;"></th>
                    </tr>
                  </thead>
                  <tbody id="counterpartyRows">
                    <!-- default one row -->
                  </tbody>
                </table>
              </div>

              <button type="submit" name="action" value="save_batch" class="btn btn-primary w-100 mt-2">
                Save Batch
              </button>
            </div>

            <!-- Hidden flag for backend (optional) -->
            <input type="hidden" name="proceed_to_manager" id="proceedFlag" value="0" />
          </form>
        </div>
      </div>

      <!-- =========================
           THIS WEEK PLANS
           ========================= -->
      <div class="card shadow-sm mt-3">
        <div class="card-header">
          <strong>This Week Plans</strong>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Category</th>
                  <th>Entity</th>
                  <th>Location</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for p in plans %}
                  <tr>
                    <td>{{ p.visit_date }}{% if p.visit_date_to %} → {{ p.visit_date_to }}{% endif %}</td>
                    <td>{{ p.get_visit_category_display }}</td>
                    <td>
                      {% if p.customer %}
                        {{ p.customer.name }}
                      {% else %}
                        {{ p.counterparty_name|default:"-" }}
                      {% endif %}
                    </td>
                    <td>{{ p.location|default:"-" }}</td>
                    <td>{{ p.approval_status }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="5" class="text-center text-muted py-3">No plans for this week.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function() {
  // =============================
  // IMPORTANT:
  // This template assumes views.py uses form prefixes:
  //   form       = VisitPlanForm(prefix="single")
  //   batch_form = VisitBatchForm(prefix="batch")
  // So field names/ids become:
  //   single-visit_category, id_single-visit_category, etc
  //   batch-visit_category,  id_batch-visit_category,  etc
  // =============================

  function el(id){ return document.getElementById(id); }
  function show(node){ if(node) node.style.display = ""; }
  function hide(node){ if(node) node.style.display = "none"; }

  // -----------------------------
  // SINGLE FORM category toggle
  // -----------------------------
  const singleForm = el("singleVisitForm");
  const singleCategorySelect = singleForm ? singleForm.querySelector('select[name="single-visit_category"]') : null;
  const singleCustomerBlock = el("singleCustomerBlock");
  const singleCounterpartyBlock = el("singleCounterpartyBlock");

  function updateSingleBlocks() {
    if(!singleCategorySelect) return;
    const v = singleCategorySelect.value;
    if (v === "CUSTOMER") {
      show(singleCustomerBlock);
      hide(singleCounterpartyBlock);
    } else {
      hide(singleCustomerBlock);
      show(singleCounterpartyBlock);
    }
  }
  if (singleCategorySelect) {
    singleCategorySelect.addEventListener("change", updateSingleBlocks);
    updateSingleBlocks();
  }

  // -----------------------------
  // BATCH category toggle
  // -----------------------------
  const batchForm = el("batchForm");
  const batchCategorySelect = batchForm ? batchForm.querySelector('select[name="batch-visit_category"]') : null;
  const customerBatchBlock = el("customerBatchBlock");
  const nonCustomerBatchBlock = el("nonCustomerBatchBlock");

  function updateBatchBlocks() {
    if(!batchCategorySelect) return;
    const v = batchCategorySelect.value;
    if (v === "CUSTOMER") {
      show(customerBatchBlock);
      hide(nonCustomerBatchBlock);
    } else {
      hide(customerBatchBlock);
      show(nonCustomerBatchBlock);
    }
  }
  if (batchCategorySelect) {
    batchCategorySelect.addEventListener("change", updateBatchBlocks);
    updateBatchBlocks();
  }

  // -----------------------------
  // Counterparty rows (non-customer batch)
  // -----------------------------
  const counterBody = el("counterpartyRows");
  function addCounterpartyRow(nameVal="", locVal="", purVal="") {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="form-control form-control-sm" name="counterparty_name[]" value="${String(nameVal).replace(/"/g,'&quot;')}" placeholder="Name" /></td>
      <td><input class="form-control form-control-sm" name="counterparty_location[]" value="${String(locVal).replace(/"/g,'&quot;')}" placeholder="Location" /></td>
      <td><input class="form-control form-control-sm" name="counterparty_purpose[]" value="${String(purVal).replace(/"/g,'&quot;')}" placeholder="Purpose (optional)" /></td>
      <td><button type="button" class="btn btn-sm btn-outline-danger">Remove</button></td>
    `;
    tr.querySelector("button").addEventListener("click", () => tr.remove());
    counterBody.appendChild(tr);
  }
  const btnAdd = el("btnAddCounterpartyRow");
  if (btnAdd) btnAdd.addEventListener("click", () => addCounterpartyRow());
  if (counterBody && counterBody.children.length === 0) addCounterpartyRow();

  // -----------------------------
  // B4: Generate per-customer rows
  // -----------------------------
  const btnGen = el("btnGenerateCustomerRows");
  const customerRowsTable = el("customerRowsTable");
  const customerRowsBody = el("customerRowsBody");
  const customerSelect = batchForm ? batchForm.querySelector('select[name="batch-customers"]') : null;

  function selectedOptions(selectEl) {
    const out = [];
    if (!selectEl) return out;
    for (const opt of selectEl.options) {
      if (opt.selected) out.push({ id: opt.value, text: opt.text });
    }
    return out;
  }

  function getBatchDefaults() {
    const fromEl = batchForm ? batchForm.querySelector('input[name="batch-from_date"]') : null;
    const toEl = batchForm ? batchForm.querySelector('input[name="batch-to_date"]') : null;
    return {
      from_date: fromEl ? fromEl.value : "",
      to_date: toEl ? toEl.value : ""
    };
  }

  function makeCustomerRow(cust, defaults) {
    const fromDef = defaults.from_date || "";
    const toDef = defaults.to_date || "";
    const remarkDef = "";
    const locDef = "";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="fw-semibold">${cust.text}</td>
      <td><input type="date" class="form-control form-control-sm" name="visit_date_${cust.id}" value="${fromDef}" /></td>
      <td><input type="date" class="form-control form-control-sm" name="visit_date_to_${cust.id}" value="${toDef}" /></td>
      <td><input class="form-control form-control-sm" name="purpose_${cust.id}" value="${remarkDef}" placeholder="Purpose (optional)" /></td>
      <td><input class="form-control form-control-sm" name="location_${cust.id}" value="${locDef}" placeholder="Location" /></td>
      <td><input class="form-control form-control-sm" name="expected_sales_mt_${cust.id}" inputmode="decimal" placeholder="e.g. 10.500" /></td>
      <td><input class="form-control form-control-sm" name="expected_collection_${cust.id}" inputmode="decimal" placeholder="e.g. 250000" /></td>
    `;
    return tr;
  }

  if (btnGen) {
    btnGen.addEventListener("click", () => {
      const sels = selectedOptions(customerSelect);
      if (!customerRowsBody) return;
      customerRowsBody.innerHTML = "";
      const defaults = getBatchDefaults();

      if (sels.length === 0) {
        hide(customerRowsTable);
        return;
      }

      for (const cust of sels) {
        customerRowsBody.appendChild(makeCustomerRow(cust, defaults));
      }
      show(customerRowsTable);
    });
  }

  // -----------------------------
  // Set proceed flag for backend compatibility
  // -----------------------------
  if (batchForm) {
    batchForm.addEventListener("submit", (e) => {
      const submitter = e.submitter;
      if (submitter && submitter.name === "action" && submitter.value === "proceed_to_manager") {
        el("proceedFlag").value = "1";

        // Enforce remarks present (client-side convenience; server also enforces)
        const remarks = batchForm.querySelector('input[name="batch-purpose"], textarea[name="batch-purpose"]');
        if (remarks && !remarks.value.trim()) {
          e.preventDefault();
          alert("Remarks are required to proceed to manager.");
          remarks.focus();
          return false;
        }
      } else {
        el("proceedFlag").value = "0";
      }
    });
  }
})();
</script>

{% endblock %}
