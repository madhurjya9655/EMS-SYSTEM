{# apps/dashboard/templates/dashboard/partials/handed_over_tasks.html #}
{% load static %}
{% with title=card_title|default:"Tasks handed over to you" %}
<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div class="fw-semibold">
      <i class="bi bi-arrow-left-right me-1"></i>{{ title }}
    </div>
    <div class="text-muted small">
      {% now "Y-m-d" %}
    </div>
  </div>

  {% if handed_over.checklist or handed_over.delegation or handed_over.help_ticket %}
    <div class="list-group list-group-flush">

      {# ---------- Checklist ---------- #}
      {% if handed_over.checklist %}
        <div class="list-group-item bg-light small fw-semibold">
          Checklist
          <span class="badge bg-secondary ms-1">{{ handed_over.checklist|length }}</span>
        </div>
        {% for row in handed_over.checklist %}
          {% with ho=row.handover lr=row.leave_request oa=row.original_assignee %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div class="me-2">
                {% if row.task_url %}
                  <a href="{{ row.task_url }}" class="fw-semibold text-decoration-none">
                    #{{ row.task.id }} — {{ row.task.task_name|default:row.task.title|default:"Checklist Task" }}
                  </a>
                {% else %}
                  <span class="fw-semibold">
                    #{{ row.task.id }} — {{ row.task.task_name|default:row.task.title|default:"Checklist Task" }}
                  </span>
                {% endif %}
                <div class="text-muted small mt-1">
                  From: {{ oa.get_full_name|default:oa.username }}
                  <span class="mx-1">•</span>
                  Leave: {{ lr.start_date }} → {{ lr.end_date }}
                  {% if lr.is_half_day %}
                    <span class="badge bg-info-subtle text-info-emphasis border ms-1">Half-day</span>
                  {% endif %}
                </div>
                {% if row.handover_message %}
                  <div class="small mt-1">
                    <span class="text-muted">Note:</span> {{ row.handover_message }}
                  </div>
                {% endif %}
              </div>
              <div class="text-nowrap">
                {% if ho.is_currently_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Inactive</span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      {% endif %}

      {# ---------- Delegation ---------- #}
      {% if handed_over.delegation %}
        <div class="list-group-item bg-light small fw-semibold">
          Delegation
          <span class="badge bg-secondary ms-1">{{ handed_over.delegation|length }}</span>
        </div>
        {% for row in handed_over.delegation %}
          {% with ho=row.handover lr=row.leave_request oa=row.original_assignee %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div class="me-2">
                {% if row.task_url %}
                  <a href="{{ row.task_url }}" class="fw-semibold text-decoration-none">
                    #{{ row.task.id }} — {{ row.task.task_name|default:row.task.title|default:"Delegation Task" }}
                  </a>
                {% else %}
                  <span class="fw-semibold">
                    #{{ row.task.id }} — {{ row.task.task_name|default:row.task.title|default:"Delegation Task" }}
                  </span>
                {% endif %}
                <div class="text-muted small mt-1">
                  From: {{ oa.get_full_name|default:oa.username }}
                  <span class="mx-1">•</span>
                  Leave: {{ lr.start_date }} → {{ lr.end_date }}
                </div>
                {% if row.handover_message %}
                  <div class="small mt-1">
                    <span class="text-muted">Note:</span> {{ row.handover_message }}
                  </div>
                {% endif %}
              </div>
              <div class="text-nowrap">
                {% if ho.is_currently_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Inactive</span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      {% endif %}

      {# ---------- Help Tickets ---------- #}
      {% if handed_over.help_ticket %}
        <div class="list-group-item bg-light small fw-semibold">
          Help Tickets
          <span class="badge bg-secondary ms-1">{{ handed_over.help_ticket|length }}</span>
        </div>
        {% for row in handed_over.help_ticket %}
          {% with ho=row.handover lr=row.leave_request oa=row.original_assignee %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div class="me-2">
                {% if row.task_url %}
                  <a href="{{ row.task_url }}" class="fw-semibold text-decoration-none">
                    #{{ row.task.id }} — {{ row.task.title|default:"Help Ticket" }}
                  </a>
                {% else %}
                  <span class="fw-semibold">
                    #{{ row.task.id }} — {{ row.task.title|default:"Help Ticket" }}
                  </span>
                {% endif %}
                <div class="text-muted small mt-1">
                  From: {{ oa.get_full_name|default:oa.username }}
                  <span class="mx-1">•</span>
                  Leave: {{ lr.start_date }} → {{ lr.end_date }}
                </div>
                {% if row.handover_message %}
                  <div class="small mt-1">
                    <span class="text-muted">Note:</span> {{ row.handover_message }}
                  </div>
                {% endif %}
              </div>
              <div class="text-nowrap">
                {% if ho.is_currently_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Inactive</span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      {% endif %}

    </div>
  {% else %}
    <div class="card-body text-muted small">
      No tasks have been handed over to you right now.
    </div>
  {% endif %}
</div>
{% endwith %}
