{% extends "base.html" %}
{% load static %}
{% load dashboard_extras %}
{% load dashboard_filters %}

{% block content %}
<div class="container-fluid py-3">

  <!-- Week Score + Pending Tasks -->
  <div class="row g-3">
    <div class="col-xl-6">
      <div class="card">
        <div class="card-header fw-bold">Week Score</div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <thead>
              <tr>
                <th style="width:40%"></th>
                <th class="text-center">Previous</th>
                <th class="text-center">Current</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Checklist</td>
                <td class="text-center">{{ week_score.checklist.previous }}</td>
                <td class="text-center">{{ week_score.checklist.current }}</td>
              </tr>
              <tr>
                <td>Delegation</td>
                <td class="text-center">{{ week_score.delegation.previous }}</td>
                <td class="text-center">{{ week_score.delegation.current }}</td>
              </tr>
              <tr>
                <td>Help Ticket</td>
                <td class="text-center">{{ week_score.help_ticket.previous }}</td>
                <td class="text-center">{{ week_score.help_ticket.current }}</td>
              </tr>
              <tr>
                <td>Time Spent</td>
                <td class="text-center">{{ prev_time }}</td>
                <td class="text-center">{{ curr_time }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-xl-6">
      <div class="card">
        <div class="card-header fw-bold">Pending Tasks</div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <tbody>
              <tr><td>Checklist</td><td class="text-end">{{ pending_tasks.checklist }}</td></tr>
              <tr><td>Delegation</td><td class="text-end">{{ pending_tasks.delegation }}</td></tr>
              <tr><td>Help Ticket</td><td class="text-end">{{ pending_tasks.help_ticket }}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Type Switcher + Today Only toggle -->
  <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
    <div class="btn-group" role="group" aria-label="Task type">
      <a href="?task_type=checklist{% if today_only %}&today_only=1{% endif %}"
         class="btn btn-primary {% if not selected or selected == 'checklist' %}active{% endif %}">
        Checklist Tasks
      </a>
      <a href="?task_type=delegation{% if today_only %}&today_only=1{% endif %}"
         class="btn btn-primary {% if selected == 'delegation' %}active{% endif %}">
        Delegation Tasks
      </a>
      <a href="?task_type=help_ticket{% if today_only %}&today_only=1{% endif %}"
         class="btn btn-primary {% if selected == 'help_ticket' %}active{% endif %}">
        Help Ticket Tasks
      </a>
    </div>

    <div class="d-flex gap-2">
      <a href="?{% if selected %}task_type={{ selected }}&{% endif %}today_only=1"
         class="btn btn-outline-secondary {% if today_only %}active{% endif %}">
        Today Only
      </a>
      <a href="?{% if selected %}task_type={{ selected }}{% endif %}"
         class="btn btn-outline-secondary {% if not today_only %}active{% endif %}">
        Show All
      </a>
    </div>
  </div>

  {# Handed-over tasks card #}
  {% include "dashboard/partials/handed_over_tasks.html" with handed_over=handed_over card_title="Tasks handed over to you (active today)" %}

  <!-- Task Table -->
  <div class="card">
    <div class="card-header fw-bold">
      {% if not selected or selected == 'checklist' %}Checklist Tasks{% endif %}
      {% if selected == 'delegation' %}Delegation Tasks{% endif %}
      {% if selected == 'help_ticket' %}Help Ticket Tasks{% endif %}
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="width:70px">ID</th>
              <th style="min-width:220px">Task Name</th>
              <th>Message</th>
              <th style="min-width:200px">Planned Date</th>
              <th>Status</th>
              <th>Time/Task</th>
              <th>Actual Time</th>
              <th>Delay</th>
              <th style="min-width:160px">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if tasks %}
              {% for task in tasks %}
                <tr>
                  <td>{{ task.id }}</td>

                  <td>
                    {% if task.task_name %}{{ task.task_name }}{% else %}{{ task.title|default:"—" }}{% endif %}
                    {% if task.mode %}
                      <span class="badge bg-info ms-2">
                        {{ task.mode }}{% if task.frequency %} ({{ task.frequency }}){% endif %}
                      </span>
                    {% endif %}
                    {% if task.group_name %}
                      <span class="badge bg-secondary ms-1">{{ task.group_name }}</span>
                    {% endif %}
                    {% if task.is_handover %}
                      <span class="badge bg-dark ms-1">Handover</span>
                    {% endif %}
                  </td>

                  <td class="text-muted">
                    {% if task.message %}
                      {{ task.message|truncatechars:60 }}
                    {% elif task.description %}
                      {{ task.description|truncatechars:60 }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if task.planned_date %}
                      {{ task.planned_date|date:"d M, Y H:i" }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if selected == 'help_ticket' %}
                      {% if task.status == 'Open' %}
                        <span class="badge bg-primary">Open</span>
                      {% elif task.status == 'In Progress' %}
                        <span class="badge bg-warning text-dark">In&nbsp;Progress</span>
                      {% elif task.status == 'Closed' %}
                        <span class="badge bg-success">Closed</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ task.status|default:"—" }}</span>
                      {% endif %}
                    {% else %}
                      {% if task.status %}
                        {% if task.status == 'Pending' %}
                          <span class="badge bg-warning text-dark">Pending</span>
                        {% elif task.status == 'Completed' or task.status == 'Closed' %}
                          <span class="badge bg-success">
                            {% if task.status == 'Closed' %}Closed{% else %}Completed{% endif %}
                          </span>
                        {% else %}
                          <span class="badge bg-secondary">{{ task.status }}</span>
                        {% endif %}
                      {% else %}
                        <span class="badge bg-secondary">—</span>
                      {% endif %}
                    {% endif %}
                  </td>

                  <td>
                    {% if task.time_per_task_minutes %}
                      {{ task.time_per_task_minutes }} min
                    {% elif task.estimated_minutes %}
                      {{ task.estimated_minutes }} min
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if task.actual_duration_minutes %}
                      {{ task.actual_duration_minutes }} min
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if task.planned_date %}
                      {% if today_only %}
                        {{ task.planned_date|delay_since }}
                      {% else %}
                        {{ task.planned_date|delay_since:"signed" }}
                      {% endif %}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td class="text-nowrap">
                    <button type="button"
                            class="btn btn-outline-secondary btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#dashTaskDetails{{ task.id }}">
                      Details
                    </button>

                    {% if task.status == 'Pending' %}
                      {% if not selected or selected == 'checklist' %}
                        <a class="btn btn-success btn-sm"
                           href="{% url 'tasks:complete_checklist' task.id %}?next={{ request.get_full_path|urlencode }}">✔ Complete</a>
                      {% endif %}
                    {% endif %}

                    {% if selected == 'delegation' and task.status == 'Pending' %}
                      <a class="btn btn-success btn-sm"
                         href="{% url 'tasks:complete_delegation' task.id %}?next={{ request.get_full_path|urlencode }}">✔ Complete</a>
                    {% endif %}

                    {% if selected == 'help_ticket' and task.status != 'Closed' %}
                      <a class="btn btn-primary btn-sm"
                         href="{% url 'tasks:note_help_ticket' task.id %}?next={{ request.get_full_path|urlencode }}">Note</a>
                      <a class="btn btn-success btn-sm"
                         href="{% url 'tasks:close_help_ticket' task.id %}?next={{ request.get_full_path|urlencode }}">Close</a>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="9" class="text-center text-muted py-4">No tasks to show.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      {% if not selected or selected == 'checklist' %}
        <div class="px-3 py-2 text-muted small">
          Showing pending checklist tasks. Completed tasks are automatically hidden from this view.
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Details Modals -->
{% for task in tasks %}
<div class="modal fade" id="dashTaskDetails{{ task.id }}" tabindex="-1"
     aria-labelledby="dashTaskDetailsLabel{{ task.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dashTaskDetailsLabel{{ task.id }}">
          {% if not selected or selected == 'checklist' %}<i class="fas fa-clipboard-check"></i> Checklist
          {% elif selected == 'delegation' %}<i class="fas fa-people-arrows"></i> Delegation
          {% else %}<i class="fas fa-ticket-alt"></i> Help Ticket{% endif %}
          • ID {{ task.id }}
          {% if task.is_handover %}<span class="badge bg-dark ms-2">Handover</span>{% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        {% if not selected or selected == 'checklist' %}
          <div class="row g-3">
            <div class="col-md-6"><label class="fw-bold">Task Name:</label><p class="mb-0">{{ task.task_name }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Status:</label><p class="mb-0"><span class="badge bg-{% if task.status == 'Pending' %}warning{% else %}success{% endif %}">{{ task.status }}</span></p></div>
            <div class="col-md-6"><label class="fw-bold">Assigned By:</label><p class="mb-0">{{ task.assign_by.get_full_name|default:task.assign_by.username }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Assigned To:</label><p class="mb-0">{{ task.assign_to.get_full_name|default:task.assign_to.username }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Planned Date:</label><p class="mb-0">{{ task.planned_date|date:"d M, Y H:i" }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Priority:</label><p class="mb-0"><span class="badge bg-{% if task.priority == 'High' %}danger{% elif task.priority == 'Medium' %}warning{% else %}success{% endif %}">{{ task.priority|default:"Low" }}</span></p></div>
            <div class="col-md-6"><label class="fw-bold">Mode / Frequency:</label><p class="mb-0">{% if task.frequency %}{{ task.mode }} (Every {{ task.frequency }} {{ task.mode|lower }}{{ task.frequency|pluralize }}){% else %}{{ task.mode|default:"—" }}{% endif %}</p></div>
            <div class="col-md-6"><label class="fw-bold">Group:</label><p class="mb-0">{{ task.group_name|default:"—" }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Time/Task:</label><p class="mb-0">{{ task.time_per_task_minutes|default:0 }} min</p></div>
            <div class="col-md-6"><label class="fw-bold">Actual Time:</label><p class="mb-0">{% if task.actual_duration_minutes %}{{ task.actual_duration_minutes }} min{% else %}—{% endif %}</p></div>
            <div class="col-12"><label class="fw-bold">Message:</label><p class="mb-0">{{ task.message|default:"—" }}</p></div>
          </div>

        {% elif selected == 'delegation' %}
          <div class="row g-3">
            <div class="col-md-6"><label class="fw-bold">Task Title:</label><p class="mb-0">{{ task.task_name }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Status:</label><p class="mb-0"><span class="badge bg-{% if task.status == 'Pending' %}warning{% else %}success{% endif %}">{{ task.status }}</span></p></div>
            <div class="col-md-6"><label class="fw-bold">Assigned By:</label><p class="mb-0">{{ task.assign_by.get_full_name|default:task.assign_by.username }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Assigned To:</label><p class="mb-0">{{ task.assign_to.get_full_name|default:task.assign_to.username }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Planned Date:</label><p class="mb-0">{{ task.planned_date|date:"d M, Y H:i" }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Priority:</label><p class="mb-0"><span class="badge bg-{% if task.priority == 'High' %}danger{% elif task.priority == 'Medium' %}warning{% else %}success{% endif %}">{{ task.priority|default:"Low" }}</span></p></div>
            <div class="col-md-6"><label class="fw-bold">Time/Task:</label><p class="mb-0">{{ task.time_per_task_minutes|default:0 }} min</p></div>
            <div class="col-md-6"><label class="fw-bold">Actual Time:</label><p class="mb-0">{% if task.actual_duration_minutes %}{{ task.actual_duration_minutes }} min{% else %}—{% endif %}</p></div>
            <div class="col-12"><label class="fw-bold">Doer Notes:</label><p class="mb-0">{{ task.doer_notes|default:"—" }}</p></div>
            {% if task.audio_recording %}
              <div class="col-12">
                <label class="fw-bold">Audio:</label>
                <audio controls class="w-100">
                  <source src="{{ task.audio_recording.url }}" type="audio/mpeg">
                </audio>
              </div>
            {% endif %}
            {% if task.doer_file %}
              <div class="col-12">
                <a href="{{ task.doer_file.url }}" target="_blank" class="btn btn-sm btn-outline-success">
                  <i class="fas fa-download"></i> Download Completion File
                </a>
              </div>
            {% endif %}
          </div>

        {% else %}
          <div class="row g-3">
            <div class="col-md-6"><label class="fw-bold">Subject:</label><p class="mb-0">{{ task.title }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Status:</label>
              <p class="mb-0">
                {% if task.status == 'Open' %}
                  <span class="badge bg-primary">Open</span>
                {% elif task.status == 'In Progress' %}
                  <span class="badge bg-warning text-dark">In&nbsp;Progress</span>
                {% elif task.status == 'Closed' %}
                  <span class="badge bg-success">Closed</span>
                {% else %}
                  <span class="badge bg-secondary">{{ task.status|default:"—" }}</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-6"><label class="fw-bold">Assigned By:</label><p class="mb-0">{{ task.assign_by.get_full_name|default:task.assign_by.username }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Assigned To:</label><p class="mb-0">{{ task.assign_to.get_full_name|default:task.assign_to.username }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Created:</label><p class="mb-0">{{ task.created_at|date:"d M, Y H:i" }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Planned Date:</label><p class="mb-0">{{ task.planned_date|date:"d M, Y H:i" }}</p></div>
            <div class="col-md-6"><label class="fw-bold">Priority:</label><p class="mb-0"><span class="badge bg-{% if task.priority == 'High' %}danger{% elif task.priority == 'Medium' %}warning{% else %}success{% endif %}">{{ task.priority }}</span></p></div>
            <div class="col-md-6"><label class="fw-bold">Actual Duration:</label><p class="mb-0">{% if task.actual_duration_minutes %}{{ task.actual_duration_minutes }} min{% else %}—{% endif %}</p></div>
            <div class="col-12"><label class="fw-bold">Message:</label>
              <p class="mb-0">
                {% if task.description %}{{ task.description|linebreaks }}
                {% elif task.message %}{{ task.message|linebreaks }}
                {% else %}—{% endif %}
              </p>
            </div>
            {% if task.media_upload %}
              <div class="col-12">
                <a href="{{ task.media_upload.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-download"></i> Download Attachment
                </a>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <div class="modal-footer">
        {% if not selected or selected == 'checklist' %}
          {% if task.status == 'Pending' %}
            <a href="{% url 'tasks:complete_checklist' task.id %}?next={{ request.get_full_path|urlencode }}"
               class="btn btn-success"><i class="fas fa-check"></i> Complete</a>
          {% endif %}
        {% elif selected == 'delegation' %}
          {% if task.status == 'Pending' %}
            <a href="{% url 'tasks:complete_delegation' task.id %}?next={{ request.get_full_path|urlencode }}"
               class="btn btn-success"><i class="fas fa-check"></i> Complete</a>
          {% endif %}
        {% elif selected == 'help_ticket' %}
          {% if task.status != 'Closed' %}
            <a href="{% url 'tasks:note_help_ticket' task.id %}?next={{ request.get_full_path|urlencode }}"
               class="btn btn-primary"><i class="fas fa-sticky-note"></i> Add Note</a>
            <a href="{% url 'tasks:close_help_ticket' task.id %}?next={{ request.get_full_path|urlencode }}"
               class="btn btn-success"><i class="fas fa-check"></i> Close Ticket</a>
          {% endif %}
        {% endif %}
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>
{% endfor %}

{% endblock content %}
