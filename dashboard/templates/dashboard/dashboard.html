{% extends "base.html" %}
{% load static %}
{% load dashboard_extras %}

{# If your base template is not "base.html", change the extends path accordingly,
   e.g. "layouts/base.html" or "core/base.html". #}

{% block content %}

<div class="container-fluid py-3">

  <!-- Week Score + Pending Tasks -->
  <div class="row g-3">
    <div class="col-xl-6">
      <div class="card">
        <div class="card-header fw-bold">Week Score</div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <thead>
              <tr>
                <th style="width:40%"></th>
                <th class="text-center">Previous</th>
                <th class="text-center">Current</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Checklist</td>
                <td class="text-center">{{ week_score.checklist.previous }}</td>
                <td class="text-center">{{ week_score.checklist.current }}</td>
              </tr>
              <tr>
                <td>Delegation</td>
                <td class="text-center">{{ week_score.delegation.previous }}</td>
                <td class="text-center">{{ week_score.delegation.current }}</td>
              </tr>
              <tr>
                <td>Help Ticket</td>
                <td class="text-center">{{ week_score.help_ticket.previous }}</td>
                <td class="text-center">{{ week_score.help_ticket.current }}</td>
              </tr>
              <tr>
                <td>Time Spent</td>
                <td class="text-center">{{ prev_time }}</td>
                <td class="text-center">{{ curr_time }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-xl-6">
      <div class="card">
        <div class="card-header fw-bold">Pending Tasks</div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <tbody>
              <tr>
                <td>Checklist</td>
                <td class="text-end">{{ pending_tasks.checklist }}</td>
              </tr>
              <tr>
                <td>Delegation</td>
                <td class="text-end">{{ pending_tasks.delegation }}</td>
              </tr>
              <tr>
                <td>Help Ticket</td>
                <td class="text-end">{{ pending_tasks.help_ticket }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Type Switcher + Today Only toggle -->
  <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
    <div class="btn-group" role="group" aria-label="Task type">
      <a href="?task_type=checklist{% if today_only %}&today=1{% endif %}"
         class="btn btn-primary {% if not selected or selected == 'checklist' %}active{% endif %}">
        Checklist Tasks
      </a>
      <a href="?task_type=delegation{% if today_only %}&today=1{% endif %}"
         class="btn btn-primary {% if selected == 'delegation' %}active{% endif %}">
        Delegation Tasks
      </a>
      <a href="?task_type=help_ticket{% if today_only %}&today=1{% endif %}"
         class="btn btn-primary {% if selected == 'help_ticket' %}active{% endif %}">
        Help Ticket Tasks
      </a>
    </div>

    <div class="d-flex gap-2">
      <a href="?{% if selected %}task_type={{ selected }}&{% endif %}today=1"
         class="btn btn-outline-secondary {% if today_only %}active{% endif %}">
        Today Only
      </a>
      <a href="?{% if selected %}task_type={{ selected }}{% endif %}"
         class="btn btn-outline-secondary {% if not today_only %}active{% endif %}">
        Show All
      </a>
    </div>
  </div>

  <!-- Task Table -->
  <div class="card">
    <div class="card-header fw-bold">
      {% if not selected or selected == 'checklist' %}Checklist Tasks{% endif %}
      {% if selected == 'delegation' %}Delegation Tasks{% endif %}
      {% if selected == 'help_ticket' %}Help Ticket Tasks{% endif %}
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="width:70px">ID</th>
              <th style="min-width:220px">Task Name</th>
              <th>Message</th>
              <th style="min-width:200px">Planned Date</th>
              <th>Status</th>
              <th>Time/Task</th>
              <th>Actual Time</th>
              <th>Delay</th>
              <th style="min-width:160px">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if tasks %}
              {% for task in tasks %}
                <tr>
                  <td>{{ task.id }}</td>

                  <td>
                    {% if task.task_name %}{{ task.task_name }}{% else %}{{ task.title|default:"—" }}{% endif %}
                    {% if task.mode %}
                      <span class="badge bg-info ms-2">
                        {{ task.mode }}{% if task.frequency %} ({{ task.frequency }}){% endif %}
                      </span>
                    {% endif %}
                  </td>

                  <td class="text-muted">
                    {% if task.message %}
                      {{ task.message }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if task.planned_date %}
                      {{ task.planned_date|date:"d M, Y H:i" }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if task.status %}
                      {% if task.status == 'Pending' %}
                        <span class="badge bg-warning text-dark">Pending</span>
                      {% elif task.status == 'Completed' or task.status == 'Closed' %}
                        <span class="badge bg-success">Completed</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ task.status }}</span>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if task.time_per_task_minutes %}
                      {{ task.time_per_task_minutes }} min
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if task.actual_duration_minutes %}
                      {{ task.actual_duration_minutes }} min
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <!-- Delay: future -> 00:00, past -> HH:MM (IST) -->
                  <td>
                    {% if task.planned_date %}
                      {{ task.planned_date|delay_since }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if not selected or selected == 'checklist' %}
                      <a class="btn btn-outline-secondary btn-sm" href="{% url 'tasks:list_checklist' %}">Details</a>
                      <a class="btn btn-success btn-sm" href="{% url 'tasks:complete_checklist' task.id %}">✔ Complete</a>
                    {% elif selected == 'delegation' %}
                      <a class="btn btn-outline-secondary btn-sm" href="{% url 'tasks:list_delegation' %}">Details</a>
                      <a class="btn btn-success btn-sm" href="{% url 'tasks:complete_delegation' task.id %}">✔ Complete</a>
                    {% else %}
                      <a class="btn btn-outline-secondary btn-sm" href="{% url 'tasks:list_help_ticket' %}">Details</a>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="9" class="text-center text-muted py-4">
                  No tasks to show.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      {% if not selected or selected == 'checklist' %}
        <div class="px-3 py-2 text-muted small">
          Showing pending checklist tasks. Completed tasks are automatically hidden from this view.
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock content %}
